package com.sandu.search.controller;

import com.sandu.search.common.constant.IndexInfoQueryConfig;
import com.sandu.search.common.tools.JsonUtil;
import com.sandu.search.entity.elasticsearch.index.CategoryProductIndexMappingData;
import com.sandu.search.entity.elasticsearch.response.SearchObjectResponse;
import com.sandu.search.exception.ProductFullTextQueryException;
import com.sandu.search.service.product.ProductFullTextQueryService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;

/**
 * Copyright (c) http://www.sanduspace.cn. All rights reserved.
 *
 * @author :  Steve
 * @date : 2017/12/19
 * @since : sandu_yun_1.0
 */
@Slf4j
@RestController
@EnableAutoConfiguration
@RequestMapping("/product/fulltextquery")
public class ProductFullTextQueryController {

    private final static String CLASS_LOG_PREFIX = "产品信息:";

    @Autowired
    private ProductFullTextQueryService productFullTextQueryService;

    /**
     * 根据产品名搜索产品列表
     *
     * @param text 产品名
     * @return
     */
    @RequestMapping("/{text}")
    List<CategoryProductIndexMappingData> productByText(@PathVariable String text) {

        SearchObjectResponse searchObjectResponse;
        log.info(CLASS_LOG_PREFIX + "根据全文搜索产品列表:ProductName:{}.", text);
        try {
            searchObjectResponse = productFullTextQueryService.queryProductListByText(text, IndexInfoQueryConfig.DEFAULT_SEARCH_DATA_SIZE);
        } catch (ProductFullTextQueryException e) {
            log.error(CLASS_LOG_PREFIX + "根据全文搜索产品列表失败! text:{}.", e);
            return null;
        }
        log.info(CLASS_LOG_PREFIX + "根据全文搜索产品列表完成!List<CategoryProductIndexMappingData>:{}.", JsonUtil.toJson(searchObjectResponse));

        if (null == searchObjectResponse) {
            log.warn(CLASS_LOG_PREFIX + "根据全文搜索产品列表完成!SearchObjectResponse is null,text:{}.", text);
            return null;
        }

        return (List<CategoryProductIndexMappingData>) searchObjectResponse.getHitResult();
    }

}
