package com.sandu.search.service.product.impl;

import com.sandu.search.common.constant.*;
import com.sandu.search.common.tools.JsonUtil;
import com.sandu.search.common.tools.StringUtil;
import com.sandu.search.entity.common.PageVo;
import com.sandu.search.entity.elasticsearch.dco.MultiMatchField;
import com.sandu.search.entity.elasticsearch.dco.ValueOffset;
import com.sandu.search.entity.elasticsearch.dco.ValueRange;
import com.sandu.search.entity.elasticsearch.index.CategoryProductIndexMappingData;
import com.sandu.search.entity.elasticsearch.response.SearchObjectResponse;
import com.sandu.search.entity.elasticsearch.search.ShouldMatchSearch;
import com.sandu.search.entity.elasticsearch.search.product.ProductSearchAggregationVo;
import com.sandu.search.entity.elasticsearch.search.product.ProductSearchMatchVo;
import com.sandu.search.exception.ElasticSearchException;
import com.sandu.search.exception.ProductSearchException;
import com.sandu.search.service.elasticsearch.ElasticSearchService;
import com.sandu.search.service.product.ProductSearchService;
import lombok.extern.slf4j.Slf4j;
import org.elasticsearch.common.lucene.search.function.FieldValueFactorFunction;
import org.elasticsearch.common.unit.Fuzziness;
import org.elasticsearch.index.query.*;
import org.elasticsearch.index.query.functionscore.FieldValueFactorFunctionBuilder;
import org.elasticsearch.index.query.functionscore.FunctionScoreQueryBuilder;
import org.elasticsearch.index.query.functionscore.ScoreFunctionBuilders;
import org.elasticsearch.search.aggregations.AggregationBuilder;
import org.elasticsearch.search.aggregations.AggregationBuilders;
import org.elasticsearch.search.aggregations.bucket.terms.TermsAggregationBuilder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.*;
import java.util.stream.Collectors;

import static java.util.stream.Collectors.toList;

/**
 * 产品搜索服务
 *
 * @date 20180103
 * @auth pengxuangang
 */
@Slf4j
@Service("productSearchService")
public class ProductSearchServiceImpl implements ProductSearchService {

    private final static String CLASS_LOG_PREFIX = "产品搜索服务:";

    @Autowired
    private ElasticSearchService elasticSearchService;

    @Override
    public SearchObjectResponse searchProduct(ProductSearchMatchVo productSearchMatchVo, List<ProductSearchAggregationVo> productSearchAggregationVoList, PageVo pageVo) throws ProductSearchException {

        if (null == productSearchMatchVo || null == pageVo) {
            log.warn(CLASS_LOG_PREFIX + "通过条件搜索产品失败，必需参数为空.");
            throw new ProductSearchException(CLASS_LOG_PREFIX + "通过条件搜索产品失败，必需参数为空.");
        }

        /********************************* Step 1: 组装搜索条件 *************************************************/

        //匹配条件List
        List<QueryBuilder> matchQueryList = new ArrayList<>();
        //非匹配条件List
        List<QueryBuilder> noMatchQueryList = new ArrayList<>(1);
        //或匹配条件List
        List<ShouldMatchSearch> shouldMatchSearchList = new ArrayList<>();
        //聚合条件
        List<AggregationBuilder> aggregationBuilderList = new ArrayList<>(null == productSearchAggregationVoList ? 0 : productSearchAggregationVoList.size());

        //组合查询条件--产品名
        if (!StringUtils.isEmpty(productSearchMatchVo.getProductName())) {
            matchQueryList.add(QueryBuilders.matchQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_NAME, productSearchMatchVo.getProductName()));
        }

        //组合查询条件--白模全铺长度
        RangeQueryBuilder fullPaveLengthRangeQueryBuilder = null;
        ValueOffset valueOffset = productSearchMatchVo.getFullPaveLengthValueOffset();
        if (null != valueOffset) {
            //长度左界限
            int leftOffset = 0;
            //长度右界限
            int rightOffset = 0;
            //白膜全铺长度值
            int fullPaveLength = valueOffset.getFullPaveLength();
            //偏移量
            int fullPaveOffsetValue = valueOffset.getFullPaveOffsetValue();
            switch (valueOffset.getFullPaveOffsetType()) {
                //正常偏移(左右偏移)
                case ValueOffset.NORMAL_FULL_PAVE_OFFSET_TYPE:
                    leftOffset = fullPaveLength - fullPaveOffsetValue;
                    rightOffset = fullPaveLength + fullPaveOffsetValue;
                    break;
                //左偏移
                case ValueOffset.LEFT_FULL_PAVE_OFFSET_TYPE:
                    leftOffset = fullPaveLength - fullPaveOffsetValue;
                    rightOffset = fullPaveLength;
                    break;
                //右偏移
                case ValueOffset.RIGHT_FULL_PAVE_OFFSET_TYPE:
                    rightOffset = fullPaveLength + fullPaveOffsetValue;
                    leftOffset = fullPaveLength;
                    break;
                //不偏移(指代一个具体值,如:5<=x<=5)
                case ValueOffset.NO_FULL_PAVE_OFFSET_TYPE:
                    rightOffset = fullPaveLength;
                    leftOffset = fullPaveLength;
                    break;
            }

            //组装条件
            fullPaveLengthRangeQueryBuilder = QueryBuilders.rangeQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_LENGTH);
            fullPaveLengthRangeQueryBuilder.gte(leftOffset);
            fullPaveLengthRangeQueryBuilder.lte(rightOffset);
        }

        //组合查询条件--产品大类
        Integer productTypeValue = productSearchMatchVo.getProductTypeValue();
        if (!StringUtils.isEmpty(productTypeValue)) {
            QueryBuilder matchProductTypeValueQueryBuilder = QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_TYPE_VALUE, productTypeValue);
            matchQueryList.add(matchProductTypeValueQueryBuilder);
        }

        //组合查询条件--公司产品可见范围小类ID列表和产品小类
        /**************************** 公司产品可见范围小类ID列表和产品小类 start ***************************/
        //结构图
        /**
         * bool(productSmallTypeBoolQueryBuilder)
         *   |
         *   |---should
         *   |      |
         *   |      |---bool(companyBoolQueryBuilder)
         *   |             |---should
         *   |             |      |
         *   |             |      |---bool(fullpaveBoolQueryBuilder)
         *   |             |            |
         *   |             |            |---terms(brand)
         *   |             |            |---terms(product small type)
         *   |             |            |---terms(full pave length)
         *   |             |
         *   |             |---should
         *   |                    |
         *   |                    |---bool(brandBoolQueryBuilder)
         *   |                         |
         *   |                         |---terms(brand)
         *   |                         |---terms(product small type)
         *   |---should
         *          |
         *          |---bool(normalBoolQueryBuilder)
         *                 |---should
         *                 |      |
         *                 |      |---bool(fullpaveBoolQueryBuilder)
         *                 |           |---terms(full pave length)
         *                 |           |---terms(product small type)
         *                 |
         *                 |---should
         *                        |
         *                        |---terms(product small type)
         */

        //小类
        List<Integer> productSmallTypeValueList = productSearchMatchVo.getProductTypeSmallValueList();
        //产品小类bool查询
        BoolQueryBuilder productSmallTypeBoolQueryBuilder = QueryBuilders.boolQuery();

        /********************** 1.公司可见产品小类品牌过滤 **********************/
        //产品可见范围小类ID列表
        List<Integer> companyProductVisibilityRangeIdList = productSearchMatchVo.getCompanyProductVisibilityRangeIdList();
        //公司可见范围的小类(因为可见范围的小类要单独处理-经过品牌过滤)
        List<Integer> productSmallTypeVisibilityRangeList = (null == companyProductVisibilityRangeIdList || 0 >= companyProductVisibilityRangeIdList.size()) ?
                                                    null : productSmallTypeValueList.stream().filter(item -> companyProductVisibilityRangeIdList.contains(item)).collect(toList());
        //除公司可见范围之外的小类(因为可见范围的小类要单独处理-经过品牌过滤)
        List<Integer> nowProductSmallTypeList = (null == productSmallTypeVisibilityRangeList || 0 >= productSmallTypeVisibilityRangeList.size()) ?
                                                    productSmallTypeValueList : productSmallTypeValueList.stream().filter(item -> !productSmallTypeVisibilityRangeList.contains(item)).collect(toList());

        //公司可见范围bool查询
        BoolQueryBuilder companyBoolQueryBuilder = QueryBuilders.boolQuery();
        //普通bool查询
        BoolQueryBuilder normalBoolQueryBuilder = QueryBuilders.boolQuery();

        //公司可见范围内小类
        //公司品牌列表
        List<Integer> companyBrandIdList = productSearchMatchVo.getCompanyBrandIdList();
        if (null != productSmallTypeVisibilityRangeList && 0 < productSmallTypeVisibilityRangeList.size()) {
            if (null == companyBrandIdList || 0 >= companyBrandIdList.size()) {
                //将可见范围内的小类交回范围外(不处理)
                nowProductSmallTypeList.addAll(productSmallTypeVisibilityRangeList);
            } else {
                //品牌
                TermsQueryBuilder brandTermsQueryBuilder = QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_BRAND_ID, companyBrandIdList);

                //品牌+小类bool查询
                BoolQueryBuilder brandBoolQueryBuilder = QueryBuilders.boolQuery();

                //定制衣柜-定制浴室柜-定制镜小类需要增加白膜全铺长度过滤，其他的不用
                //包含特殊处理白膜的小类ID列表
                List<Integer> includeProductSmallFullPraveIdList = productSmallTypeVisibilityRangeList.stream().filter(productSmallTypeValue ->
                        (ProductTypeValue.PRODUCT_TYPE_VALUE_CABINET == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CLOTHES_CABINET == productSmallTypeValue)
                                || (ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CABINET_BATHROOM == productSmallTypeValue)
                                || (ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_MIRROR_BATHROOM == productSmallTypeValue)
                ).collect(Collectors.toList());
                //排除特殊处理白膜的小类ID列表(将大小类组合成:'大类-小类'的形式再来比较就可以仅对比一次出结果)
                List<Integer> excludeProductSmallFullPraveIdList = productSmallTypeVisibilityRangeList.stream().filter(productSmallTypeValue ->
                        !(ProductTypeValue.PRODUCT_TYPE_VALUE_CABINET + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CLOTHES_CABINET).equals(productTypeValue + "-" + productSmallTypeValue)
                                &&!(ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CABINET_BATHROOM).equals(productTypeValue + "-" + productSmallTypeValue)
                                &&!(ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_MIRROR_BATHROOM).equals(productTypeValue + "-" + productSmallTypeValue)
                ).collect(Collectors.toList());

                //包含全铺长度的小类
                if (null != fullPaveLengthRangeQueryBuilder && null != includeProductSmallFullPraveIdList && 0 < includeProductSmallFullPraveIdList.size()) {
                    //全铺长度+品牌+小类bool查询
                    BoolQueryBuilder fullpaveBoolQueryBuilder = QueryBuilders.boolQuery();
                    //品牌
                    fullpaveBoolQueryBuilder.must(brandTermsQueryBuilder);
                    //小类
                    fullpaveBoolQueryBuilder.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, includeProductSmallFullPraveIdList));
                    //全铺长度
                    fullpaveBoolQueryBuilder.must(fullPaveLengthRangeQueryBuilder);

                    //加入公司bool查询条件
                    companyBoolQueryBuilder.should(fullpaveBoolQueryBuilder);
                }

                //不包含全铺长度的小类
                if (null != excludeProductSmallFullPraveIdList && 0 < excludeProductSmallFullPraveIdList.size()) {
                    //品牌
                    brandBoolQueryBuilder.must(brandTermsQueryBuilder);
                    //小类
                    brandBoolQueryBuilder.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, excludeProductSmallFullPraveIdList));

                    //加入公司bool查询条件
                    companyBoolQueryBuilder.should(brandBoolQueryBuilder);
                }
            }
        }

        //公司可见范围外小类
        if (null != nowProductSmallTypeList && 0 < nowProductSmallTypeList.size()) {
            //定制衣柜-定制浴室柜-定制镜小类需要增加白膜全铺长度过滤，其他的不用
            //包含特殊处理白膜的小类ID列表
            List<Integer> includeProductSmallFullPraveIdList = nowProductSmallTypeList.stream().filter(productSmallTypeValue ->
                    (ProductTypeValue.PRODUCT_TYPE_VALUE_CABINET == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CLOTHES_CABINET == productSmallTypeValue)
                            || (ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CABINET_BATHROOM == productSmallTypeValue)
                            || (ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM == productTypeValue && ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_MIRROR_BATHROOM == productSmallTypeValue)
            ).collect(Collectors.toList());
            //排除特殊处理白膜的小类ID列表(将大小类组合成:'大类-小类'的形式再来比较就可以仅对比一次出结果)
            List<Integer> excludeProductSmallFullPraveIdList = nowProductSmallTypeList.stream().filter(productSmallTypeValue ->
                    !(ProductTypeValue.PRODUCT_TYPE_VALUE_CABINET + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CLOTHES_CABINET).equals(productTypeValue + "-" + productSmallTypeValue)
                            &&!(ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_CABINET_BATHROOM).equals(productTypeValue + "-" + productSmallTypeValue)
                            &&!(ProductTypeValue.PRODUCT_TYPE_VALUE_BATHROOM + "-" + ProductSmallTypeValue.PRODUCT_SMALL_TYPE_VALUE_DIY_MIRROR_BATHROOM).equals(productTypeValue + "-" + productSmallTypeValue)
            ).collect(Collectors.toList());

            //有白膜条件需要分开处理
            if (null != fullPaveLengthRangeQueryBuilder) {
                //有需要特殊处理的小类
                if (null != includeProductSmallFullPraveIdList && 0 < includeProductSmallFullPraveIdList.size()) {
                    //全铺长度+小类查询
                    BoolQueryBuilder fullpaveBoolQueryBuilder = QueryBuilders.boolQuery();
                    //小类
                    fullpaveBoolQueryBuilder.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, includeProductSmallFullPraveIdList));
                    //全铺长度
                    fullpaveBoolQueryBuilder.must(fullPaveLengthRangeQueryBuilder);
                    //加入普通bool查询条件
                    normalBoolQueryBuilder.should(fullpaveBoolQueryBuilder);

                    //小类
                    TermsQueryBuilder productSmallTypeTermsQueryBuilder = QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, excludeProductSmallFullPraveIdList);
                    //加入普通bool查询条件
                    normalBoolQueryBuilder.should(productSmallTypeTermsQueryBuilder);
                } else {
                    //没有需要特殊处理的小类
                    //全铺长度+小类查询
                    BoolQueryBuilder fullpaveBoolQueryBuilder = QueryBuilders.boolQuery();
                    //小类
                    fullpaveBoolQueryBuilder.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, excludeProductSmallFullPraveIdList));
                    //全铺长度
                    fullpaveBoolQueryBuilder.must(fullPaveLengthRangeQueryBuilder);
                    //加入普通bool查询条件
                    normalBoolQueryBuilder.should(fullpaveBoolQueryBuilder);
                }
            } else {
                //没有白膜条件直接全部一起处理
                //合并所有小类
                List<Integer> allProductSmallType = new ArrayList<>();
                allProductSmallType.addAll(excludeProductSmallFullPraveIdList);
                allProductSmallType.addAll(includeProductSmallFullPraveIdList);
                TermsQueryBuilder productSmallTypeTermsQueryBuilder = QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, allProductSmallType);
                //加入普通bool查询条件
                normalBoolQueryBuilder.should(productSmallTypeTermsQueryBuilder);
            }
        }

        //产品小类条件聚合
        if (companyBoolQueryBuilder.should().size() > 0) {
            productSmallTypeBoolQueryBuilder.should(companyBoolQueryBuilder);
        }
        if (normalBoolQueryBuilder.should().size() > 0) {
            productSmallTypeBoolQueryBuilder.should(normalBoolQueryBuilder);
        }
        matchQueryList.add(productSmallTypeBoolQueryBuilder);

        /**************************** 公司产品可见范围小类ID列表和产品小类 end ***************************/

        //没有大小类，没有编码，但有厂商品牌过滤则进行大小类排除过滤(对应U3D：搜全部按钮---此操作性能消耗稍大)
        Map<Integer, List<Integer>> companyAliveTypeMap = productSearchMatchVo.getCompanyAliveTypeMap();
        if ((null == productTypeValue || 0 == productTypeValue)
                && (null == productSmallTypeValueList || 0 >= productSmallTypeValueList.size())
                && (null != companyAliveTypeMap && 0 < companyAliveTypeMap.size())) {
            /**
             * bool(companyAliveBool)
             *    should
             *          bool(nowbool)
             *              terms(productType)
             *              terms(productSmallType)
             *              terms(brand)
             *          bool(nowbool)
             *              terms(productType)
             *              terms(productSmallType)
             *
             */
            /**************** 分离成2部分数据(1.被品牌过滤的大小类,2.不被品牌过滤的大小类) ***************/
            Map<Integer, List<Integer>> normalTypeMap = new HashMap<>();

            //2.不被品牌过滤的大小类(遍历数据，假定大小类值范围为60)
            for (int i = 1; i <= 60; i++) {
                //正常产品小类列表(初始化60个小类)
                List<Integer> normalProductSmallList = new ArrayList<>(60);
                for (int j = 1; j <= 60; j++) {
                    normalProductSmallList.add(j);
                }

                //去掉小类列表中要被过滤的
                if (companyAliveTypeMap.containsKey(i)) {
                    //要做过滤的大类
                    List<Integer> companyProductSmallValueList = companyAliveTypeMap.get(i);
                    //去重
                    normalProductSmallList = normalProductSmallList.stream().filter(item -> !companyProductSmallValueList.contains(item)).collect(toList());
                }

                normalTypeMap.put(i, normalProductSmallList);
            }

            //公司有效分类bool
            BoolQueryBuilder companyAliveBool = QueryBuilders.boolQuery();
            /**************** 第一部分:要过滤品牌的 *******************/
            for (Map.Entry<Integer, List<Integer>> entries : companyAliveTypeMap.entrySet()) {
                //当前bool
                BoolQueryBuilder nowBool = QueryBuilders.boolQuery();

                //产品大类
                Integer nowProductTypeValue = entries.getKey();
                nowBool.must(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_TYPE_VALUE, nowProductTypeValue));

                //产品小类
                List<Integer> nowProductSmallTypeValueList = entries.getValue();
                nowBool.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, nowProductSmallTypeValueList));

                //品牌
                nowBool.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_BRAND_ID, companyBrandIdList));

                //合并条件
                companyAliveBool.should(nowBool);
            }

            /**************** 第二部分:不过滤的 *******************/
            for (Map.Entry<Integer, List<Integer>> entries : normalTypeMap.entrySet()) {
                //当前bool
                BoolQueryBuilder nowBool = QueryBuilders.boolQuery();

                //产品大类
                Integer nowProductTypeValue = entries.getKey();
                nowBool.must(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_TYPE_VALUE, nowProductTypeValue));

                //产品小类
                List<Integer> nowProductSmallTypeValueList = entries.getValue();
                nowBool.must(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, nowProductSmallTypeValueList));

                //合并条件
                companyAliveBool.should(nowBool);
            }

            //合并数据
            matchQueryList.add(companyAliveBool);
        }

        //组合查询条件--产品分类ID列表
        List<Integer> productCategoryIdList = productSearchMatchVo.getProductCategoryIdList();
        if (null != productCategoryIdList && 0 < productCategoryIdList.size()) {
            TermsQueryBuilder termsProductCategoryCodeQueryBuilder = QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_ALLCATEGORYID, productCategoryIdList);
            matchQueryList.add(termsProductCategoryCodeQueryBuilder);
        }

        //组合查询条件--二级分类ID
        int secondLevelCategoryId = productSearchMatchVo.getSecondLevelCategoryId();
        if (0 != secondLevelCategoryId) {
            QueryBuilder matchProductCategoryQueryBuilder = QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SECONDLEVEL_CATEGORID, secondLevelCategoryId);
            matchQueryList.add(matchProductCategoryQueryBuilder);
        }

        //组合查询条件--三级分类ID
        int thirdLevelCategoryId = productSearchMatchVo.getThirdLevelCategoryId();
        if (0 != thirdLevelCategoryId) {
            QueryBuilder matchProductCategoryQueryBuilder = QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_THIRDLEVEL_CATEGORYID, thirdLevelCategoryId);
            matchQueryList.add(matchProductCategoryQueryBuilder);
        }

        //组合查询条件--产品品牌ID列表
        List<Integer> brandIdList = productSearchMatchVo.getBrandIdList();
        if (null != brandIdList && 0 < brandIdList.size()) {
            matchQueryList.add(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_BRAND_ID, brandIdList));
        }

        //组合查询条件--产品发布状态
        matchQueryList.add(QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PUTAWAY_STATUS, productSearchMatchVo.getPutawayStatusList()));

        //组合查询条件--产品分类长编码
        List<String> productCategoryLongCodeList = productSearchMatchVo.getProductCategoryLongCodeList();
        if (null != productCategoryLongCodeList && 0 < productCategoryLongCodeList.size()) {
            //是否是五级分类查询
            boolean isFiveLevelCategoryList = true;
            for (String productCategoryLongCode : productCategoryLongCodeList) {
                //长编码列表中均为五级分类才是五级分类查询
                //五级分类长编码中点会出现7次
                if (7 != StringUtil.appearNumber(productCategoryLongCode, ".")) {
                    isFiveLevelCategoryList = false;
                    break;
                }
            }

            //五级分类中所有条件为MUST
            if (isFiveLevelCategoryList) {
                //组装bool查询(结构图)
                /**
                 * bool
                 *   |
                 *   |---must---terms(productCategoryLongCode)
                 *   |
                 *   |---must---terms(productCategoryLongCode)
                 *   .
                 */
                BoolQueryBuilder categoryBoolQueryBuilder = QueryBuilders.boolQuery();
                productCategoryLongCodeList.forEach(productCategoryLongCode -> {
                    categoryBoolQueryBuilder.must(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_CATEGORY_LONG_CODE_LIST, productCategoryLongCode));
                });
                matchQueryList.add(categoryBoolQueryBuilder);
            } else {
                //其余查询条件为SHOULD
                TermsQueryBuilder termsQueryBuilder = QueryBuilders.termsQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_CATEGORY_LONG_CODE_LIST, productCategoryLongCodeList);
                matchQueryList.add(termsQueryBuilder);
            }
        }

        //组合查询条件--单值匹配多字段--List中第一个字段优先级最高
        List<MultiMatchField> multiMatchFieldList = productSearchMatchVo.getMultiMatchFieldList();
        if (null != multiMatchFieldList && 0 < multiMatchFieldList.size()) {
            //遍历条件
            multiMatchFieldList.forEach(multiMatchField -> {
                //匹配字段
                List<String> matchFieldList = multiMatchField.getMatchFieldList();

                //设置查询条件
                MultiMatchQueryBuilder multiMatchQueryBuilder = QueryBuilders.multiMatchQuery(multiMatchField.getSearchKeyword(), matchFieldList.toArray(new String[matchFieldList.size()]));
                //设置字段优先级
                for (int i = 0; i < matchFieldList.size(); i++) {
                    //字段名
                    String filedName = matchFieldList.get(i);
                    //权重
                    float boost = (matchFieldList.size() - i);
                    //产品编码由于是强匹配,防止其他分值大于产品编码.故上调为5倍权重
                    if (QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_CODE.equals(filedName)) {
                        boost = boost * 10;
                    }
                    multiMatchQueryBuilder.field(filedName, boost);
                }
                //加入查询
                matchQueryList.add(multiMatchQueryBuilder);
            });
        }

        //组合查询条件--高度
        ValueRange productHeightValueRange = productSearchMatchVo.getProductHeightValueRange();
        if (null != productHeightValueRange) {
            //范围查询条件
            RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_HEIGHT);
            //范围类型
            switch (productHeightValueRange.getRangeType()) {
                //前匹配
                case ValueRange.RANGE_TYPE_ONLY_START_EQUAL:
                    rangeQueryBuilder.gte(productHeightValueRange.getStartValue());
                    rangeQueryBuilder.lt(productHeightValueRange.getEndValue());
                    break;
                //后匹配
                case ValueRange.RANGE_TYPE_ONLY_END_EQUAL:
                    rangeQueryBuilder.gt(productHeightValueRange.getStartValue());
                    rangeQueryBuilder.lte(productHeightValueRange.getEndValue());
                    break;
                //都不匹配
                case ValueRange.RANGE_TYPE_START_AND_END_NO_EQUAL:
                    rangeQueryBuilder.gt(productHeightValueRange.getStartValue());
                    rangeQueryBuilder.lt(productHeightValueRange.getEndValue());
                    break;
                //都匹配
                case ValueRange.RANGE_TYPE_ALL_EQUAL:
                    rangeQueryBuilder.gte(productHeightValueRange.getStartValue());
                    rangeQueryBuilder.lte(productHeightValueRange.getEndValue());
                    break;
                default:
                    log.warn(CLASS_LOG_PREFIX + "组合查询条件--高度---不支持的范围类型:{}.", productHeightValueRange.getRangeType());
            }
            matchQueryList.add(rangeQueryBuilder);
        }

        //组合查询条件--平台编码
        String platformCode = productSearchMatchVo.getPlatformCode();
        if (!StringUtils.isEmpty(platformCode)) {
            matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_CODE_LIST, platformCode));

            //非内部用户-检查产品平台状态必须为已发布
            if (!productSearchMatchVo.isInnerUser()) {
                switch (platformCode) {
                    //2B-移动端
                    case PlatformConstant.PLATFORM_CODE_TOB_MOBILE:
                        matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_TOB_MOBILE_PUTAWAT_STATUS
                                + "." +
                                QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_PUTAWAT_STATUS,
                                1
                        ));
                        break;
                    //2B-PC
                    case PlatformConstant.PLATFORM_CODE_TOB_PC:
                        matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_TOB_PC_PUTAWAT_STATUS
                                        + "." +
                                        QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_PUTAWAT_STATUS,
                                1
                        ));
                        break;
                    //品牌2C-网站
                    case PlatformConstant.PLATFORM_CODE_TOC_SITE:
                        matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_TOC_SITE_PUTAWAT_STATUS
                                        + "." +
                                        QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_PUTAWAT_STATUS,
                                1
                        ));
                        break;
                    //2C-移动端
                    case PlatformConstant.PLATFORM_CODE_TOC_MOBILE:
                        matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_TOC_MOBILE_PUTAWAT_STATUS
                                        + "." +
                                        QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_PLATFORM_PUTAWAT_STATUS,
                                1
                        ));
                        break;
                }
            }
        }

        //组合查询条件--产品属性--匹配度计分排序
        Map<String, String> productFilterAttributeMap = productSearchMatchVo.getProductFilterAttributeMap();
        if (null != productFilterAttributeMap && 0 < productFilterAttributeMap.size()) {
            for (Map.Entry<String, String> entries : productFilterAttributeMap.entrySet()) {
                matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_ATTRIBUTE_TYPE_FILTER_MAP + "." + entries.getKey(), entries.getValue()));
            }
        }

        //组合查询条件--产品属性--产品使用数排序
        Integer userId = productSearchMatchVo.getUserId();
        if (null != userId && 0 < userId) {
            //自定义计算分值
            FieldValueFactorFunctionBuilder fieldValueFactorFunctionBuilder = ScoreFunctionBuilders.fieldValueFactorFunction(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_USAGE_COUNT + "." + userId);
            fieldValueFactorFunctionBuilder.modifier(FieldValueFactorFunction.Modifier.LOG1P);
            fieldValueFactorFunctionBuilder.factor(1.1f);
            fieldValueFactorFunctionBuilder.missing(0);
            //分值计算查询
            FunctionScoreQueryBuilder functionScoreQueryBuilder = QueryBuilders.functionScoreQuery(fieldValueFactorFunctionBuilder);
            //加入查询
            matchQueryList.add(functionScoreQueryBuilder);
        }

        //组合查询条件--产品属性--排序
        Map<String, String> productOrderAttributeMap = productSearchMatchVo.getProductOrderAttributeMap();
        if (null != productOrderAttributeMap && 0 < productOrderAttributeMap.size()) {
            for (Map.Entry<String, String> entries : productOrderAttributeMap.entrySet()) {
                TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_ATTRIBUTE_TYPE_ORDER_MAP + "." + entries.getKey(), entries.getValue());
                //最小匹配数为0-表示不强制匹配
                shouldMatchSearchList.add(new ShouldMatchSearch(termQueryBuilder, 0));
            }
        }

        //组合查询条件--产品当前小类优先
        Integer nowProductTypeSmallValue = productSearchMatchVo.getNowProductTypeSmallValue();
        if (null != nowProductTypeSmallValue && 0 < nowProductTypeSmallValue) {
            TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_SMALL_TYPE_VALUE, nowProductTypeSmallValue);
            //增加权重
            termQueryBuilder.boost(2.0f);
            shouldMatchSearchList.add(new ShouldMatchSearch(termQueryBuilder, 0));
        }


        //排除查询条件--是否包含白膜产品
        if (!productSearchMatchVo.isIncludeWhiteMembraneProduct()) {
            noMatchQueryList.add(QueryBuilders.prefixQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_CODE, "baimo_"));
        }

        //产品必须未被删除
        matchQueryList.add(QueryBuilders.termQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_IS_DELETE, "0"));

        /********************************* Step 2: 组装聚合条件 *************************************************/
        if (null != productSearchAggregationVoList && 0 < productSearchAggregationVoList.size()) {
            productSearchAggregationVoList.forEach(productSearchAggregation -> {
                TermsAggregationBuilder termsAggregationBuilder = AggregationBuilders.terms(productSearchAggregation.getAggregationName());
                termsAggregationBuilder.field(productSearchAggregation.getAggregationFieldName());
                termsAggregationBuilder.size(productSearchAggregation.getAggregationSize());
                aggregationBuilderList.add(termsAggregationBuilder);
            });
        }


        /********************************* Step 3: 搜索数据 *************************************************/
        //搜索数据
        SearchObjectResponse searchObjectResponse;

        log.info(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表:ProductSearchMatchVo:{},ProductSearchAggregationVoList:{}", productSearchMatchVo.toString(), JsonUtil.toJson(productSearchAggregationVoList));
        try {
            searchObjectResponse = elasticSearchService.productCategorySearch(matchQueryList, noMatchQueryList, shouldMatchSearchList, aggregationBuilderList, pageVo.getStart(), pageVo.getPageSize());
        } catch (ElasticSearchException e) {
            log.error(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表失败! ElasticSearchException:{}.", e);
            throw new ProductSearchException(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表失败! ElasticSearchException:{}.", e);
        }
        log.info(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表成功!SearchObjectResponse:{}.", searchObjectResponse.getHitTotal());

        if (null == searchObjectResponse || null == searchObjectResponse.getHitResult()) {
            log.info(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表失败,查询结果为空。ProductSearchMatchVo:{}.", productSearchMatchVo.toString());
            throw new ProductSearchException(CLASS_LOG_PREFIX + "通过条件搜索产品-根据产品名或产品品牌搜索产品列表失败,查询结果为空。ProductSearchMatchVo:" + productSearchMatchVo.toString());
        }

        return searchObjectResponse;
    }

    @Override
    public CategoryProductIndexMappingData searchProductById(Integer productId) throws ProductSearchException {

        if (null == productId || 0 > productId) {
            return null;
        }

        //构造查询体
        QueryBuilder matchQueryBuilder = QueryBuilders.matchQuery(QueryConditionField.QUERY_CONDITION_FIELD_PRODUCT_ID, productId);

        //查询数据
        SearchObjectResponse searchObjectResponse;
        try {
            searchObjectResponse = elasticSearchService.productCategorySearch(Arrays.asList(matchQueryBuilder), IndexInfoQueryConfig.DEFAULT_SEARCH_DATA_START, 1);
        } catch (ElasticSearchException e) {
            log.error(CLASS_LOG_PREFIX + "通过产品ID查询产品失败，QueryBuilder:{}, ElasticSearchException:{}.", matchQueryBuilder.toString(), e);
            throw new ProductSearchException(CLASS_LOG_PREFIX + "通过产品ID查询产品失败，QueryBuilder:" + matchQueryBuilder.toString() + ", ElasticSearchException:" + e);
        }

        if (null != searchObjectResponse) {
            List<CategoryProductIndexMappingData> categoryProductIndexMappingDataList = (List<CategoryProductIndexMappingData>) searchObjectResponse.getHitResult();
            if (null != categoryProductIndexMappingDataList && 0 < categoryProductIndexMappingDataList.size()) {
                return categoryProductIndexMappingDataList.get(0);
            }
        }

        return null;
    }
}
