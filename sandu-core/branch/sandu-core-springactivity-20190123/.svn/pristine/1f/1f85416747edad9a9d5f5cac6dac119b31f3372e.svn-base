package com.sandu.web.springFestivalActivity;

import com.sandu.api.base.common.ResponseEnvelope;
import com.sandu.api.springFestivalActivity.input.GetUserTaskBo;
import com.sandu.api.springFestivalActivity.input.UserInviteRecordBo;
import com.sandu.api.springFestivalActivity.output.CardPageVo;
import com.sandu.api.springFestivalActivity.output.FilmTicketVo;
import com.sandu.api.user.model.SysUser;
import com.sandu.api.springFestivalActivity.output.GiveMeFiveVo;
import com.sandu.api.springFestivalActivity.service.biz.FilmTicketActivityService;
import com.sandu.api.user.service.SysUserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@Slf4j
@RequestMapping("/v1/core/filmTicketActivity")
public class FilmTicketActivityController {
    private static final String CLASS_LOG_PREFIX = "[春节活动-电影票]";
    @Autowired
    private FilmTicketActivityService filmTicketActivityService;
    @Autowired
    private SysUserService sysUserService;

    @GetMapping("/redPoint")
    public ResponseEnvelope getRedPointFlag(@RequestParam("activityId") Long activityId, SysUser sysUser) {
        return new ResponseEnvelope(true, filmTicketActivityService.getRedPointFlag(sysUser.getId(), activityId));
    }

    @PostMapping("/giveMeFive")
    public ResponseEnvelope giveMeFive(Long inviteUserId, Long activityId, Integer isLoginBefore, SysUser sysUser) {
        SysUser inviteUser = sysUserService.get(inviteUserId.intValue());
        GiveMeFiveVo res = filmTicketActivityService.giveMeFive(sysUser.getId(), inviteUser, activityId, isLoginBefore);
        if (res == null) {
            return new ResponseEnvelope(false, "助力失败");
        }
        return new ResponseEnvelope(res.getSuccess(), res.getMessage());
    }

    @GetMapping("/getInviteRecord")
    public ResponseEnvelope getInviteRecord(Long activityId, Integer pageNo, Integer pageSize, SysUser sysUser) {
        UserInviteRecordBo bo = new UserInviteRecordBo(sysUser.getId(), activityId, pageNo, pageSize);
        Integer count = filmTicketActivityService.getInviteRecordCount(bo);
        if (count == null || count == 0) {
            return new ResponseEnvelope(false, "无邀请记录");
        }
        return new ResponseEnvelope(true, count, filmTicketActivityService.getInviteRecord(bo));
    }

    @GetMapping("/getUserTaskState")
    public ResponseEnvelope getUserTaskState(Long activityId, SysUser sysUser) {
        return new ResponseEnvelope(true, filmTicketActivityService.getUserTaskState(sysUser, activityId));
    }

    @PostMapping("/doTask")
    public ResponseEnvelope doTask(@RequestBody GetUserTaskBo bo, SysUser sysUser) {
        bo.setUserId(sysUser.getId());
        boolean flag = filmTicketActivityService.doTask(bo);
        return new ResponseEnvelope(flag, flag ? "领取任务成功" : "领取任务失败");
    }

    @PostMapping("/doneTask")
    public ResponseEnvelope doneTask(Long activityId, Byte businessType, SysUser sysUser) {
        boolean flag = filmTicketActivityService.doneTask(sysUser.getId(), activityId, businessType);
        return new ResponseEnvelope(flag, flag ? "完成任务成功" : "完成任务失败");
    }

    @GetMapping("/cards")
    public ResponseEnvelope getCardPage(Long activityId, SysUser sysUser) {
        CardPageVo vo = filmTicketActivityService.getCardPageVo(sysUser, activityId);
        return new ResponseEnvelope(vo == null ? false : true, vo);
    }

    @GetMapping("/getFilmTicket")
    public ResponseEnvelope getFilmTicket(Long activityId, SysUser sysUser) {
        FilmTicketVo ticket = filmTicketActivityService.getFilmTicket(sysUser, activityId);
        return new ResponseEnvelope(ticket == null ? false : true, true);
    }

    @PostMapping("/increaseLotteryRate")
    public ResponseEnvelope increaseLotteryRate(Long activityId, SysUser sysUser) {
        Integer i = filmTicketActivityService.increaseLotteryRate(sysUser.getId(), activityId);
        return new ResponseEnvelope(i != null, i);
    }

    @PostMapping("/bindingMobile")
    public ResponseEnvelope bindingMobile(String phone, String code, Long activityId, SysUser sysUser) {
        boolean flag = filmTicketActivityService.checkPermission(phone, code);
        if (flag) {
            sysUser.setMobile(phone);
            int i = sysUserService.update(sysUser);
            if (i <= 0) {
                return new ResponseEnvelope(false, "绑定手机号失败");
            }
            filmTicketActivityService.doneTask(sysUser.getId(), activityId, new Byte("0"));
            return new ResponseEnvelope(true, "绑定手机号成功");
        }
        return new ResponseEnvelope(false, "验证码错误");
    }
}
