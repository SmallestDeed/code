package com.sandu.web.springFestivalActivity;

import com.sandu.api.base.common.LoginUser;
import com.sandu.api.base.common.ResponseEnvelope;
import com.sandu.api.springFestivalActivity.output.SignInVo;
import com.sandu.api.springFestivalActivity.output.UserSignInRecordVo;
import com.sandu.api.springFestivalActivity.service.WxSigninSummaryService;
import com.sandu.api.springFestivalActivity.service.WxUserSigninService;
import com.sandu.common.LoginContext;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.CollectionUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;


/**
 * @ClassName: UserSignInRecordController
 * @auther: gaoj
 * @Date: 2019/1/19 15:28
 * @Description:
 * @Version 1.0
 */
@RestController
@Slf4j
@RequestMapping("/v1/core/userSignInRecord")
public class UserSignInRecordController {

    private static final String CLASS_LOG_PREFIX = "【签到记录controller】";
    @Autowired
    private WxUserSigninService wxUserSigninService;
    @Autowired
    private WxSigninSummaryService wxSigninSummaryService;

    @RequestMapping("/getUserSignInRecordList")
    public ResponseEnvelope getUserSignInRecordList(@RequestParam Long activityId) {
        if (null == activityId || 0L == activityId) {
            return new ResponseEnvelope(false, "活动Id为空");
        }
        log.info(CLASS_LOG_PREFIX + "获取签到记录列表,activityId={}", activityId);

        LoginUser loginUser = LoginContext.getLoginUser(LoginUser.class);
        if (null == loginUser) {
            return new ResponseEnvelope(false, "请登录");
        }
        log.info(CLASS_LOG_PREFIX + "获取签到记录列表,userId={}", loginUser.getId());

        List<UserSignInRecordVo> userSignInRecordVoList;
        try {
            userSignInRecordVoList = wxUserSigninService.getUserSignInRecordList(activityId, loginUser.getId());
        } catch (Exception e) {
            log.error(CLASS_LOG_PREFIX + "获取签到记录列表 userId={}，exception={}", loginUser.getId(), e);
            return new ResponseEnvelope(false, e.getMessage());
        }

        if (CollectionUtils.isEmpty(userSignInRecordVoList)) {
            return new ResponseEnvelope(false, "获取签到记录异常,数据为空");
        }

        return new ResponseEnvelope(true, userSignInRecordVoList.size(), userSignInRecordVoList);
    }

    @RequestMapping("/signIn")
    public ResponseEnvelope signIn(@RequestParam Long activityId) {
        LoginUser loginUser = LoginContext.getLoginUser(LoginUser.class);
        if (null == loginUser) {
            return new ResponseEnvelope(false, "请登录");
        }
        if (null == activityId || 0 >= activityId) {
            return new ResponseEnvelope(false, "活动参数为空");
        }
        log.info(CLASS_LOG_PREFIX + "签到，activityId={},userId={}", activityId, loginUser.getId());

        SignInVo signInVo;
        try {
            signInVo = wxUserSigninService.signIn(activityId, loginUser);
        } catch (Exception e) {
            log.error(CLASS_LOG_PREFIX + "签到异常，exception={}", e);
            return new ResponseEnvelope(false, e.getMessage());
        }

        if (null != signInVo) {
            return new ResponseEnvelope(true, "签到成功", signInVo);
        }
        return new ResponseEnvelope(false, "签到失败");
    }
}
