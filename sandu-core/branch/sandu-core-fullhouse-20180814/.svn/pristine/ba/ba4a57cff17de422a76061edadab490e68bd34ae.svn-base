package com.sandu.service.designplan.impl;

import com.google.gson.Gson;
import com.sandu.api.base.common.LoginUser;
import com.sandu.api.base.common.ResponseEnvelope;
import com.sandu.api.base.common.constant.CompanyTypeEnum;
import com.sandu.api.base.model.BaseCompany;
import com.sandu.api.designplan.common.constants.DesignPlanConstants;
import com.sandu.api.designplan.input.PlanRecommendedQuery;
import com.sandu.api.designplan.model.DesignPlanRecommended;
import com.sandu.api.designplan.model.DesignPlanSummaryInfo;
import com.sandu.api.designplan.model.ResRenderPic;
import com.sandu.api.designplan.output.DesignPlanRecommendedVo;
import com.sandu.api.designplan.service.DesignPlanLikeService;
import com.sandu.api.designplan.service.DesignPlanRecommendedService;
import com.sandu.api.designplan.service.ResRenderPicService;
import com.sandu.service.designplan.dao.DesignPlanRecommendedDao;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

/**
 * Created by kono on 2018/6/2 0002.
 */
@Service("designPlanRecommendedService")
public class DesignPlanRecommendedServiceImpl implements DesignPlanRecommendedService {

    //Json转换类
    private final static Gson GSON = new Gson();
    private final static String CLASS_LOG_PREFIX = "[方案推荐服务]:";
    private static Logger logger = LoggerFactory.getLogger(DesignPlanRecommendedServiceImpl.class);

    @Autowired
    private DesignPlanRecommendedDao designPlanRecommendedDao;
    @Autowired
    private ResRenderPicService resRenderPicService;
    @Autowired
    private DesignPlanLikeService designPlanLikeService;

    @Override
    public ResponseEnvelope getPlanRecommendedList2(PlanRecommendedQuery query, String companyCode, BaseCompany baseCompany) {
        if (null == query) {
            return new ResponseEnvelope(false, "获取方案推荐列表数据失败,PlanRecommendedQuery is null!");
        }
        LoginUser loginUser = query.getLoginUser();
        // 设置查询条件对象
        DesignPlanRecommended designPlanRecommended = setModelQuery(query, baseCompany, companyCode, loginUser);


        // 查询列表
        List<DesignPlanRecommendedVo> list = null;
        Integer total = this.getPlanRecommendedCount(designPlanRecommended);
        if (total != null && total.intValue() > 0) {
            list = this.getPlanRecommendedList(designPlanRecommended);
            List <Integer> recommendedIds = new ArrayList <Integer>();
            for (DesignPlanRecommendedVo result : list) {
                recommendedIds.add(result.getPlanRecommendedId());
            }
            List<ResRenderPic> resPicList = resRenderPicService.getResRenderPicListByRecommendedIds(recommendedIds);
            for (DesignPlanRecommendedVo result : list) {
                for(ResRenderPic res : resPicList){
                    if(res!=null && res.getPlanRecommendedId().intValue() == result.getPlanRecommendedId().intValue()){
                        result.setResRenderPicPath(res.getPicPath());
                    }
                }
                //从缓存中获取方案点赞收藏数量信息、
                //从缓存中获取用户对方案是否点赞，是否收藏
                DesignPlanSummaryInfo summaryInfo =
                        designPlanLikeService.getPlanInfoOfCache(loginUser.getId(), result.getPlanRecommendedId());
                if (null != summaryInfo) {
                    if (null != summaryInfo.getLikeNum()) {
                        result.setLikeNum(summaryInfo.getLikeNum());
                    }
                    if (null != summaryInfo.getCollectNum()) {
                        result.setCollectNum(summaryInfo.getCollectNum());
                    }
                    if (null != summaryInfo.getIsLike()) {
                        result.setIsLike(summaryInfo.getIsLike());
                    }
                    if (null != summaryInfo.getIsFavorite()) {
                        result.setIsFavorite(summaryInfo.getIsFavorite());
                    }
                }
            }
        }
        logger.info(CLASS_LOG_PREFIX + "获取方案推荐列表数据完成:total:{}, list:{}.", total, GSON.toJson(list));
        return new ResponseEnvelope(true, total==null ? 0 : total, list);
    }

    /**
     * 方案推荐总条数
     *
     * @return
     */
    @Override
    public Integer getPlanRecommendedCount(DesignPlanRecommended designPlanRecommended) {
        if (designPlanRecommended == null) {
            return 0;
        }
		/*是方案管理员 必须要传空间类型*/
        if ("yes".equals(designPlanRecommended.getCheckAdministrator())) {
            if (designPlanRecommended.getSpaceFunctionIds() == null || designPlanRecommended.getSpaceFunctionIds().size() <= 0) {
                return 0;
            }
		/*非方案管理员 必须要传品牌id*/
        }
        return designPlanRecommendedDao.getPlanRecommendedCount(designPlanRecommended);
    }

    /**
     * 方案推荐数据
     *
     * @return
     */
    @Override
    public List<DesignPlanRecommendedVo> getPlanRecommendedList(DesignPlanRecommended designPlanRecommended) {
        if (designPlanRecommended == null) {
            return null;
        }
        /*是方案管理员 必须要传空间类型*/
        if ("yes".equals(designPlanRecommended.getCheckAdministrator())) {
            if (designPlanRecommended.getSpaceFunctionIds() == null || designPlanRecommended.getSpaceFunctionIds().size() <= 0) {
                return null;
            }
        }
        return designPlanRecommendedDao.getPlanRecommendedList(designPlanRecommended);
    }

    @Override
    public Integer recommendedPlanCount(PlanRecommendedQuery query, String companyCode, BaseCompany baseCompany) {
        if (null == query) {
            return 0;
        }
        LoginUser loginUser = query.getLoginUser();
        // 设置查询条件对象
        DesignPlanRecommended designPlanRecommended = setModelQuery(query, baseCompany, companyCode, loginUser);

        return this.getPlanRecommendedCount(designPlanRecommended);
    }

    /**
     * 转换查询条件对象
     * @param query
     * @return
     */
    private DesignPlanRecommended setModelQuery(PlanRecommendedQuery query, BaseCompany baseCompany, String companyCode, LoginUser loginUser) {
        DesignPlanRecommended designPlanRecommended = new DesignPlanRecommended();
        String houseType = query.getSpaceType();
        String livingName = query.getLivingName();
        String areaValue = query.getSpaceArea();
        String designRecommendedStyleId = query.getDesignPlanStyleId();
        String displayType = query.getDisplayType();
        String creator = query.getCreator();//搜索条件：创建者
        String brandName = query.getBrandName();//搜索条件：品牌
        Integer limit = query.getLimit();
        Integer start = query.getStart();
        Integer isSortByReleaseTime = query.getIsSortByReleaseTime();
        Integer isSortByRenderCount = query.getIsSortByRenderCount();
        Integer companyId = query.getCompanyId();
        Integer designerId = query.getDesignerId();
        List<Integer> companyIds = new ArrayList<>();
        if (baseCompany != null ) {
            companyId = baseCompany.getId();
            if (CompanyTypeEnum.MANUFACTURER.getValue().equals(baseCompany.getBusinessType())) {
                companyIds.add(baseCompany.getId());
            } else if (CompanyTypeEnum.FRANCHISER.getValue().equals(baseCompany.getBusinessType())) {
                companyIds.add(baseCompany.getPid());
                companyId = baseCompany.getPid();
            } else {
                companyIds.add(baseCompany.getId());
                companyIds.add(2501);//先写死后续服务回调用其他服务
            }
        }
        designPlanRecommended.setCompanyIds(companyIds);
        designPlanRecommended.setCompanyId(companyId);

        /* 查询 */
        designPlanRecommended.setDisplayType(displayType);
        if (DesignPlanConstants.FUNCTION_TYPE_DECORATE.equals(displayType)) {/* 1代表祝列表。其他代表一键装修处的小列表。小列表只能查询支持一件装修的数据 */
            designPlanRecommended.setRecommendedType(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_RELEASEING);
        }
        if (DesignPlanConstants.FUNCTION_TYPE_DRAGDECORATE.equals(displayType)) {
            //运营网站用户仅能看到已发布推荐方案
            designPlanRecommended.setRecommendedType(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_RELEASEING);
        }
        if (DesignPlanConstants.FUNCTION_TYPE_TEST.equals(displayType)) {
            designPlanRecommended.setRecommendedType(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_TEST_RELEASE);
        }
        if (DesignPlanConstants.FUNCTION_TYPE_CHECK.equals(displayType)) {
//            designPlanRecommended.setRecommendedType(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
//            designPlanRecommended.setIsRelease(RecommendedDecorateState.WAITING_CHECK_RELEASE);
//            /*判断用户是什么类型管理员*/
//            List<Integer> spaceFunctionIds = null;
//            spaceFunctionIds = this.designPlanRecommendedCheckType(loginUser.getId());
//            if (spaceFunctionIds == null || spaceFunctionIds.size() <= 0) {
//                return new ResponseEnvelope(false, "无权限！");
//            }
//            designPlanRecommended.setSpaceFunctionIds(spaceFunctionIds);
//            designPlanRecommended.setCheckAdministrator("yes");/*是方案审核管理员*/
        }
        if (DesignPlanConstants.FUNCTION_TYPE_PUBLIC.equals(displayType) || StringUtils.isEmpty(displayType)) {
            designPlanRecommended.setRecommendedType(DesignPlanConstants.RECOMMENDED_TYPE_SHARE);
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_OPEN);
        }
        if (DesignPlanConstants.FUNCTION_TYPE_MOBILE.equals(displayType)) {
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_OPEN);
        }
        // 支持查询一键方案和样板间方案
        if (DesignPlanConstants.FUNCTION_TYPE_SUPPORTBOTH.equals(displayType)) {
            List<Integer> types = new ArrayList<>();
            types.add(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
            types.add(DesignPlanConstants.RECOMMENDED_TYPE_SHARE);
            designPlanRecommended.setRecommendedTypes(types);
            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_RELEASEING);
        }
        //根据时间排序
        if(null!=isSortByReleaseTime&&null==isSortByRenderCount) {
            designPlanRecommended.setIsSortByReleaseTime(isSortByReleaseTime);
        }
        //根据渲染次数排序
        if(null==isSortByReleaseTime&&null!=isSortByRenderCount) {
            designPlanRecommended.setIsSortByRenderCount(isSortByRenderCount);
        }
        //根据平台过滤
        if(query.getPlatformId()!=null&&query.getPlatformId()>0) {
            designPlanRecommended.setPlatformId(query.getPlatformId());
        }

        if (StringUtils.isNotEmpty(brandName)) { /*品牌名*/
            designPlanRecommended.setBrandName(brandName.trim());
        }
        if (StringUtils.isNotEmpty(creator)) { /*创建者*/
            designPlanRecommended.setCreator(creator.trim());
        }
        if (StringUtils.isNotEmpty(houseType) && (!"null".equals(houseType))) { /*空间功能类型 */
            designPlanRecommended.setSpaceFunctionId(Integer.parseInt(houseType));
        }
        if (StringUtils.isNotEmpty(areaValue)) {
            designPlanRecommended.setAreaValue(areaValue);
        }
        if (StringUtils.isNotEmpty(livingName)) { /* 小区名称 */
            designPlanRecommended.setLivingName(livingName);
        }
        if (StringUtils.isNotEmpty(designRecommendedStyleId)) { /* 推荐方案风格 */
            designPlanRecommended.setDesignRecommendedStyleId(Integer.parseInt(designRecommendedStyleId));
        }

        //空间形状
        if (null != query.getSpaceShape()) { /* 小区名称 */
            designPlanRecommended.setSpaceShape(query.getSpaceShape());
        }

        if (limit != null) {
            designPlanRecommended.setLimit(limit);
        }
        if (start != null) {
            designPlanRecommended.setStart(start);
        }
        designPlanRecommended.setUserId(loginUser.getId());
        // 设置设计师Id
        designPlanRecommended.setDesignPlanId(designerId);

        /*公司为三度云享家展示平台所有已发布的一键方案+公开方案*/
//        if(companyCode.equals(baseCompany.getCompanyCode())){
//            designPlanRecommended.setBrandIds(null);
//            designPlanRecommended.setCompanyId(null);
//            designPlanRecommended.setPlatformId(null);
//            designPlanRecommended.setRecommendedType(null);
//            List<Integer> types = new ArrayList<>();
//            types.add(DesignPlanConstants.RECOMMENDED_TYPE_DECORATE);
//            types.add(DesignPlanConstants.RECOMMENDED_TYPE_SHARE);
//            designPlanRecommended.setRecommendedTypes(types);
//            designPlanRecommended.setIsRelease(DesignPlanConstants.IS_RELEASEING);
//        }

        return designPlanRecommended;
    }

    /**
     * created by zhangchengda
     * 2018/8/17 14:57
     * 通过主键查询推荐方案
     * @param id 主键
     * @return 返回推荐方案
     */
    @Override
    public DesignPlanRecommended selectByPrimaryKey(Integer id) {
        return designPlanRecommendedDao.selectByPrimaryKey(id);
    }
}
