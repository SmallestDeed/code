// pages/goods-details/goods-details.js
let  fetch = getApp().fetch, myForEach = getApp().myForEach
import { renderTypeExample } from '../../component/render-type/render-type'
import { emptyTemplate } from '../../component/emptyTemplate/emptyTemplate'
let $App = getApp()
var { shareTitle } = require('../../utils/config.js');
const WxParse = require('../../utils/wxParse/wxParse.js');
var shareTitle = { shareTitle }.shareTitle;
let flagTitle = (shareTitle == '诺克照明');
let optionsId = '';
Page({
  renderTypeExample,
  emptyTemplate,
  /**
   * 页面的初始数据
   */
  data: {
    //swiper配置
    autoplay: false,
    interval: 1000,
    duration: 200,
    favoriteRequest:true,
    collectRequest:true,
    prodetailsObj:{},
    resourcePath: getApp().resourcePath,
    sevenUrl: getApp().sevenUrl,
    imageArray: ['https://homesiteres.zbjimg.com/homesite%2Fres%2F300X250.jpg%2Forigine%2F4ef2b90d-f4a3-4589-abef-ce2104fa65ea', 'https://homesiteres.zbjimg.com/homesite%2Fres%2F300X250.jpg%2Forigine%2F4ef2b90d-f4a3-4589-abef-ce2104fa65ea'],
    textActive: 0 ,
    purchaseNumber: 1, // 用户要购买的数量
    specificationListShow: false, // 规格列表的展示
    confirmOrFooter: true,
    isCarOrBuy: 'buy', // 识别加入购物车或者购买
    goodDetailsHeight: '', // 大盒子样式
    goodDetailsOverflow: 'none', // 大盒子样式
    detailName:"",
    planNum:0,
    carCount: 0,
    curPage: 1,
    pageSize: 20,
    toatlCount: 0,
    productId:'',
    flagTitle: flagTitle,
    bflist: [],
    goodsType: [], //商品规格列表
    // 选择规格信息
    chooseText: '',//已选择样式
    attrValueId: [],//选择类型的id
    basegoodsSku: '',
    spuid:'',
    couponList:[],
    optionsId: ''
  },
  unreceive:function(){
    wx.showToast({
      title: '已领取过',
      icon: 'none',
      duration: 800
    })
  },
  receive: function(e){
    let url = '/v1/sandu/mini/activity/receive';
    let that = this;
    let data = {
      userId: wx.getStorageSync("userId"),
      couponId: e.currentTarget.dataset.id,
    }
    fetch(url, 'get', data, 'shop').then((res) => {
      if (res.code==200) {
        wx.showToast({
          title: res.message,
          icon: 'success',
        })
        that.getGoodsDetails(optionsId)
      } else if (res.code == 10000102){
        wx.showToast({
          title: res.message,
          icon: 'none'
        })
      }
    })
  },
  getActivity: function (id, free){
    let url = '/product/baseCompany/getCompanyId';
    let url2 = 'v1/sandu/mini/activity/getGoodsCouponList';
    let that = this;
    fetch(url, 'get').then((res) => {
      if (res.obj) {
        let data = {
          userId: wx.getStorageSync("userId"),
          companyId: res.obj,
          productId:id,
          totalFree: free
        }
        fetch(url2, 'get', data,'shop').then((e) => {
          let list = [];
          let maxL = e.data.length > 10 ? 10 : e.data.length;
          for (let i = 0; i < maxL;i++){
            list[i] = e.data[i];
          }
          this.setData({
            couponList: list,
          })
        })
      }
    })
    
  },
  
  showImg:function(e){
    let src = e.currentTarget.dataset.url;
    if (src =='image/goods_pic_no.png'||!src){
      wx.showToast({
        title: '暂无图片预览',
        icon: 'none'
      })
      return;
    }
    wx.previewImage({
      current: src, 
      urls: this.data.prodetailsObj.smallPiclist 
    })
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    let optionsId = options.id;
    this.data.optionsId = optionsId
    new this.renderTypeExample() // 注册组件
    new this.emptyTemplate() // 注册组件
    new $App.quickNavigation() // 注册组件
    this.getGoodsDetails(optionsId)
    this.getPurchasecarNumber() // 初始化购物车数量    
    this.setData({
      carCount: getApp().data.carCount, // 加入购物车数量
      productId: optionsId
    })
    this.setData({
      prodetailsObj:{
        id: optionsId
      }
    })
    
    this.specificationsInfo(optionsId)//获取规格信息
    
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
  
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
      let pages = getCurrentPages();
      this.getPurchasecarNumber() // 刷新购物车数量
      this.getRecommendPlan(this.data.optionsId) // 获取方案
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
  
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
  
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
  
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function (res) {
    if (res.from === 'menu') {
      return $App.shareAppMessageFn(true,'?id=' + optionsId);
    }
  },
  // switchGoodsAndCase(e) { // 商品及案例的切換
  //   this.setData({
  //     textActive: e.target.dataset.index,
  //     specificationListShow:false
  //   })
  // },
  formToThreeD(e) { // 720
    let type = e.detail.target.dataset.type, item = e.detail.target.dataset.item, routerQueryType = '',
      formId = e.detail.formId
    if (type === '720' || type === 'roam') {
      let routerQueryType = ''
      if (type === '720') {
        routerQueryType = 'seven'
      } else {
        routerQueryType = 'roam'
      }
      let sevenObj = {
        token: wx.getStorageSync('token'),
        platformCode: 'brand2c',
        operationSource: 1,
        planId: item.designPlanRecommendId,
        routerQueryType: routerQueryType,
        customReferer: $App.wxUrl,
        platformNewCode: 'miniProgram',
        formId: formId
      }
      let webUrl = this.data.sevenUrl
      for (let key in sevenObj) {
        webUrl += key + '=' + sevenObj[key] + '&'
      }
      getApp().data.webUrl = webUrl
      console.log(webUrl)
      $App.myNavigateBack('pages/web-720/web-720')
      return
    }
  },
  toThreeD(e) { // 调转到3D界面
    let url = `/mobile/designPlanRecommended/getRecommendedPictureList.htm`,
      item = e.currentTarget.dataset.item,
      type = e.currentTarget.dataset.type
    fetch(url, 'post', {
      planRecommendedId: item.designPlanRecommendId,
      remark: type
    }, 'render')
      .then(res => {
        let ret = res.success ? (type == 'photo' ? res.datalist[0].pid : res.datalist[0].id):false;
        return ret;
      })
      .then(res => {
        if (res) {
          let url = `/mobile/design/designPlan/getPanoPicture.htm`
          fetch(url, 'post', {
            thumbId: res
          }, 'render')
            .then(res => {
              if (res.success) {
                type == 'photo' ? this.enlargeImage(res.obj.url) : this.toVideo(res.obj.url)
              } else {
                wx.showToast({
                  title: '打开失败',
                  icon: 'none'
                })
              }
            })
        }
      })
  },
  enlargeImage(url) { // 查看大图
    wx.previewImage({
      current: url, // 当前显示图片的http链接
      urls: [url] // 需要预览的图片http链接列表
    })
  },
  toVideo(url) {
    wx.navigateTo({
      url: '../video/video?url=' + url
    })
  },
  changePurchaseNumber(e) { // 增加购买数量
    if (e.target.dataset.index === 0) {
      if (this.data.purchaseNumber === 1) {
        return
      }
      this.setData({
        purchaseNumber: this.data.purchaseNumber - 1
      })
    } else {
      if (this.data.purchaseNumber < this.data.basegoodsSku.inventory) {
        this.setData({
          purchaseNumber: this.data.purchaseNumber + 1
        })
      } else {
        wx.showToast({
          title: '已达上限',
          icon: 'none',
          duration: 2000
        })
      }

    }
  },
  purchaseImmediately() { // ；立即购买
    if (this.data.specificationListShow) {
      this.setData({
        goodDetailsheight: '',
        goodDetailsOverflow: 'none',
        specificationListShow: false,
        confirmOrFooter: true
      })
      this.data.basegoodsSku.purchaseNumber = this.data.purchaseNumber
      return;
      wx.navigateTo({
        url: '../confirm-order/confirm-order?item=' + JSON.stringify(this.data.basegoodsSku)
        // url: '../confirm-order/confirm-order?item=' + JSON.stringify(this.data.prodetailsObj)
      })
      return
    }
    let goodListheight = wx.getSystemInfoSync().windowHeight
    this.setData({
      goodDetailsheight: goodListheight + 'px',
      goodDetailsOverflow: 'hidden',
      confirmOrFooter: false,
      specificationListShow: true,
      isCarOrBuy: 'buy'
    })
  },
  joinPurchaseCar() { // 加入购物车
    if (this.data.specificationListShow) {
      let url = `/cart/add.htm`
      fetch(url, 'post', {
        productId: this.data.basegoodsSku.productId,
        productNumber: this.data.purchaseNumber,
        productPrice: this.data.basegoodsSku.price,
        productCode: this.data.prodetailsObj.productCode,
        productName: this.data.basegoodsSku.productName,
        productStyleName: this.data.prodetailsObj.productStyleName,
        productColorName: this.data.prodetailsObj.productColorName,
        productPicPath: this.data.basegoodsSku.productPicPath
      })
        .then(res => {
          if (res.status) {
            this.data.carCount += this.data.purchaseNumber
            this.setData({
              carCount: this.data.carCount
            })
            wx.showToast({
              title: '加入成功',
              icon: 'success',
              duration: 2000
            })
          } else {
            wx.showToast({
              title: '加入失败',
              icon: 'none',
              duration: 2000
            })
          }
        })
        .catch(res => {
          wx.showToast({
            title: '加入失败',
            icon: 'none',
            duration: 2000
          })
        })
      return
    }
    let goodListheight = wx.getSystemInfoSync().windowHeight
    this.setData({
      confirmOrFooter: false,
      specificationListShow: true,
      isCarOrBuy: 'car',
      goodDetailsheight: goodListheight + 'px',
      goodDetailsOverflow: 'hidden'
    })

  },
  specificationsInfo(id) {
    let url = `/goods/basegoods/attr`;
    fetch(url, 'get', {
      id: id
    }).then(res => {
      if (res.status) {
        this.setData({
          goodsType: res.obj.attr
        })
        let chooseText = [];
        res.obj.attr.map(item => {
          chooseText = [...chooseText, ...item.attrValue.filter(item1 => {
            return item1.isSelected == 1
          })]
        })
        let total = [];//选择样式拼接
        let attrValueIds = [];//选择样式id拼接
        chooseText.map(item => {
          total.push(item.attrValueName)
          attrValueIds.push(item.attrValueId)
        })
        this.setData({
          chooseText: total.join(','),
          attrValueId: attrValueIds
        })
        this.goodsSpecifications(attrValueIds.join(','));
      }
    })
  },
  choseSpecifications() { // 选择规格
    let goodListheight = wx.getSystemInfoSync().windowHeight

    this.setData({
      goodDetailsheight: goodListheight + 'px',
      goodDetailsOverflow: 'hidden',
      specificationListShow: true,
      confirmOrFooter: true
    })

  },
  goodsSpecifications(attrValueIds) { //选择规格类型
    let url = `/goods/basegoods/sku`;
    fetch(url, 'get', {
      spuId: this.data.prodetailsObj.id,
      attrValueIds: attrValueIds
    }).then(res => {
      if (res.status) {
        this.setData({

        })
        this.setData({
          ['prodetailsObj.productName']: res.obj.productName,
          ['prodetailsObj.price']: res.obj.price,
          ['prodetailsObj.salePrice']: res.obj.salePrice,
          chooseText: res.obj.attribute,
          basegoodsSku: res.obj
        })
      }
    })
  },
  chooseGoodsType(e) {
    //切换类型
    this.data.goodsType.map(res => {
      res.attrValue.map(item => {
        res.attrId == e.target.dataset.item.attrId ? item.isSelected = 0 : ''
      })
    })
    this.data.goodsType[e.target.dataset.index].attrValue[e.target.dataset.number].isSelected = 1;//选择当前的类型 
    this.data.attrValueId[e.target.dataset.index] = e.target.dataset.items.attrValueId;//替换id
    this.setData({
      goodsType: this.data.goodsType,
      attrValueId: this.data.attrValueId
    })
    this.goodsSpecifications(this.data.attrValueId.join(','))
  },
  closeSpecificationsTable() { // 关闭规格
    this.setData({
      goodDetailsheight: '',
      goodDetailsOverflow: 'none',
      specificationListShow: false,
      confirmOrFooter: true
    })
  },

  purchaseConfirm() { // 确定购买或者加入购物车
    if (this.data.isCarOrBuy === 'car') {
      let url = `/cart/add.htm`
      fetch(url, 'post', {
        productId: this.data.basegoodsSku.productId,
        productNumber: this.data.purchaseNumber,
        productPrice: this.data.basegoodsSku.price,
        productCode: this.data.prodetailsObj.productCode,
        productName: this.data.basegoodsSku.productName,
        productStyleName: this.data.prodetailsObj.productStyleName,
        productColorName: this.data.prodetailsObj.productColorName,
        productPicPath: this.data.basegoodsSku.productPicPath
      })
        .then(res => {
          if (res.status) {
            wx.showToast({
              title: '加入购物车成功',
              icon: 'success',
              duration: 2000
            })
            this.data.carCount += this.data.purchaseNumber
            this.setData({
              carCount: this.data.carCount
            })
          } else {
            wx.showToast({
              title: '加入购物车失败',
              icon: 'none',
              duration: 2000
            })
          }
        })
        .catch(res => {
        })
    } else if (this.data.isCarOrBuy === 'buy') {
      this.data.basegoodsSku.purchaseNumber = this.data.purchaseNumber
      let basegoodsSku = JSON.stringify(this.data.basegoodsSku)
      basegoodsSku = this.myReplaceReg(basegoodsSku, '$')
      wx.navigateTo({
        url: '../confirm-order/confirm-order?item=' + basegoodsSku
      })
    }
    this.setData({
      specificationListShow: false,
      confirmOrFooter: true,
      goodDetailsheight: '',
      goodDetailsOverflow: 'none'
    })
  },
  myReplaceReg(str, replaceStr) {
    let reg = new RegExp('&', 'g')
    return str.replace(reg, replaceStr)
  },
  toPurchasecar() { // 跳转到购物车页面
    this.setData({
      goodDetailsheight: '',
      goodDetailsOverflow: 'none',
      specificationListShow: false,
      confirmOrFooter: true
    })
    wx.navigateTo({
      url: '../purchase-car/purchase-car',
    })
  },
  getGoodsDetails(id) { // 获取商品详情
  var that = this;
  let url = `/goods/basegoods/detail`
    fetch(url, 'get', {
      id: id
    })
    .then(res => {
      if (res.status) {
        //this.data.flagTitle?this.getActivity(id, parseFloat(res.obj.price)):'';
          this.getActivity(id, parseFloat(res.obj.price))
        this.setData({
          bflist: res.obj,
          spuid:res.obj,
          detailName: res.obj.productName
        })
        if (res.obj.smallPiclist == null || res.obj.smallPiclist.length==0){
          res.obj.smallPiclist = ['image/goods_pic_no.png']
        }else{
          for (let i = 0; i < res.obj.smallPiclist.length;i++){
            res.obj.smallPiclist[i] = that.data.resourcePath + res.obj.smallPiclist[i]
          }
        }
        
        this.setData({
          prodetailsObj: res.obj
        })
        WxParse.wxParse('article', 'html', this.data.prodetailsObj.productDesc || '无', this, 0);
      }
   
    })
  },
  goodCollect(e) {
    let id = e.currentTarget.dataset.id
    let url = ''
    if (this.data.prodetailsObj.isFavorite === 0) {
      url = `/product/productfavorite/collectSpu`
    } else {
      url = `/product/productfavorite/delCollectSpu`
    }
    fetch(url, 'get', {
      spuId: id
    })
    .then((res) => {
      if (res.status) {
        if (this.data.prodetailsObj.isFavorite === 0) {
          this.data.prodetailsObj.isFavorite = 1
          this.setData({
            prodetailsObj: this.data.prodetailsObj
          })
        } else {
          this.data.prodetailsObj.isFavorite = 0
          this.setData({
            prodetailsObj: this.data.prodetailsObj
          })
        }
      }
    })
  },
  getRecommendPlan(productId) { // 方案列表
    let url = `/goods/basegoods/design`
    fetch(url, 'get', {
      spuId: productId
    }).
      then(res => {
        if (res.status) {
          if (res.obj.length > 0) {
            let recommendPlanList = [];
            recommendPlanList.push(res.obj[0]);
            this.setData({
              recommendPlanList: recommendPlanList,
              planNum: res.obj.length
            })
            this.emptyTemplateShow('hide')
          } else {
            this.setData({
              recommendPlanList: [],
              planNum: 0
            })
            this.emptyTemplateShow('show')
          }
        } else {
          this.emptyTemplateShow('show')
          this.setData({
            recommendPlanList: [],
            planNum: 0
          })
        }
      })
      .catch(res => {
        this.emptyTemplateShow('show')
        this.setData({
          recommendPlanList: [],
          planNum: 0
        })
      })
  },
  // toVideo(e) {
  //   wx.navigateTo({
  //     url: '../video/video?url=' + this.data.resourcePath + e.currentTarget.dataset.item[0]
  //   })
  // },
  putInMyhouse(e) { // 装进我家
    // this.renderTypeShow() // 显示组件
    let item = e.currentTarget.dataset.item
    wx.setStorageSync('caseItem', item)
    wx.navigateTo({
      url: '../case-house-type/case-house-type'
    })
  },
  collectCase(e) { // 方案收藏
    var that = this
    if (that.data.collectRequest == true) {
      that.setData({
        collectRequest: false
      })
    let url = `/designplanfavorite/setFavoriteOrUnfavorite`,
      item = e.currentTarget.dataset.item,
      index = e.currentTarget.dataset.index,
      status = null,
      title = '收藏'
    if (item.isFavorite) {
      status = 0
    } else {
      status = 1
    }
    status == 0 ? title = '取消收藏' : '收藏'

    fetch(url, 'post', {
      status: status,
      recommendId: item.designPlanRecommendId
    })
      .then((res) => {
        if (res.success) {
          this.data.recommendPlanList[index].isFavorite = status
          status == 0 ? this.data.recommendPlanList[index].collectNum -= 1 : this.data.recommendPlanList[index].collectNum += 1
          this.setData({
            recommendPlanList: this.data.recommendPlanList
          })
          wx.showToast({
            title: title + '成功'
          })
          setTimeout(function () {
            that.setData({
              collectRequest: true
            })
          }, 500) 
        } else {
          wx.showToast({
            title: '收藏失败',
            icon: 'none'
          })
          setTimeout(function () {
            that.setData({
              collectRequest: true
            })
          }, 500) 
        }
      })
    }else{
      return;
    }
  },
  likeCase(e) { // 方案点赞
    var that = this;
    if (that.data.favoriteRequest == true) {
      that.setData({
        favoriteRequest: false
      })
    let url = `/designPlanLike/setLikeOrDislike`,
      item = e.currentTarget.dataset.item,
      index = e.currentTarget.dataset.index,
      status = null,
      title = '点赞'
    if (item.isLike) {
      status = 0
    } else {
      status = 1
    }
    status == 0 ? title = '取消点赞' : '点赞'
    fetch(url, 'post', {
      status: status,
      designId: item.designPlanRecommendId
    })
    .then((res) => {
      if (res.success) {
        this.data.recommendPlanList[index].isLike = status
        status == 0 ? this.data.recommendPlanList[index].likeNum -= 1 : this.data.recommendPlanList[index].likeNum += 1
        this.setData({
          recommendPlanList: this.data.recommendPlanList
        })
        wx.showToast({
          title: title + '成功'
        })
        setTimeout(function () {
          that.setData({
            favoriteRequest: true
          })
        }, 500)
      } else {
        wx.showToast({
          title: title + '失败',
          icon: 'none'
        })
        setTimeout(function () {
          that.setData({
            favoriteRequest: true
          })
        }, 500)
      }
    })
    }else{
      return
    }
  },
  getPurchasecarNumber() { // 获取购物车数量
    let url = `/cart/getDetail`,
        count = 0
    fetch(url, 'get')
    .then((res) => {
      if (res.status) {
        if (res.obj) {
          myForEach(res.obj.cartProductList, (value) => {
            count += value.productNumber
          })
          this.setData({
            carCount: count
          })
        } else {
          this.setData({
            carCount: 0
          })
        }
      } else {
        this.setData({
          carCount: 0
        })
      }
    })
  }, 
  leaveAMessage() { // 未开放此功能
    wx.showToast({
      title: '未开放此功能',
      icon: 'none'
    })
  },
  toOfficalWeb(){
    wx.navigateTo({
      url: '/pages/mini-offcial-web/mini-offcial-web',
    })
  },
  bannerError: function (e) {//缺省图
    var _errImg = e.target.dataset.img
    var _errObj = {}
    _errObj[_errImg] = "image/goods_pic_no.png"
    this.setData(_errObj) //注意这里的赋值方式,只是将数据列表中的此项图片路径值替换掉  
  },
  toRecommendPlan(){//跳转到推荐方案页
    
    wx.navigateTo({
      url: '/pages/goods-details-plan/goods-details-plan?id=' + this.data.productId,
    })
  },
  callService(){
    let phone = '18928178107'
    wx.makePhoneCall({
      phoneNumber: phone,
    })
  },
 
})