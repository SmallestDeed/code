let fetch = getApp().fetch
let $App = getApp()
Page({
    /**
     * 页面的初始数据
     */
    data: {
        resourcePath: getApp().resourcePath,
        sevenUrl: getApp().sevenUrl,
        curPage: 1,
        pageSize: 10,
        spaceFunctionId: "",
        houseId: "",
        isSort: 0,
        contentlist: [],
        message: "加载中",
        deleteFlag: false,
        deleteIndex: ''
    },
    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function() {
        new $App.quickNavigation() // 注册组件
        // 用户数据

        this.getSearchResluts('加载数据');
    },
    /**
     * 生命周期函数--监听页面初次渲染完成
     */
    onReady: function() {},
    /**
     * 生命周期函数--监听页面显示
     */
    onShow: function() {},
    /**
     * 生命周期函数--监听页面隐藏
     */
    onHide: function() {},
    /**
     * 生命周期函数--监听页面卸载
     */
    onUnload: function() {},
    /**
     * 页面相关事件处理函数--监听用户下拉动作
     */
    onPullDownRefresh: function() {},
    /**
     * 页面上拉触底事件的处理函数
     */
    onReachBottom: function() {

        this.setData({
            pageSize: this.data.pageSize + 5
        })
        this.getSearchResluts('加载数据');
    },
    /**
     * 用户点击右上角分享
     */
    onShareAppMessage: function(res) {
        if (res.from === 'menu') {
            return $App.shareAppMessageFn(true);
        }
    },
    getSearchResluts: function(message) {
        var that = this
        var url = "/autorender/mydesignplan"
        var data = {
            spaceFunctionId: that.data.spaceFunctionId,
            houseId: that.data.houseId,
            isSort: 0,
            pageSize: this.data.pageSize,
            curPage: 1,
        }
        fetch(url, 'get', data)
            .then((res) => {

                var contentlistTem = that.data.contentlist
                if (res.success) {
                    this.setData({
                        contentlist: res.obj
                    })
                } else {
                    contentlist: []
                }

                if (!res.flag) {

                    that.setData({
                        message: res.message
                    })

                }
            })
            .catch((res) => {
                that.setData({
                    message: res.message
                })
            })
    },
    formToThreeD(e) {
        let type = e.detail.target.dataset.type,
            item = e.detail.target.dataset.item,
            routerQueryType = '',
            formId = e.detail.formId
        if (type === '720') {
            routerQueryType = 'seven'
        } else {
            routerQueryType = 'roam'
        }
        let sevenObj = {
            token: wx.getStorageSync('token'),
            platformCode: 'brand2c',
            operationSource: 0,
            planId: item.cpId,
            routerQueryType: routerQueryType,
            customReferer: $App.wxUrl,
            platformNewCode: 'miniProgram',
            formId: formId
        }
        let webUrl = this.data.sevenUrl
        for (let key in sevenObj) {
            webUrl += key + '=' + sevenObj[key] + '&'
        }
        getApp().data.webUrl = webUrl
        console.log(webUrl)
        wx.navigateTo({
            url: '../web-720/web-720',
        })
    },
    toThreeD(e) {
        let routerQueryType = e.currentTarget.dataset.type,
            item = e.currentTarget.dataset.item,
            webUrl = null,
            that = this,
            url = '/mobile/renderPic/getPictureList.htm',
            url2 = '/mobile/design/designPlan/getPanoPicture.htm',
            data = {
                id: item.cpId,
                remark: routerQueryType
            },
            sevenObj = null
        if (routerQueryType === 'video') {
            fetch(url, 'post', data, 'render')
                .then(res => {
                    if (res.success) {
                        return res.datalist[0].id
                    } else {
                        return false
                    }
                })
                .then(res => {
                    if (res) {
                        fetch(url2, 'post', {
                            thumbId: res
                        }, 'render')
                            .then(res => {
                                res.success ? that.toVideo(res.obj.url) : wx.showToast({
                                    title: '打开失败',
                                    icon: 'none'
                                })
                            })
                    }
                })
        } else {
            item.fullHousePlanUUID ? (webUrl = $App.wholeHouseUrl, sevenObj = {
                    uuid: item.fullHousePlanUUID,
                    embedded: 1
                }) :
                (webUrl = this.data.sevenUrl, sevenObj = {
                    token: wx.getStorageSync('token'),
                    platformCode: 'brand2c',
                    operationSource: 0,
                    planId: item.cpId,
                    routerQueryType: routerQueryType,
                    customReferer: $App.wxUrl,
                    platformNewCode: 'miniProgram'
                })
            for (let key in sevenObj) {
                webUrl += key + '=' + sevenObj[key] + '&'
            }
            getApp().data.webUrl = webUrl
            $App.myNavigateBack('pages/web-720/web-720')
            console.log(webUrl)
        }
    },
    enlargeImage(url) { // 查看大图
        wx.previewImage({
            current: url, // 当前显示图片的http链接
            urls: [url] // 需要预览的图片http链接列表
        })
    },
    toVideo(url) {
        wx.navigateTo({
            url: '../video/video?url=' + url
        })
    },
    deletebtn(e) { //删除按钮

        var that = this;
        that.setData({
            deleteFlag: !that.data.deleteFlag,
            deleteIndex: e.currentTarget.dataset.index
        })

    },
    delete(e) { //删除装修
        var that = this
        let id = e.currentTarget.dataset.id
        let url = '/mobile/design/designPlan/deleteMyDesignPlanAndTask.htm'

        fetch(url, 'post', {
                planId: id
            }, 'render')
            .then((res) => {
                that.setData({
                    deleteFlag: false,
                    deleteIndex: ''
                })
                if (res.success) {
                    wx.showToast({
                        title: '删除成功',
                        duration: 2000,
                        complete: function() {

                            setTimeout(function() {
                                //要延时执行的代码

                                that.getSearchResluts('加载数据')
                            }, 2000) //延迟时间
                        }
                    })
                } else {
                    wx.showToast({
                        title: '删除失败',
                        duration: 2000,
                        complete: function() {

                            setTimeout(function() {
                                //要延时执行的代码

                                that.getSearchResluts('加载数据')
                            }, 2000) //延迟时间
                        }
                    })
                }
            })

    },
    tohousetype() {
        wx.switchTab({
            url: '/pages/house-type/house-type',
        })
    }

})