// pages/goods-details-plan/goods-details-plan.js
let fetch = getApp().fetch,
    myForEach = getApp().myForEach,
    mySplitUrl = getApp().mySplitUrl,
    myCompoundUrl = getApp().myCompoundUrl,
    $App = getApp()
import {
    emptyTemplate
} from '../../component/emptyTemplate/emptyTemplate'
let opt = {};
Page({

    /**
     * 页面的初始数据
     */
    data: {
        recommendPlanList: [],
        resourcePath: getApp().resourcePath,
        pageSize: 10,
        sevenUrl: getApp().sevenUrl,
        favoriteRequest: true,
        collectRequest: true,
        optionsId: '',
    },

    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function(options) {
        opt = options
        this.setData({
            optionsId: options.id
        })

    },
    getRecommendPlan(productId) { // 方案列表
        let url = `/goods/basegoods/design`
        fetch(url, 'get', {
            spuId: productId
        }).
        then(res => {
                if (res.status) {
                    if (res.obj.length > 0) {
                        this.setData({
                            recommendPlanList: res.obj
                        })
                        this.emptyTemplateShow('hide')
                    } else {
                        this.setData({
                            recommendPlanList: []
                        })
                        this.emptyTemplateShow('show')
                    }
                } else {
                    this.emptyTemplateShow('show')
                    this.setData({
                        recommendPlanList: []
                    })
                }
            })
            .catch(res => {
                this.emptyTemplateShow('show')
                this.setData({
                    recommendPlanList: [],
                    planNum: 0
                })
            })
    },
    /**
     * 生命周期函数--监听页面初次渲染完成
     */
    onReady: function() {

    },

    /**
     * 生命周期函数--监听页面显示
     */
    onShow: function() {
        this.getRecommendPlan(this.data.optionsId)
    },

    /**
     * 生命周期函数--监听页面隐藏
     */
    onHide: function() {

    },

    /**
     * 生命周期函数--监听页面卸载
     */
    onUnload: function() {

    },

    /**
     * 页面相关事件处理函数--监听用户下拉动作
     */
    onPullDownRefresh: function() {

    },

    /**
     * 页面上拉触底事件的处理函数
     */
    onReachBottom: function() {

    },

    /**
     * 用户点击右上角分享
     */
    onShareAppMessage: function(res) {
        if (res.from === 'menu') {
            return $App.shareAppMessageFn(true, '?id=' + opt.id);
        }
    },
    formToThreeD(e) { // 720
        let type = e.detail.target.dataset.type,
            item = e.detail.target.dataset.item,
            routerQueryType = '',
            formId = e.detail.formId
        if (type === '720' || type === 'roam') {
            let routerQueryType = ''
            if (type === '720') {
                routerQueryType = 'seven'
            } else {
                routerQueryType = 'roam'
            }
            let sevenObj = {
                token: wx.getStorageSync('token'),
                platformCode: 'brand2c',
                operationSource: 1,
                planId: item.designPlanRecommendId,
                routerQueryType: routerQueryType,
                customReferer: $App.wxUrl,
                platformNewCode: 'miniProgram',
                formId: formId
            }
            let webUrl = this.data.sevenUrl
            for (let key in sevenObj) {
                webUrl += key + '=' + sevenObj[key] + '&'
            }
            getApp().data.webUrl = webUrl
            $App.myNavigateBack('pages/web-720/web-720')
            return
        }
    },
    toThreeD(e) { // 调转到3D界面
        let url = `/mobile/designPlanRecommended/getRecommendedPictureList.htm`,
            item = e.currentTarget.dataset.item,
            type = e.currentTarget.dataset.type
        fetch(url, 'post', {
                planRecommendedId: item.designPlanRecommendId,
                remark: type
            }, 'render')
            .then(res => {
                if (res.success) {
                    if (type == 'photo') {
                        return res.datalist[0].pid
                    } else {
                        return res.datalist[0].id
                    }
                } else {
                    return false
                }
            })
            .then(res => {
                if (res) {
                    let url = `/mobile/design/designPlan/getPanoPicture.htm`
                    fetch(url, 'post', {
                            thumbId: res
                        }, 'render')
                        .then(res => {
                            if (res.success) {
                                if (type == 'photo') {
                                    this.enlargeImage(res.obj.url)
                                } else if (type == 'video') {
                                    this.toVideo(res.obj.url)
                                }
                            } else {
                                wx.showToast({
                                    title: '打开失败',
                                    icon: 'none'
                                })
                            }
                        })
                }
            })
    },
    enlargeImage(url) { // 查看大图
        wx.previewImage({
            current: url, // 当前显示图片的http链接
            urls: [url] // 需要预览的图片http链接列表
        })
    },
    toVideo(url) {
        wx.navigateTo({
            url: '../video/video?url=' + url
        })
    },
    putInMyhouse(e) { // 装进我家
        // this.renderTypeShow() // 显示组件
        let item = e.currentTarget.dataset.item
        wx.setStorageSync('caseItem', item)
        wx.navigateTo({
            url: '../case-house-type/case-house-type'
        })
    },
    collectCase(e) { // 方案收藏
        var that = this
        if (that.data.collectRequest == true) {
            that.setData({
                collectRequest: false
            })
            let url = `/designplanfavorite/setFavoriteOrUnfavorite`,
                item = e.currentTarget.dataset.item,
                index = e.currentTarget.dataset.index,
                status = null,
                title = '收藏'
            if (item.isFavorite) {
                status = 0
            } else {
                status = 1
            }
            status == 0 ? title = '取消收藏' : '收藏'

            fetch(url, 'post', {
                    status: status,
                    recommendId: item.designPlanRecommendId
                })
                .then((res) => {
                    if (res.success) {
                        this.data.recommendPlanList[index].isFavorite = status
                        status == 0 ? this.data.recommendPlanList[index].collectNum -= 1 : this.data.recommendPlanList[index].collectNum += 1
                        this.setData({
                            recommendPlanList: this.data.recommendPlanList
                        })
                        wx.showToast({
                            title: title + '成功'
                        })
                        setTimeout(function() {
                            that.setData({
                                collectRequest: true
                            })
                        }, 500)
                    } else {
                        wx.showToast({
                            title: '收藏失败',
                            icon: 'none'
                        })
                        setTimeout(function() {
                            that.setData({
                                collectRequest: true
                            })
                        }, 500)
                    }
                })
        } else {
            return;
        }
    },
    likeCase(e) { // 方案点赞
        var that = this;
        if (that.data.favoriteRequest == true) {
            that.setData({
                favoriteRequest: false
            })
            let url = `/designPlanLike/setLikeOrDislike`,
                item = e.currentTarget.dataset.item,
                index = e.currentTarget.dataset.index,
                status = null,
                title = '点赞'
            if (item.isLike) {
                status = 0
            } else {
                status = 1
            }
            status == 0 ? title = '取消点赞' : '点赞'
            fetch(url, 'post', {
                    status: status,
                    designId: item.designPlanRecommendId
                })
                .then((res) => {
                    if (res.success) {
                        this.data.recommendPlanList[index].isLike = status
                        status == 0 ? this.data.recommendPlanList[index].likeNum -= 1 : this.data.recommendPlanList[index].likeNum += 1
                        this.setData({
                            recommendPlanList: this.data.recommendPlanList
                        })
                        wx.showToast({
                            title: title + '成功'
                        })
                        setTimeout(function() {
                            that.setData({
                                favoriteRequest: true
                            })
                        }, 500)
                    } else {
                        wx.showToast({
                            title: title + '失败',
                            icon: 'none'
                        })
                        setTimeout(function() {
                            that.setData({
                                favoriteRequest: true
                            })
                        }, 500)
                    }
                })
        } else {
            return
        }
    },
})