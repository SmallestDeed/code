// pages/confirm-order/confirm-order.js
let fetch = getApp().fetch
var {
    shareTitle
} = require('../../utils/config.js');
var shareTitle = {
    shareTitle
}.shareTitle;
let $App = getApp()
let lastSalePriceTotal = ''
let lastTap = '';
let flagTitle = shareTitle == '诺克照明';
Page({

    /**
     * 页面的初始数据
     */
    data: {
        addressList: [],
        productDetailsObj: {},
        orderRemask: '',
        defaultAddress: {}, // 默认地址
        resourcePath: getApp().resourcePath,
        totalPrice: 0, //总价格
        couponList: [],
        couponListT: [],
        staticImageUrl: getApp().staticImageUrl,
        couponListF: [],
        fCilck:false,
        isShowZzc: false,
        active: false,
        ssMoney: '',
        chindex: 0,
        couponId: '',
        allMoney: '',
        flagTitle: flagTitle,
        fastList: '',
        goodsPrice: '',
        lastChindex: 0,
        distributor:false,
        distributorObj:[
            { id: 0, val: '江苏省苏州市张家港市杨舍镇啊啊啊啊' },
            { id: 1, val: '江苏省苏州市张家港市杨舍镇' },
            { id: 2, val: '江苏省苏州市张家港市杨舍镇' },
            { id: 3, val: '江苏省苏州市张家港市杨舍镇666' },
            { id: 4, val: '江苏省苏州市张家港市杨舍镇77777' },
            { id: 5, val: '江苏省苏州市张家港市杨舍镇23123131' },
            { id: 6, val: '江苏省苏州市张家港市杨舍镇' },
        ],
        distributorVal:'',
        distrId:-1,
        receiveNo: null,
    },
    chTap: function(e) {
        let chindex = e.currentTarget.dataset.chindex
        if (lastTap == chindex && this.data.chindex != '-1') {
            this.setData({
                chindex: '-1'
            })
        } else {
            this.setData({
                chindex: chindex
            })
            lastTap = chindex
        }
    },
    chooseBind(e){
        let curr = e.currentTarget.dataset;
        let flag = 
        this.setData({
            distrId: curr.i,
            distributorVal: curr.val,
            distributor: false,
        })
    },
    subTap: function() {
        let flags = this.data.chindex != '-1';
        let t = this.data.couponListT[this.data.chindex]
        let ssMoney = flags ? parseFloat(t.discountAmount).toFixed(2) : '';
        if (flags && t.discountAmount == 0 && t.rebateFactor && t.rebateFactor > 0) {
            ssMoney = parseFloat(this.data.goodsPrice * (1 - t.rebateFactor / 10)).toFixed(2)
        }
        this.setData({
            active: flags,
            ssMoney: ssMoney,
            isShowZzc: false,
            couponId: flags ? t.couponId : '',
            lastChindex: this.data.chindex,
            receiveNo: flags ? t.receiveNo : null,
        })
        let allMoney = lastSalePriceTotal;
        allMoney = this.data.ssMoney ? (parseFloat(allMoney - this.data.ssMoney).toFixed(2)) : allMoney;

        this.setData({
            totalPrice: allMoney,
        })

    },
    /**
     * 生命周期函数--监听页面加载
     */
    getCanBeUsedCouponList: function(id, free) {
        let url = '/product/baseCompany/getCompanyId';
        let url2 = 'v1/sandu/mini/activity/getCanBeUsedCouponList';
        let that = this;
        lastSalePriceTotal = free;
        fetch(url, 'get').then((res) => {
            if (res.obj) {
                let data = {
                    userId: wx.getStorageSync("userId"),
                    companyId: res.obj,
                    productId: id,
                    totalPrice: free
                }
                fetch(url2, 'post', data, 'shop').then((e) => {
                    if (e.data) {
                        let f = [],
                            t = [];
                        for (let i = 0; i < e.data.length; i++) {
                            e.data[i].canBeUseThisTime == 1 ? t.push(e.data[i]) : f.push(e.data[i]);
                        }
                        that.setData({
                            couponList: e.data,
                            couponListT: t,
                            couponListF: f,
                        })

                        setTimeout(function() {
                            if (t.length > 0) {
                                let ssMoney = parseFloat(t[0].discountAmount).toFixed(2);
                                if (t[0].discountAmount == 0 && t[0].rebateFactor && t[0].rebateFactor > 0) {
                                    ssMoney = parseFloat(that.data.goodsPrice * (1 - t[0].rebateFactor / 10)).toFixed(2)
                                }
                                that.setData({
                                    active: true,
                                    ssMoney: ssMoney,
                                    couponId: t[0].couponId,
                                    receiveNo: t[0].receiveNo,
                                    chindex: 0,
                                    lastTap: 0
                                })
                                console.log(that.data.receiveNo);
                                let allMoney = lastSalePriceTotal;
                                allMoney = that.data.ssMoney ? (parseFloat(allMoney - that.data.ssMoney).toFixed(2)) : allMoney;
                                that.setData({
                                    totalPrice: allMoney,
                                })
                            }
                        }, 200)

                    }
                })
            }
        })
    },
    chooseTapT: function() {
        this.setData({
            isShowZzc: true,
        })
    },
    chooseTapF: function() {
        this.setData({
            isShowZzc: false,
            chindex: this.data.lastChindex
        })
    },
    onLoad: function(options) {
        new $App.quickNavigation() // 注册组件
        let itemStr = options.item.replace('$', '&')
        let item = JSON.parse(itemStr)
        let allMoney = parseFloat(item.price * item.purchaseNumber + Number(item.transportMoney * item.purchaseNumber)).toFixed(2);
        allMoney = this.data.ssMoney ? (parseFloat(allMoney).toFixed(2) - parseFloat(this.data.ssMoney).toFixed(2)) : allMoney;
        this.setData({
            productDetailsObj: item,
            totalPrice: allMoney,
            goodsPrice: parseFloat(item.price * item.purchaseNumber).toFixed(2)
        })
        //flagTitle ? this.getCanBeUsedCouponList(item.productId, parseFloat(allMoney).toFixed(2)) : '';
        this.getCanBeUsedCouponList(item.productId, parseFloat(allMoney).toFixed(2))
        this.getAddressList() // 获取用户地址
    },
    /**
     * 生命周期函数--监听页面初次渲染完成
     */
    onReady: function() {

    },

    /**
     * 生命周期函数--监听页面显示
     */
    onShow: function() {
        this.getAddressList() // 获取用户地址    
    },

    /**
     * 生命周期函数--监听页面隐藏
     */
    onHide: function() {

    },

    /**
     * 用户点击右上角分享
     */
    onShareAppMessage: function() {
        if (res.from === 'menu') {
            return $App.shareAppMessageFn(false);
        }
    },
    toAddAddress() { // 跳转到添加收货地址
        wx.navigateTo({
            url: '../add-address/add-address',
        })
    },
    toAddressList() { // 跳转到地址列表
        wx.navigateTo({
            url: '../address-list/address-list',
        })
    },
    getAddressList() { // 获取用户地址列表
        if (wx.getStorageSync('defaultAddress')) {
            this.setData({
                defaultAddress: wx.getStorageSync('defaultAddress')
            })
            return
        }
        let url = `/order/getAddressByUserId`
        fetch(url, 'get')
            .then(res => {
                res.status && res.obj.length !== 0 ? this.setDataFun(res.obj, res.obj[0]) : this.setDataFun()
            })
    },
    setDataFun: function(a, b) {
        this.setData({
            addressList: a || [],
            defaultAddress: b || {}
        })
    },
    closeDistributor(){
        this.setData({
            distributor: !this.data.distributor
        })
    },
    immediatePayment() { // 立即支付
    let that = this
        if (this.data.fCilck) {
            wx.navigateTo({
                url: '/pages/my-order/my-order',
            })
            return;
        } else {
            
        }
        let flag = this.data.defaultAddress;
        if (JSON.stringify(flag) === '{}' || flag == "" || !flag) {
            wx.showModal({
                title: '提示',
                content: '请填写收货地址',
                success: (res) => {
                    if (res.confirm) {
                        wx.navigateTo({
                            url: '../add-address/add-address',
                        })
                    }
                }
            })
            return
        }
        let url = `/order/createorder`
        console.log(this.data.receiveNo);
        fetch(url, 'post', {
                consignee: this.data.defaultAddress.consignee,
                mobile: this.data.defaultAddress.mobile,
                province: this.data.defaultAddress.province,
                city: this.data.defaultAddress.city,
                district: this.data.defaultAddress.district,
                address: this.data.defaultAddress.address,
                remark: this.data.orderRemask,
                couponId: this.data.couponId,
                receiveNo: this.data.receiveNo?this.data.receiveNo+'':null,
                couponUserNo: this.data.receiveNo ? this.data.receiveNo + '' : null,
                orderAmount: this.data.productDetailsObj.salePrice * this.data.productDetailsObj.purchaseNumber,
                orderProductList: [{
                    "productId": this.data.productDetailsObj.productId,
                    "productCode": this.data.productDetailsObj.productCode || '',
                    "productNumber": this.data.productDetailsObj.purchaseNumber,
                    "productName": this.data.productDetailsObj.productName,
                    "productPrice": this.data.productDetailsObj.price,
                    "productStyleName": this.data.productDetailsObj.productStyleName || '默认',
                    "productColorName": this.data.productDetailsObj.productColorName || '默认',
                    "productPicPath": this.data.productDetailsObj.productPicPath,
                    remark: this.data.orderRemask,
                }]
            })
            .then(res => {
                return res.status ? res.obj : false
            })
            .then(params => {
                if (params) {
                    let url = `/web/pay/miniProPayOrder/mallOrderPaying`
                    fetch(url, 'formData', {
                            payMethod: 'miniPay',
                            orderNo: params.orderCode
                        }, 'pay')
                        .then(res => {
                            return res.status ? res.obj : false
                        })
                        .then((res) => {
                            if (res) {
                                that.setData({
                                    fCilck: true
                                })
                                wx.requestPayment({
                                    'timeStamp': res.timeStamp,
                                    'nonceStr': res.nonceStr,
                                    'package': res.packageStr,
                                    'signType': 'MD5',
                                    'paySign': res.paySign,
                                    'success': function(response) {
                                        wx.showToast({
                                            title: '支付成功',
                                        })
                                        wx.navigateTo({ // 成功跳转
                                            url: '/pages/my-order/my-order'
                                        })
                                    },
                                    'fail': function(err) {
                                        wx.showToast({
                                            title: '支付失败',
                                            icon: 'none'
                                        })
                                        // setTimeout(function () {
                                        //     console.log(1);
                                        //     wx.navigateBack({ changed: true });
                                        // }, 300)
                                    }
                                })
                            }
                        })
                }
            })
    },
    inputRemask(e) {
        this.setData({
            orderRemask: e.detail.value
        })
    }
})