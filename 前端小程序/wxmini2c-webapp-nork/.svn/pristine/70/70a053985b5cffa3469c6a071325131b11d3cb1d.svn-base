let fetch = getApp().fetch
let $App = getApp()
Page({
  /**
   * 页面的初始数据
   */
  data: {
    resourcePath: getApp().resourcePath,
    sevenUrl: getApp().sevenUrl,    
    curPage: 1,
    pageSize: 10,
    spaceFunctionId: "",
    houseId: "",
    isSort: 0,
    contentlist: [],
    message:"加载中",
    deleteFlag:false,
    deleteIndex:''
  },
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function() {
    new $App.quickNavigation() // 注册组件
    // 用户数据

    this.getSearchResluts('加载数据');
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function() {},
  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function() {},
  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {},
  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {},
  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function() {},
  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function() {},
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function (res) {
    if (res.from === 'menu') {
      return $App.shareAppMessageFn(true);
    }
  },
  getSearchResluts: function(message) {
    var that = this
    var url = "/autorender/mydesignplan"
    var data = {
      spaceFunctionId: that.data.spaceFunctionId,
      houseId: that.data.houseId,
      isSort: 0,
      pageSize: that.data.pageSize,
      curPage: that.data.curPage
    } 
    fetch(url, 'get', data)
      .then((res) => {

        var contentlistTem = that.data.contentlist
        if (res.success) {
          if (that.data.curPage == 1) {
            contentlistTem = []
          }
          var contentlist = res.obj;
          if (contentlist) {
            if (contentlist.length < that.data.pageSize) {
              that.setData({
                contentlist: contentlistTem.concat(contentlist),
                hasMoreData: false
              })
            } else {
              that.setData({
                contentlist: contentlistTem.concat(contentlist),
                hasMoreData: true,
                curPage: that.data.curPage + 1
              })
        
            }
          } else {
             that.setData({message:res.message})
          }
        }

        if (!res.flag) {

           that.setData({message:res.message})

        }
      })
      .catch((res) => {
        that.setData({message:res.message})
      })
  },
  toThreeD(e) {
    let item = e.currentTarget.dataset.item
    let type = e.currentTarget.dataset.type
    let id = ''
    if (type === '720' || type === 'roam') {
      let routerQueryType = ''
      if (type === '720') {
        routerQueryType = 'seven'
      } else {
        routerQueryType = 'roam'
      }
      let sevenObj = {
        token: wx.getStorageSync('token'),
        platformCode: 'brand2c',
        operationSource: 0,
        planId: item.cpId,
        routerQueryType: routerQueryType,
        customReferer: $App.wxUrl,
        platformNewCode: 'miniProgram'
      }
      let webUrl = this.data.sevenUrl
      for (let key in sevenObj) {
        webUrl += key + '=' + sevenObj[key] + '&'
      }
      getApp().data.webUrl = webUrl
      wx.navigateTo({
        url: '../web-720/web-720',
      })
      return
    }
    if (type == 'photo') {
      let cpid = e.currentTarget.dataset.id
      let url = `/mobile/renderPic/getPictureList.htm`
      fetch(url, 'post', {
        id: item.cpId,
        remark: type
      }, 'render')
        .then((res) => {
          let thumbId = res.datalist[0].pid
          let url = `/mobile/design/designPlan/getPanoPicture.htm`
          fetch(url,'post',{
            thumbId: thumbId
          },'render')
            .then((res)=>{
              console.log(res.obj.url)
              console.log(this.data.contentlist[0].pic)
                this.enlargeImage(res.obj.url)
                return
            })
        })
      
    }
      let url = `/mobile/renderPic/getPictureList.htm`
      fetch(url, 'post', {
        id: item.cpId,
        remark: type
      }, 'render')
        .then((res) => {
          if (res.success) {
            if (type === 'photo' || type === '720') {
              id = res.datalist[0].pid
            } else if (type === 'roam' || type === 'video') {
              id = res.datalist[0].id
            }
            return id
          } else {
            return false
          }
        })
        .then(res => {
          if (res) {
            let url = `/mobile/design/designPlan/getPanoPicture.htm`
            fetch(url, 'post', {
              thumbId: res
            }, 'render')
              .then(res => {
                if (res.success) {
                  if (type == 'photo') {
                    this.enlargeImage(res.obj.url)
                  } else if (type == '720' || type == 'roam') {
                    getApp().data.webUrl = res.obj.url
                    wx.navigateTo({
                      url: '../web-720/web-720',
                    })
                  } else if (type == 'video') {
                    this.toVideo(res.obj.url)
                  }
                } else {
                  wx.showToast({
                    title: '打开失败',
                    icon: 'none'
                  })
                }
              })
          }
        })
  },
  enlargeImage(url) { // 查看大图
    wx.previewImage({
      current: url, // 当前显示图片的http链接
      urls: [url] // 需要预览的图片http链接列表
    })
  },
  toVideo(url) {
    wx.navigateTo({
      url: '../video/video?url=' + url
    })
  },
  deletebtn(e){//删除按钮
    
    var that=this;
    that.setData({
      deleteFlag: !that.data.deleteFlag,
      deleteIndex: e.currentTarget.dataset.index
    })
  
  },
  delete(e){//删除装修
    var that=this
    let id = e.currentTarget.dataset.id
    let url ='/mobile/design/designPlan/deleteMyDesignPlanAndTask.htm'
    
      fetch(url, 'post', { planId: id },'render')
      .then((res) => {
        that.setData({
          deleteFlag:false,
          deleteIndex:''
        })
        if(res.success){
          wx.showToast({
            title:'删除成功',
            duration: 2000,
            complete: function () {

              setTimeout(function () {
                //要延时执行的代码

                that.getSearchResluts('加载数据')
              }, 2000) //延迟时间
            }
          })
        }else{
          wx.showToast({
            title: '删除失败',
            duration: 2000,
            complete: function () {

              setTimeout(function () {
                //要延时执行的代码

                that.getSearchResluts('加载数据')
              }, 2000) //延迟时间
            }
          })
        }
      })
    
  }
  
})