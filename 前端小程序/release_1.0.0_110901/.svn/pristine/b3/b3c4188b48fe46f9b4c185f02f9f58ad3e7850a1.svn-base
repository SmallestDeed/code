// pages/decoration/supplyDetail/supplyDetail.js
import { resourcePath, staticImageUrl } from '../../../utils/config.js'
let API = getApp().API
let $App = getApp()
Page({

  /**
   * 页面的初始数据
   */
  data: {
    id:'',
    siShowDetail: false,
    detail:[],
    resourcePath: resourcePath,
    imgUrl: staticImageUrl,
    supplyIcon: '/static/image/service_icon_gong.png',
    demandIcon: '/static/image/service_icon_qiu.png',
    emptyPageObj: {},
    mold: '',
    bottomType:'collect',
    addTypeFlag:false,
    imgList:[
    ],
    imgIdList:[],
    addPlanId:'',
    addPlanImg:'',
    addHouseId:'',
    addHouseImg:'',
    pageSize:5,
    commentTxt:'',
    planType:'',
    commentList:[]
  },
  
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    new $App.newNav()
    this.setData({ 
      id: options.id,
      mold: options.mold ? options.mold : ''
    })
    this.getDetail();
    this.addViewNum();
    this.getComment();
  },
  getComment(){
    API.getSupplydemandComment({ supplyDemandId: this.data.id, curPage: 0, pageSize:this.data.pageSize })
      .then(res => {
        if(res.obj){
          this.setData({
            commentList:res.obj
          })
        }
      })
  },
  changeTiem(tiem) {
    let leadTime = new Date().getTime() - new Date(tiem.replace(/\-/g, '/')), date;
    if (leadTime / 1000 / 60 < 1) {
      date = '刚刚';
    }
    if (leadTime / 1000 / 60 > 1 && leadTime / 1000 / 60 < 60) {
      date = (leadTime / 1000 / 60).toFixed(0) + '分钟前';
    }
    if (leadTime / 1000 / 3600 > 1 && leadTime / 1000 / 3600 < 60) {
      date = (leadTime / 1000 / 3600).toFixed(0) + '小时前';
    }
    if (leadTime / 1000 / 3600 / 24 > 1) {
      date = '1天前';
    }
    return date;
  },
  goEdit() {
    wx.navigateTo({
      url: '/pages/decoration/editPublish/editPublish',
    });
  },
  getDetail(){
    API.getSupplydemandinfoDetail({ supplyDemandId: this.data.id })
    .then(res => {
      console.log(res)
      if (res.obj) {
        let obj = res.obj;
        obj.gmtPublish = this.changeTiem(obj.gmtPublish);
        if (res.obj.baseHouse){
          res.obj.baseHouse.houseTypeStr = res.obj.baseHouse.houseTypeStr.substr(0, 6)
        }
        this.setData({ detail: obj, siShowDetail: true });
      } else {
        this.setData({
          siShowDetail: false,
          emptyPageObj: {
            imgUrl: '/static/image/issue.png',
            title: res.message,
          }
        });
      }
    })
  },
  addViewNum(){
    let url ='union/supplydemand/addsupplydemandviewnum'
    API.addSupplyDemandViewCount({ id: this.data.id })
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
  
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
    console.log(this.data.addPlanImg)
    console.log(this.data.addPlanId)
    let list = this.data.imgList
    if(this.data.addPlanImg && this.data.addPlanId){
      list.splice(0, 0, this.data.resourcePath+this.data.addPlanImg)  
    }
    if (this.data.addHouseImg && this.data.addHouseId) {
      list.splice(0, 0, this.data.resourcePath + this.data.addHouseImg)
    }
    this.setData({
      imgList: list
    })
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
  
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
  
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
  
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
  
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
  
  },
  bottomFocus(e){
    this.setData({
      bottomType:'input',
      
    })
  },
  addMore(){
    this.setData({
      addTypeFlag: !this.data.addTypeFlag
    })
  },
  addPlan(){
    wx.navigateTo({
      url: '/pages/plan/selection-scheme/selections-scheme',
    })
  },
  addHouse(){
    wx.navigateTo({
      url: '/pages/plan/selection-house-type/selection-house-type',
    })
  },
  addImg() {
    wx.chooseImage({
      count: 10,
      sourceType: ['album', 'camera'],
      sizeType: ['compressed'],
      success: (res) => {
        for(let i=0;i<res.tempFilePaths.length;i++){
          API.uploadFileIssuedImage({
            'platform': 'mini',
            'module': 'supply',
            'type': 'image',
            'path': res.tempFilePaths[i] 
          }).then(res => {
            if (res.success) {
              let list = this.data.imgList,
                  idList=this.data.imgIdList;
              list.splice(-1, 0, res.obj.url)
              idList.splice(-1, 0, res.obj.resId)
              this.setData({
                imgList: list,
                imgIdList: idList
              });
            } else {
             
            }
          })
        }
        // console.log(res.tempFilePaths)
        // let list = this.data.imgList
        // list.push.apply(list, res.tempFilePaths);
        // console.log(list)
        // this.setData({
        //   imgList: list
        // });
        // console.log(this.data.imgList)
      }
    });
  },
  deleteImg(e){
    let index = e.currentTarget.dataset.index
    let list = this.data.imgList
    list.splice(index,1)
    this.setData({
      imgList: list
    })
  },
  textareaInput(e){
    console.log(e.detail)
    this.setData({
      commentTxt: e.detail.value
    })
  },
  submitComment(e){
    let list = this.data.imgIdList;
    list = list.join(",")
    API.submitComment({ 
      reviewsMsg: this.data.commentTxt,
      businessId: this.data.id,
      coverPicIds: list,
      planId: this.data.addPlanId,
      planType: this.data.planType,
      houseId:this.data.addHouseId,
      supplyDemandPublisherId:this.data.detail.userId
      })
      .then(res => {
        if (res.status){
          wx.showToast({
            title: '评论成功',
          })  
        }else{
          wx.showToast({
            title: '评论失败',
          }) 
        }
      })
  },
  collectLike(e){
    console.log("123")
    API.collectPage({
      contentId:this.data.id,
      nodeType: 4,
      detailType: 1,
      status:1
    })
      .then(res => {
         console.log(res) 
      })
  }
})