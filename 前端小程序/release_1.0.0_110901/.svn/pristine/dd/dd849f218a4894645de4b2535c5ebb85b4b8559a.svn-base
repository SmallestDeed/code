// pages/plan/selection-house-type/selection-house-type.js
let API = getApp().API,
  myForEach = getApp().myForEach;
let $App = getApp()
Page({

  /**
   * 页面的初始数据
   */
  data: {
    type: 'myHouse',
    conditionActive: -1,
    childConditionActive: [0, -1, -1],
    getCaseParams: {
      spaceType: '',
      designPlanStyleId: '',
      spaceArea: ''
    },
    pageSize: 10,
    totalCount: 0,
    favoriteRequest: true,
    collectRequest: true,
    emptyPageObj: {},
    recommendCaseList: [],
    spaceList: [],
    areaList: [],
    styleList: [],
    isCheck: -1,
    staticImage: getApp().staticImageUrl,
    useList: [],
    resourcePath: getApp().resourcePath,
    houseType: 3,
    designStyleId: '',
    areaValue: ''
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    new $App.newNav() // 注册快速导航组件
    this.getConditionMetadata() // 获取方案筛选条件  
    this.getSearchResluts()
  },
  getSearchResluts: function(message) {
    let that = this
    API.getUserHouseTypeList({
        pageSize: that.data.pageSize,
        curPage: 1
      })
      .then(res => {
        if (res.obj) {
          for (let i = 0; i < res.obj.houselist.length; i++) {
            res.obj.houselist[i].houseTypeStr = res.obj.houselist[i].houseTypeStr.substr(0, 6)
            if (res.obj.houselist[i].totalArea != null) {
              res.obj.houselist[i].totalArea = res.obj.houselist[i].totalArea + 'm²'
            }
          }

          if (res.obj.houselist.length > 0) {
            this.setData({
              useList: res.obj.houselist
            })
          }
        } else {
          that.setData({
            message: res.message
          })
        }
      })
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function() {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function() {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function() {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function() {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function() {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function() {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function(res) {
    if (res.from === 'menu') {
      return $App.shareAppMessageObj
    }
  },
  // 顶部切换
  changeType(e) {
    this.setData({
      type: e.currentTarget.dataset.type
    })
    this.data.type == 'myHouse' ? this.getSearchResluts() : this.getRecommendCaseList()
  },
  // 收藏tab切换
  switchCondition(e) {
    let index = e.currentTarget.dataset.index
    if (index === this.data.conditionActive) {
      index = -1
    }
    this.setData({
      conditionActive: index
    })
  },
  closeCaseCondition() {
    this.setData({
      conditionActive: -1
    })
  },
  // 点击筛选条件
  chooseCondition(e) {
    let indexP = e.currentTarget.dataset.indexp,
      indexC = e.currentTarget.dataset.indexc
    if (indexP == 0) {
      this.setData({
        houseType: this.data.spaceList[indexC].houseType || '',
      })
    } else if (indexP == 1) {
      this.setData({
        areaValue: this.data.areaList[indexC].areaId || ''
      })
    } else if (indexP == 2) {
      this.setData({
        designStyleId: this.data.styleList[indexC].styleCode || '',
      })
    }
    this.getRecommendCaseList()
  },
  // 获取户型筛选条件
  getConditionMetadata() {
    API.getConditionMetadata()
      .then(res => {
        if (res.status) {
          this.setData({
            spaceList: res.obj,
            areaList: res.obj[0].designPlanAreaList,
            styleList: res.obj[0].designPlanStyleVoList,
            'getCaseParams.spaceType': res.obj[0].houseType
          })
          // this.getRecommendCaseList(this.data.getCaseParams)
        } else {
          this.setData({
            spaceList: [],
            areaList: [],
            styleList: []
          })
        }
      })
  },
  // 获取收藏户型列表
  getRecommendCaseList() {
    API.collectHouselist({
        start: 0,
        limit: this.data.pageSize,
        houseType: this.data.houseType,
        designStyleId: this.data.designStyleId,
        areaValue: this.data.areaValue
      })
      .then(res => {
        if (res.obj) {
          console.log(res)
          for (let i = 0; i < res.obj.length; i++) {
            res.obj[i].houseTypeStr = res.obj[i].houseTypeStr.substr(0, 6);
          }
          this.setData({
            useList: res.obj,
            totalCount: res.totalCount
          })
        } else {
          this.setData({
            useList: [],
            totalCount: 0,
            emptyPageObj: {
              imgUrl: '/static/image/undefined.png',
              title: '您还没有收藏方案哦',
              btnText: '去逛一逛',
              url: '/pages/plan/house-case/house-case',
              switchTab: true
            }
          })
        }
      })
  },
  // 上拉加载
  onReachBottom() {
    if (this.data.pageSize >= this.data.totalCount) {
      return
    } else {
      this.setData({
        pageSize: this.data.pageSize + 10
      })
    }
    this.data.type == 'myHouse' ? this.getSearchResluts() : this.getRecommendCaseList()
  },
  switchCheck(e) {
    let index = e.currentTarget.dataset.index
    if (index === this.data.isCheck) {
      index = -1
    }
    this.setData({
      isCheck: index
    })
  },
  confirmBtn() {
    let planType;
    if (this.data.type == 'myHouse') {
      this.data.useList[this.data.isCheck].planHouseType == 1 ? planType = 3 : planType = 4
    } else if (this.data.type == 'collectHouse') {
      this.data.useList[this.data.isCheck].spaceFuctionId == 13 ? planType = 2 : planType = 1
    }
    let pages = getCurrentPages(); //当前页面 
    let prevPage = pages[pages.length - 2]; //上一页面
    prevPage.setData({
      addPlanId: this.data.useList[this.data.isCheck].id,
      addPlanImg: this.data.useList[this.data.isCheck].thumbnailPath,
      planType: planType
    })
    wx.navigateBack({
      delta: 1
    })
  },

})