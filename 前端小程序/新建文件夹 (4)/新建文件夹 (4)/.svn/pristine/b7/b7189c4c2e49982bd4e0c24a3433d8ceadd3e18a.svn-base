import { resourcePath } from '../../../utils/config.js'
let API = getApp().API;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    resourcePath: resourcePath,
    type:0,
    curPage:1,
    pageSize:5,
    status: 1,
    List: {},
    emptyPageObj: {}
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    
  },
  getList(){
    API.getAllSupplyDemandInfo({
      curPage: this.data.curPage,
      mark: "MySupplydemandinfo",
      pageSize: this.data.pageSize,
      pushStatus: this.data.type
    })
    .then(res => {
      if (res.obj) {
        let arr = res.obj;
        arr.forEach((value, index) => {
          value.gmtModified = this.changeTiem(value.gmtModified);
        });
        this.setData({ List: arr });
      } else {
        this.setData({
          List: [],
          emptyPageObj: {
            imgUrl: '/static/image/issue.png',
            title: '暂未发布内容',
          }
        });
      }
    })
  },
  changeTiem(tiem) {
    let leadTime = new Date().getTime() - new Date(tiem.replace(/\-/g, '/')), date;
    if (leadTime / 1000 / 60 < 1 ) {
      date = '刚刚';
    }
    if (leadTime / 1000 / 60 > 1 && leadTime / 1000 / 60 < 60) {
      date = (leadTime / 1000 / 60).toFixed(0) + '分钟前';
    }
    if (leadTime / 1000 / 3600 > 1 && leadTime / 1000 / 3600 < 59) {
      date = (leadTime / 1000 / 3600).toFixed(0) + '小时前';
    }
    if (leadTime / 1000 / 3600 / 24 > 1 && leadTime / 1000 / 3600 / 24 < 24) {
      date = '1天前';
    }
    return date;
  },
  lowerFrame: function(e){
    let that = this
    wx.showModal({
      title: '提示',
      content: this.data.type == 0 ? '确认下架么？' : '确认上架么？',
      success: function (sm) {
        if (sm.confirm) {
          API.setPutawayOrSoldOut({
            supplyDemandId: e.currentTarget.dataset.id,
            pushStatus: e.currentTarget.dataset.status
          })
          .then(res => {
            that.getList()
          })
        }
      }
    })
  },
  editFun: function(e){
    let index = e.currentTarget.dataset.index
    wx.setStorage({
      key: 'editItem',
      data: this.data.List[index],
    })
    wx.navigateTo({
      url: '/pages/decoration/editPublish/editPublish',
    })
  },
  toPublish() {
    wx.navigateTo({
      url: '../../decoration/publish/publish'
    })
  },
    toDetail:function(e){
      console.log(e.currentTarget.dataset.id);
      wx.setStorage({
        key: 'editItem',
        data: e.currentTarget.dataset.id
      })
      let id = e.currentTarget.dataset.id.supplyDemandId
        wx.navigateTo({
          url: '/pages/decoration/supplyDetail/supplyDetail?id=' + id +'&mold=发布',
        })
    },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
      this.getList();
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
  
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
  
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
  },
  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    let num = this.data.pageSize + 5;
    this.setData({
      pageSize:num
    })
    this.getList();
  },
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
  },
  changeType(e){
    let type =e.currentTarget.dataset.type;
    this.setData({
      type:type,
      status: type
    })
    this.getList()
  }
})