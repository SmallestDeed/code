<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sandu.service.task.refresh.dao.RefreshDoorPositionMapper">

    <select id="getAllFilePath" resultType="com.sandu.api.task.refresh.model.FilePathBO">
        SELECT
          rf.id as fileId,
          rf.`config_path` as filePath,
          <!--rf.`file_path` as filePath,-->
          dt.`id` as templetId,
          ddt.`design_templet_id` as drawTempletId,
          dtu.`unique_id` as uniqueId
        FROM
          draw_space_common sc,
          draw_res_config rf,
          <!--draw_res_file rf,-->
          draw_design_templet ddt,
          design_templet dt,
          refresh_position_temp_20180815 dtu
        WHERE sc.bake_before_file_id = rf.id
          AND ddt.`space_common_id` = sc.`id`
          AND ddt.`design_templet_id` = dt.`id`
          AND sc.`is_deleted` = 0
          AND ddt.`is_deleted` = 0
          AND dt.`is_deleted` = 0
          <!--AND dtu.`is_deleted` = 0-->
          AND dtu.design_templet_id = ddt.id

    </select>

    <select id="getTargetTempletId" resultType="java.lang.Integer">
        SELECT
          dt.id
        FROM
          draw_design_templet ddt,
          design_templet dt,
          refresh_position_temp_20180815 dtu
        WHERE ddt.`design_templet_id` = dt.`id`
          AND ddt.`is_deleted` = 0
          AND dt.`is_deleted` = 0
          AND dtu.design_templet_id = ddt.id
          AND dtu.`unique_id` = #{uniqueId}
          AND dt.id != #{originTempletId}
    </select>

    <insert id="insertBatch" parameterType="list">

        insert into design_templet_jump_position_rel
            (
            origin_id,

            target_id,

            jump_position,

            draw_dtp_id,

            is_deleted,

            creator,

            modifier,

            remark
            )
        <!--<trim prefix="values (" suffix=")" suffixOverrides=",">-->
        VALUES
            <foreach collection="list" separator="," item="item" index="index">
                (
                    #{item.originId,jdbcType=BIGINT},

                    #{item.targetId,jdbcType=BIGINT},

                    #{item.jumpPosition,jdbcType=VARCHAR},

                    #{item.drawDtpId,jdbcType=BIGINT},

                    #{item.isDeleted,jdbcType=SMALLINT},

                    #{item.creator,jdbcType=VARCHAR},

                    #{item.modifier,jdbcType=VARCHAR},

                    #{item.remark,jdbcType=VARCHAR}
                )
            </foreach>
        <!--</trim>-->
    </insert>

    <update id="updateBatch" parameterType="list">
        UPDATE refresh_position_temp_20180815 set is_deleted = 1 where templet_id in
        <foreach collection="list" index="index" separator="," open="(" close=")" item="item">
            #{item}
        </foreach>
    </update>


    <select id="getErrorFilePath" resultType="com.sandu.api.task.refresh.model.FilePathBO">
        SELECT
        rf.id as fileId,
        rf.`config_path` as filePath,
        dt.`id` as templetId,
        ddt.`design_templet_id` as drawTempletId,
        dtu.`unique_id` as uniqueId
        FROM
        draw_space_common sc,
        draw_res_config rf,
        draw_design_templet ddt,
        design_templet dt,
        refresh_position_temp_20180815 dtu
        WHERE sc.bake_before_file_id = rf.id
        AND ddt.`space_common_id` = sc.`id`
        AND ddt.`design_templet_id` = dt.`id`
        AND dtu.design_templet_id = ddt.id
        AND sc.`is_deleted` = 0
        AND ddt.`is_deleted` = 0
        AND dt.`is_deleted` = 0
        AND dt.id in (
          SELECT d.target_id FROM design_templet_jump_position_rel d
          left join design_templet_jump_position_rel d2 on d.origin_id = d2.target_id and d.target_id = d2.origin_id
          where d2.id is null group by d.id
        )

    </select>

    <select id="selectInJumpPosition" parameterType="com.sandu.api.house.model.DesignTempletJumpPositionRel"
            resultType="java.lang.Integer">
        select count(1) from design_templet_jump_position_rel
        where origin_id = #{originId} and target_id = #{targetId}
    </select>

    <update id="updateBatchByUniqueId" parameterType="list">
        UPDATE refresh_position_temp_20180815 set is_deleted = 2
        where unique_id in
        <foreach collection="list" index="index" separator="," open="(" close=")" item="item">
            #{item.uniqueId}
        </foreach>
        and templet_id in
        <foreach collection="list" index="index" separator="," open="(" close=")" item="item">
            #{item.originId}
        </foreach>
    </update>
</mapper>