<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.act.dao.WxActBargainMapper">
    

    <sql id="Base_Column_List">
        id,act_name,share_img,act_rule,begain_time,end_time,product_name,product_original_price,product_discount_price,product_min_price,product_img,product_count,product_display_count,product_remain_count,product_vitual_count,registration_count,sys_reduce_num,my_cut_price_min,my_cut_price_max,cut_method_price_min,cut_method_price_max,only_allow_new,help_cut_per_day,help_cut_per_act,is_enable,app_id,app_name,company_id,company_name,creator,gmt_create,modifier,gmt_modified,is_deleted
    </sql>

    <insert id="insertWxActBargain" parameterType="com.sandu.api.act.model.WxActBargain">
        insert into wx_act_bargain
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="actName != null">
                act_name,
            </if>
            <if test="actRule != null">
                act_rule,
            </if>
            <if test="shareImg != null">
                share_img,
            </if>
            <if test="begainTime != null">
                begain_time,
            </if>
            <if test="endTime != null">
                end_time,
            </if>
            <if test="productName != null">
                product_name,
            </if>
            <if test="productOriginalPrice != null">
                product_original_price,
            </if>
            <if test="productDiscountPrice != null">
                product_discount_price,
            </if>
            <if test="productMinPrice != null">
                product_min_price,
            </if>
            <if test="productImg != null">
                product_img,
            </if>
            <if test="productCount != null">
                product_count,
            </if>
            <if test="productDisplayCount != null">
                product_display_count,
            </if>
            <if test="productRemainCount != null">
                product_remain_count,
            </if>
            <if test="productVitualCount != null">
                product_vitual_count,
            </if>
            <if test="registrationCount != null">
                registration_count,
            </if>
            <if test="sysReduceNum != null">
                sys_reduce_num,
            </if>
            <if test="myCutPriceMin != null">
                my_cut_price_min,
            </if>
            <if test="myCutPriceMax != null">
                my_cut_price_max,
            </if>
            <if test="cutMethodPriceMin != null">
                cut_method_price_min,
            </if>
            <if test="cutMethodPriceMax != null">
                cut_method_price_max,
            </if>
            
            <if test="onlyAllowNew != null">
                only_allow_new,
            </if>
            <if test="helpCutPerDay != null">
                help_cut_per_day,
            </if>
            <if test="helpCutPerAct != null">
                help_cut_per_act,
            </if>
            
            <if test="isEnable != null">
                is_enable,
            </if>
            <if test="appId != null">
                app_id,
            </if>
            <if test="appName != null">
                app_name,
            </if>
            <if test="companyId != null">
                company_id,
            </if>
            <if test="companyName != null">
                company_name,
            </if>
            <if test="creator != null">
                creator,
            </if>
            <if test="gmtCreate != null">
                gmt_create,
            </if>
            <if test="modifier != null">
                modifier,
            </if>
            <if test="gmtModified != null">
                gmt_modified,
            </if>
            <if test="isDeleted != null">
                is_deleted,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="actName != null">
                #{actName,jdbcType=VARCHAR},
            </if>
            <if test="actRule != null">
                #{actRule,jdbcType=VARCHAR},
            </if>
            <if test="shareImg != null">
                #{shareImg,jdbcType=VARCHAR},
            </if>
            <if test="begainTime != null">
                #{begainTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null">
                #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="productName != null">
                #{productName,jdbcType=VARCHAR},
            </if>
            <if test="productOriginalPrice != null">
                #{productOriginalPrice,jdbcType=VARCHAR},
            </if>
            <if test="productDiscountPrice != null">
                #{productDiscountPrice,jdbcType=VARCHAR},
            </if>
            <if test="productMinPrice != null">
                #{productMinPrice,jdbcType=VARCHAR},
            </if>
            <if test="productImg != null">
                #{productImg,jdbcType=VARCHAR},
            </if>
            <if test="productCount != null">
                #{productCount,jdbcType=INTEGER},
            </if>
            <if test="productDisplayCount != null">
                #{productDisplayCount,jdbcType=INTEGER},
            </if>
            <if test="productRemainCount != null">
                #{productRemainCount,jdbcType=INTEGER},
            </if>
            <if test="productVitualCount != null">
                #{productVitualCount,jdbcType=INTEGER},
            </if>
            <if test="registrationCount != null">
                #{registrationCount,jdbcType=INTEGER},
            </if>
            <if test="sysReduceNum != null">
                #{sysReduceNum,jdbcType=INTEGER},
            </if>
            <if test="myCutPriceMin != null">
                #{myCutPriceMin,jdbcType=VARCHAR},
            </if>
            <if test="myCutPriceMax != null">
                #{myCutPriceMax,jdbcType=VARCHAR},
            </if>
            <if test="cutMethodPriceMin != null">
                #{cutMethodPriceMin,jdbcType=VARCHAR},
            </if>
            <if test="cutMethodPriceMax != null">
                #{cutMethodPriceMax,jdbcType=VARCHAR},
            </if>
            
            <if test="onlyAllowNew != null">
                #{onlyAllowNew},
            </if>
            <if test="helpCutPerDay != null">
                #{helpCutPerDay},
            </if>
            <if test="helpCutPerAct != null">
                #{helpCutPerAct},
            </if>
            

            <if test="isEnable != null">
                #{isEnable,jdbcType=TINYINT},
            </if>
            <if test="appId != null">
                #{appId,jdbcType=VARCHAR},
            </if>
            <if test="appName != null">
                #{appName,jdbcType=VARCHAR},
            </if>
            <if test="companyId != null">
                #{companyId,jdbcType=INTEGER},
            </if>
            <if test="companyName != null">
                #{companyName,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                #{isDeleted,jdbcType=TINYINT},
            </if>
        </trim>
    </insert>

    <update id="updateWxActBargainById" parameterType="com.sandu.api.act.model.WxActBargain">
        update wx_act_bargain
        <set>
            <if test="id != null">
                id = #{id,jdbcType=VARCHAR},
            </if>
            <if test="actName != null">
                act_name = #{actName,jdbcType=VARCHAR},
            </if>
            <if test="actRule != null">
                act_rule = #{actRule,jdbcType=VARCHAR},
            </if>
            <if test="shareImg != null">
                share_img = #{shareImg,jdbcType=VARCHAR},
            </if>
            <if test="begainTime != null">
                begain_time = #{begainTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null">
                end_time = #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="productName != null">
                product_name = #{productName,jdbcType=VARCHAR},
            </if>
            <if test="productOriginalPrice != null">
                product_original_price = #{productOriginalPrice,jdbcType=VARCHAR},
            </if>
            <if test="productDiscountPrice != null">
                product_discount_price = #{productDiscountPrice,jdbcType=VARCHAR},
            </if>
            <if test="productMinPrice != null">
                product_min_price = #{productMinPrice,jdbcType=VARCHAR},
            </if>
            <if test="productImg != null">
                product_img = #{productImg,jdbcType=VARCHAR},
            </if>
            <if test="productCount != null">
                product_count = #{productCount,jdbcType=INTEGER},
            </if>
            <if test="productDisplayCount != null">
                product_display_count = #{productDisplayCount,jdbcType=INTEGER},
            </if>
            <if test="productRemainCount != null">
                product_remain_count = #{productRemainCount,jdbcType=INTEGER},
            </if>
            <if test="productVitualCount != null">
                product_vitual_count = #{productVitualCount,jdbcType=INTEGER},
            </if>
            <if test="registrationCount != null">
                registration_count = #{registrationCount,jdbcType=INTEGER},
            </if>
            <if test="sysReduceNum != null">
                sys_reduce_num = #{sysReduceNum,jdbcType=INTEGER},
            </if>
            <if test="myCutPriceMin != null">
                my_cut_price_min = #{myCutPriceMin,jdbcType=VARCHAR},
            </if>
            <if test="myCutPriceMax != null">
                my_cut_price_max = #{myCutPriceMax,jdbcType=VARCHAR},
            </if>
            <if test="cutMethodPriceMin != null">
                cut_method_price_min = #{cutMethodPriceMin,jdbcType=VARCHAR},
            </if>
            <if test="cutMethodPriceMax != null">
                cut_method_price_max = #{cutMethodPriceMax,jdbcType=VARCHAR},
            </if>

			<if test="onlyAllowNew != null">
                only_allow_new = #{onlyAllowNew},
            </if>
            <if test="helpCutPerDay != null">
                help_cut_per_day = #{helpCutPerDay},
            </if>
            <if test="helpCutPerAct != null">
                help_cut_per_act = #{helpCutPerAct},
            </if>
            
            <if test="isEnable != null">
                is_enable = #{isEnable,jdbcType=TINYINT},
            </if>
            <if test="appId != null">
                app_id = #{appId,jdbcType=VARCHAR},
            </if>
            <if test="appName != null">
                app_name = #{appName,jdbcType=VARCHAR},
            </if>
            <if test="companyId != null">
                company_id = #{companyId,jdbcType=INTEGER},
            </if>
            <if test="companyName != null">
                company_name = #{companyName,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                modifier = #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=TINYINT},
            </if>
        </set>
        where id = #{id,jdbcType=VARCHAR} and is_deleted=0
    </update>

    <update id="deleteWxActBargainById" >
        update wx_act_bargain set is_deleted = 1
        where id = #{actId}
    </update>
    
    <update id="updateToReduceProductRemainCount" >
        update wx_act_bargain 
        	set product_remain_count = product_remain_count-1,
        		product_display_count = product_display_count-1
        where id = #{actId} and product_remain_count>0 and is_deleted=0
    </update>
    
    <update id="updateToIncreaseRegistrationCount" >
        update wx_act_bargain set registration_count = registration_count+1
        where id = #{actId} and is_deleted=0
    </update>
    
    
    
    
    <select id="selectWxActBargainById" resultType="com.sandu.api.act.model.WxActBargain">
        select
        <include refid="Base_Column_List"/>
        from wx_act_bargain
        where id = #{actId} and is_deleted=0
    </select>
    
    <select id="selectWxActBargainByIdAndAppId" resultType="com.sandu.api.act.model.WxActBargain">
        select
        <include refid="Base_Column_List"/>
        from wx_act_bargain
        where id = #{actId} 
        and app_id = #{appId} 
        and is_deleted=0
    </select>

    <!--不用了-->
    <select id="selectAllEffectiveBargainAward"  resultType="com.sandu.api.act.model.WxActBargain">
        select
        <include refid="Base_Column_List"/>
        from wx_act_bargain
        where  is_deleted=0
        AND product_remain_count>0
        AND begain_time &lt; #{currentTime}
        AND end_time 	&gt; #{currentTime}
        AND sys_reduce_num !=0
        AND is_enable=1
    </select>
    
     <select id="selectWillExpireList"  resultType="com.sandu.api.act.model.WxActBargain">
        select
        <include refid="Base_Column_List"/>
        from wx_act_bargain
       	where product_remain_count>0 
			and is_enable=1 
			and end_time <![CDATA[ > ]]> now()
			and datediff(end_time,now()) <![CDATA[ < ]]> 2
			and is_deleted=0
    </select>
    
    

    <update id="updateVitualCount">
        update wx_act_bargain set
        product_remain_count =
        CASE 
        WHEN (product_remain_count - sys_reduce_num) &lt; 0 THEN 0
        ELSE (product_remain_count - sys_reduce_num)
        END,
        product_display_count =
        CASE 
        WHEN (product_remain_count - sys_reduce_num) &lt; 0 THEN 0
        ELSE (product_display_count - sys_reduce_num)
        END,
        product_vitual_count=
        CASE 
        WHEN (product_remain_count - sys_reduce_num) &lt; 0 THEN (product_vitual_count + product_remain_count)
        ELSE (product_vitual_count + sys_reduce_num)
        END
        WHERE is_deleted=0
        AND begain_time  &lt; NOW()
        AND end_time 	 &gt; NOW()
        AND sys_reduce_num !=0
        AND is_enable=1
        AND product_remain_count>0;
    </update>

    <select id="selectByAppids" resultType="com.sandu.api.act.model.WxActBargain">
        SELECT
          <include refid="Base_Column_List"/>
        FROM
          wx_act_bargain
        WHERE
          is_deleted = 0 AND
          app_id IN
          <foreach collection="appids" open="(" separator="," close=")" item="appid">
              #{appid}
          </foreach>
          ORDER BY
          gmt_create DESC
        limit #{page},#{limit}
    </select>

    <select id="countByAppids" resultType="int">
        SELECT
           count(*)
        FROM
            wx_act_bargain
        WHERE
            is_deleted = 0 AND
            app_id IN
            <foreach collection="appids" open="(" separator="," close=")" item="appid">
                #{appid}
            </foreach>
    </select>

    <select id="selectByActName" resultType="com.sandu.api.act.model.WxActBargain">
        SELECT
          *
        FROM
          wx_act_bargain
        WHERE
          act_name = #{actName} AND
          is_deleted = 0
    </select>

</mapper>