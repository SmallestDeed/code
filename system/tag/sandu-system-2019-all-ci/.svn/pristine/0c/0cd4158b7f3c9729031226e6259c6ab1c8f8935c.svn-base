<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.servicepurchase.dao.UserJurisdictionMapper" >
  <resultMap id="BaseResultMap" type="com.sandu.api.user.model.UserJurisdiction" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="user_id" property="userId" jdbcType="INTEGER" />
    <result column="platform_id" property="platformId" jdbcType="INTEGER" />
    <result column="jurisdiction_status" property="jurisdictionStatus" jdbcType="INTEGER" />
    <result column="jurisdiction_effective_time" property="jurisdictionEffectiveTime" jdbcType="TIMESTAMP" />
    <result column="jurisdiction_failure_time" property="jurisdictionFailureTime" jdbcType="TIMESTAMP" />
    <result column="modifier_user_id" property="modifierUserId" jdbcType="INTEGER" />
    <result column="sys_code" property="sysCode" jdbcType="VARCHAR" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
    <result column="modifier" property="modifier" jdbcType="VARCHAR" />
    <result column="gmt_modified" property="gmtModified" jdbcType="TIMESTAMP" />
    <result column="is_deleted" property="isDeleted" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, user_id, platform_id, jurisdiction_status, jurisdiction_effective_time,
    jurisdiction_failure_time, modifier_user_id, sys_code, creator, gmt_create, modifier, 
    gmt_modified, is_deleted, remark
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from user_jurisdiction
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from user_jurisdiction
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <delete id="delUserJurisdictionByUserId" parameterType="java.lang.Integer" >
    delete from user_jurisdiction
    where user_id = #{id,jdbcType=INTEGER}
  </delete>

  <insert id="insertSelective" parameterType="com.sandu.api.user.model.UserJurisdiction" useGeneratedKeys="true" keyProperty="id" >
    insert into user_jurisdiction
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="userId != null" >
        user_id,
      </if>
      <if test="platformId != null" >
        platform_id,
      </if>
      <if test="jurisdictionStatus != null" >
        jurisdiction_status,
      </if>
      <if test="jurisdictionEffectiveTime != null" >
        jurisdiction_effective_time,
      </if>
      <if test="jurisdictionFailureTime != null" >
        jurisdiction_failure_time,
      </if>
      <if test="modifierUserId != null" >
        modifier_user_id,
      </if>
      <if test="sysCode != null" >
        sys_code,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="gmtCreate != null" >
        gmt_create,
      </if>
      <if test="modifier != null" >
        modifier,
      </if>
      <if test="gmtModified != null" >
        gmt_modified,
      </if>
      <if test="isDeleted != null" >
        is_deleted,
      </if>
      <if test="remark != null" >
        remark,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="userId != null" >
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="platformId != null" >
        #{platformId,jdbcType=INTEGER},
      </if>
      <if test="jurisdictionStatus != null" >
        #{jurisdictionStatus,jdbcType=INTEGER},
      </if>
      <if test="userRoleGroupId != null" >
        #{userRoleGroupId,jdbcType=INTEGER},
      </if>
      <if test="jurisdictionEffectiveTime != null" >
        #{jurisdictionEffectiveTime,jdbcType=TIMESTAMP},
      </if>
      <if test="jurisdictionFailureTime != null" >
        #{jurisdictionFailureTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifierUserId != null" >
        #{modifierUserId,jdbcType=INTEGER},
      </if>
      <if test="sysCode != null" >
        #{sysCode,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null" >
        #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        #{isDeleted,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.sandu.api.user.model.UserJurisdiction" >
    update user_jurisdiction
    <set >
      <if test="userId != null" >
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="platformId != null" >
        platform_id = #{platformId,jdbcType=INTEGER},
      </if>
      <if test="jurisdictionStatus != null" >
        jurisdiction_status = #{jurisdictionStatus,jdbcType=INTEGER},
      </if>
      <if test="jurisdictionEffectiveTime != null" >
        jurisdiction_effective_time = #{jurisdictionEffectiveTime,jdbcType=TIMESTAMP},
      </if>
      <if test="jurisdictionFailureTime != null" >
        jurisdiction_failure_time = #{jurisdictionFailureTime,jdbcType=TIMESTAMP},
      </if>
      <if test="modifierUserId != null" >
        modifier_user_id = #{modifierUserId,jdbcType=INTEGER},
      </if>
      <if test="sysCode != null" >
        sys_code = #{sysCode,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null" >
        gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="deleteLogicByPrimaryKey" parameterType="java.lang.Long" >
    UPDATE  user_jurisdiction
    SET is_deleted = 1,
        remark=concat(remark,';delMark;'),
        sys_code=concat(concat(sys_code,'_del_'),
        unix_timestamp(now())),
        gmt_modified=now()
    WHERE id = #{id}
  </update>
  <sql id="sql_where" >
    <where >
      <if test="userId != null" >
         and user_id = #{userId,jdbcType=INTEGER}
      </if>
      <if test="platformId != null" >
         and platform_id = #{platformId,jdbcType=INTEGER}
      </if>
      <if test="jurisdictionStatus != null" >
         and jurisdiction_status = #{jurisdictionStatus,jdbcType=INTEGER}
      </if>
      <if test="jurisdictionEffectiveTime != null" >
         and jurisdiction_effective_time = #{jurisdictionEffectiveTime,jdbcType=TIMESTAMP}
      </if>
      <if test="jurisdictionFailureTime != null" >
         and jurisdiction_failure_time = #{jurisdictionFailureTime,jdbcType=TIMESTAMP}
      </if>
      <if test="modifierUserId != null" >
         and modifier_user_id = #{modifierUserId,jdbcType=INTEGER}
      </if>
      <if test="sysCode != null" >
         and sys_code = #{sysCode,jdbcType=VARCHAR}
      </if>
      <if test="creator != null" >
         and creator = #{creator,jdbcType=VARCHAR}
      </if>
      <if test="gmtCreate != null" >
         and gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
      </if>
      <if test="modifier != null" >
         and modifier = #{modifier,jdbcType=VARCHAR}
      </if>
      <if test="gmtModified != null" >
         and gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
      </if>
      <if test="isDeleted != null" >
         and is_deleted = #{isDeleted,jdbcType=INTEGER}
      </if>
      <if test="remark != null" >
         and remark = #{remark,jdbcType=VARCHAR}
      </if>
    </where>
  </sql>
  <sql id="Base_Column_List_platform" >
    uj.id,uj.user_id,uj.platform_id,uj.jurisdiction_status,uj.jurisdiction_effective_time,
    uj.jurisdiction_failure_time,uj.modifier_user_id,uj.sys_code,uj.creator,uj.gmt_create,uj.modifier,
    uj.gmt_modified,uj.is_deleted,uj.remark,bp.platform_name as platformName
  </sql>
  <select id="selectListSelective" resultMap="BaseResultMap" parameterType="com.sandu.api.user.model.UserJurisdiction" >
    SELECT
      <include refid="Base_Column_List_platform" />
    FROM user_jurisdiction uj join base_platform bp on uj.platform_id = bp.id
    where 1=1
      <if test="userId != null" >
        and uj.user_id = #{userId,jdbcType=INTEGER}
      </if>
      <if test="platformId != null" >
        and uj.platform_id = #{platformId,jdbcType=INTEGER}
      </if>
      <if test="jurisdictionStatus != null" >
        and uj.jurisdiction_status = #{jurisdictionStatus,jdbcType=INTEGER}
      </if>
      <if test="jurisdictionEffectiveTime != null" >
        and uj.jurisdiction_effective_time = #{jurisdictionEffectiveTime,jdbcType=TIMESTAMP}
      </if>
      <if test="jurisdictionFailureTime != null" >
        and uj.jurisdiction_failure_time = #{jurisdictionFailureTime,jdbcType=TIMESTAMP}
      </if>
      <if test="modifierUserId != null" >
        and uj.modifier_user_id = #{modifierUserId,jdbcType=INTEGER}
      </if>
      <if test="sysCode != null" >
        and uj.sys_code = #{sysCode,jdbcType=VARCHAR}
      </if>
      <if test="creator != null" >
        and uj.creator = #{creator,jdbcType=VARCHAR}
      </if>
      <if test="gmtCreate != null" >
        and uj.gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}
      </if>
      <if test="modifier != null" >
        and uj.modifier = #{modifier,jdbcType=VARCHAR}
      </if>
      <if test="gmtModified != null" >
        and uj.gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
      </if>
      <if test="isDeleted != null" >
        and uj.is_deleted = #{isDeleted,jdbcType=INTEGER}
      </if>
      <if test="remark != null" >
        and uj.remark = #{remark,jdbcType=VARCHAR}
      </if>
  </select>

  <select id="selectFranchiserJUris" resultType="java.lang.Integer">
    SELECT
        count( 1 )
    FROM
        user_jurisdiction
    WHERE
        user_id IN ( SELECT id FROM sys_user WHERE business_administration_id = ( SELECT business_administration_id FROM sys_user WHERE id = #{id} and is_deleted = 0 )  and is_deleted = 0 )
        AND platform_id = ( SELECT id FROM base_platform WHERE platform_code = #{type} )
        AND jurisdiction_status != 3
        AND is_deleted = 0
  </select>
	<!--得到经销商下获得该类型权限的用户数量  -->
  <select id="getFranchiserRoleCountByTypeAndId" resultType="java.lang.Integer" >
	SELECT count(*) FROM  user_jurisdiction WHERE user_id IN (
	SELECT id FROM sys_user WHERE  business_administration_id = #{id}  AND is_deleted =0 
	)
	AND platform_id = ( SELECT id FROM base_platform WHERE platform_code =  #{type}) AND jurisdiction_status != 3 AND is_deleted = 0 
  </select>

  <!--批量保存用户平台数据-->
  <insert id="insertUserPlatformList" parameterType="java.util.List">
    <if test="userJurisdictionList != null and userJurisdictionList.size > 0">
      insert into user_jurisdiction
      (
      user_id,
      platform_id,
      jurisdiction_status,
      jurisdiction_effective_time,
      jurisdiction_failure_time,
      modifier_user_id,
      sys_code,
      creator,
      gmt_create,
      modifier,
      gmt_modified,
      is_deleted,
      remark
      )
      values
      <foreach collection="userJurisdictionList" item="item" index="index" separator="," >
        (
        #{item.userId,jdbcType=INTEGER},
        #{item.platformId,jdbcType=INTEGER},
        #{item.jurisdictionStatus,jdbcType=INTEGER},
        #{item.jurisdictionEffectiveTime,jdbcType=TIMESTAMP},
        #{item.jurisdictionFailureTime,jdbcType=TIMESTAMP},
        #{item.modifierUserId,jdbcType=INTEGER},
        #{item.sysCode,jdbcType=VARCHAR},
        #{item.creator,jdbcType=VARCHAR},
        #{item.gmtCreate,jdbcType=TIMESTAMP},
        #{item.modifier,jdbcType=VARCHAR},
        #{item.gmtModified,jdbcType=TIMESTAMP},
        #{item.isDeleted,jdbcType=INTEGER},
        #{item.remark,jdbcType=VARCHAR}
        )
      </foreach>
    </if>
  </insert>

  <!--根据企业ID和平台code查询用户数量-->
  <select id="selectCompanyUserCount" resultType="java.lang.Integer">
    <!-- SELECT
     count( 1 )
     FROM
     user_jurisdiction
     WHERE
     user_id IN ( SELECT id FROM sys_user WHERE business_administration_id = #{companyId} and is_deleted = 0)
     AND platform_id = ( SELECT id FROM base_platform WHERE platform_code = #{type} )
     AND jurisdiction_status != 3
     AND is_deleted = 0-->

     SELECT
     COUNT( 1 )
     FROM
     user_jurisdiction uj,sys_user su,base_company bc
     WHERE
     uj.user_id = su.id AND su.business_administration_id = #{companyId}
     AND bc.id = su.business_administration_id
     AND bc.admin_user_id != su.id
     AND uj.platform_id = ( SELECT id FROM base_platform WHERE platform_code = #{type} )
     AND uj.jurisdiction_status != 3
     AND su.is_deleted = 0

   </select>
 </mapper>