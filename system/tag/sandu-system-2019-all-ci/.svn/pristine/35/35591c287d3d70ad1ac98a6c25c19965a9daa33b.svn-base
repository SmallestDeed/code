<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sandu.service.shop.dao.CompanyShopDao">

    <!-- **常量定义** -->
    <sql id="All_Column_List">
        id,company_id,company_pid,user_id,shop_code,shop_name,business_type,category_ids,first_category_ids,province_code,
        city_code,area_code,street_code,long_area_code,shop_address,contact_phone,contact_name,
        logo_pic_id,cover_res_ids,cover_res_type,introduced_file_id,release_platform_values,display_status,visit_count,praise_rate,
        sys_code,creator,gmt_create,modifier,gmt_modified,is_deleted,remark,longitude,latitude,design_fee_starting,design_fee_ending,
        decoration_price_start,decoration_price_end,working_years,decoration_type,is_blacklist,shop_type
    </sql>

    <!-- **插入定义** -->
    <insert id="insertShop" parameterType="com.sandu.api.shop.model.CompanyShop"  useGeneratedKeys="true" keyProperty="id">
        insert into company_shop
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="companyId!= null">company_id, </if>
            <if test="companyPid!= null">company_pid, </if>
            <if test="userId!= null">user_id, </if>
            <if test="shopCode!= null">shop_code, </if>
            <if test="shopName!= null">shop_name, </if>
            <if test="businessType!= null">business_type, </if>
            <if test="categoryIds!= null">category_ids, </if>
            <if test="firstCategoryIds!= null">first_category_ids, </if>
            <if test="provinceCode!= null">province_code, </if>
            <if test="cityCode!= null">city_code, </if>
            <if test="areaCode!= null">area_code, </if>
            <if test="streetCode!= null">street_code, </if>
            <if test="longAreaCode!= null">long_area_code, </if>
            <if test="shopAddress!= null">shop_address, </if>
            <if test="contactPhone!= null">contact_phone, </if>
            <if test="contactName!= null">contact_name, </if>
            <if test="logoPicId!= null">logo_pic_id, </if>
            <if test="coverResIds!= null">cover_res_ids, </if>
            <if test="coverResType!= null">cover_res_type, </if>
            <if test="introducedFileId!= null">introduced_file_id, </if>
            <if test="releasePlatformValues!= null">release_platform_values, </if>
            <if test="displayStatus!= null">display_status, </if>
            <if test="visitCount!= null">visit_count, </if>
            <if test="praiseRate!= null">praise_rate, </if>
            <if test="sysCode!= null">sys_code, </if>
            <if test="creator!= null">creator, </if>
            <if test="gmtCreate!= null">gmt_create, </if>
            <if test="modifier!= null">modifier, </if>
            <if test="gmtModified!= null">gmt_modified, </if>
            <if test="isDeleted!= null">is_deleted, </if>
            <if test="remark!= null">remark, </if>
            <if test="longitude!= null">longitude, </if>
            <if test="latitude!= null">latitude, </if>
            <if test="designFeeStarting!= null">design_fee_starting, </if>
            <if test="designFeeEnding!= null">design_fee_ending, </if>
            <if test="workingYears!= null">working_years, </if>
            <if test="decorationPriceStart!= null">decoration_price_start, </if>
            <if test="decorationPriceEnd!= null">decoration_price_end, </if>
            <if test="decorationType!= null">decoration_type, </if>
            <if test="shopType!= null">shop_type, </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="companyId!= null">  #{companyId,jdbcType=INTEGER}, </if>
            <if test="companyPid!= null">  #{companyPid,jdbcType=INTEGER}, </if>
            <if test="userId!= null">  #{userId,jdbcType=INTEGER}, </if>
            <if test="shopCode!= null">  #{shopCode,jdbcType=VARCHAR}, </if>
            <if test="shopName!= null">  #{shopName,jdbcType=VARCHAR}, </if>
            <if test="businessType!= null">  #{businessType,jdbcType=INTEGER}, </if>
            <if test="categoryIds!= null">  #{categoryIds,jdbcType=VARCHAR}, </if>
            <if test="firstCategoryIds!= null">  #{firstCategoryIds,jdbcType=VARCHAR}, </if>
            <if test="provinceCode!= null">  #{provinceCode,jdbcType=VARCHAR}, </if>
            <if test="cityCode!= null">  #{cityCode,jdbcType=VARCHAR}, </if>
            <if test="areaCode!= null">  #{areaCode,jdbcType=VARCHAR}, </if>
            <if test="streetCode!= null">  #{streetCode,jdbcType=VARCHAR}, </if>
            <if test="longAreaCode!= null">  #{longAreaCode,jdbcType=VARCHAR}, </if>
            <if test="shopAddress!= null">  #{shopAddress,jdbcType=VARCHAR}, </if>
            <if test="contactPhone!= null">  #{contactPhone,jdbcType=VARCHAR}, </if>
            <if test="contactName!= null">  #{contactName,jdbcType=VARCHAR}, </if>
            <if test="logoPicId!= null">  #{logoPicId,jdbcType=INTEGER}, </if>
            <if test="coverResIds!= null">  #{coverResIds,jdbcType=VARCHAR}, </if>
            <if test="coverResType!= null">  #{coverResType,jdbcType=INTEGER}, </if>
            <if test="introducedFileId!= null">  #{introducedFileId,jdbcType=INTEGER}, </if>
            <if test="releasePlatformValues!= null">  #{releasePlatformValues,jdbcType=VARCHAR}, </if>
            <if test="displayStatus!= null">  #{displayStatus,jdbcType=INTEGER}, </if>
            <if test="visitCount!= null">  #{visitCount,jdbcType=INTEGER}, </if>
            <if test="praiseRate!= null">  #{praiseRate,jdbcType=DOUBLE}, </if>
            <if test="sysCode!= null">  #{sysCode,jdbcType=VARCHAR}, </if>
            <if test="creator!= null">  #{creator,jdbcType=VARCHAR}, </if>
            <if test="gmtCreate!= null">  #{gmtCreate,jdbcType=TIMESTAMP}, </if>
            <if test="modifier!= null">  #{modifier,jdbcType=VARCHAR}, </if>
            <if test="gmtModified!= null">  #{gmtModified,jdbcType=TIMESTAMP}, </if>
            <if test="isDeleted!= null">  #{isDeleted,jdbcType=INTEGER}, </if>
            <if test="remark!= null">  #{remark,jdbcType=VARCHAR}, </if>
            <if test="longitude!= null">  #{longitude,jdbcType=DOUBLE}, </if>
            <if test="latitude!= null">  #{latitude,jdbcType=DOUBLE}, </if>
            <if test="designFeeStarting!= null">  #{designFeeStarting,jdbcType=DOUBLE}, </if>
            <if test="designFeeEnding!= null">  #{designFeeEnding,jdbcType=DOUBLE}, </if>
            <if test="workingYears!= null">#{workingYears}, </if>
            <if test="decorationPriceStart!= null"> #{decorationPriceStart}, </if>
            <if test="decorationPriceEnd!= null">#{decorationPriceEnd}, </if>
            <if test="decorationType!= null">#{decorationType}, </if>
            <if test="shopType!= null">#{shopType}, </if>
        </trim>
    </insert>

    <!-- **更新定义** -->
    <update id="updateShop" parameterType="com.sandu.api.shop.model.CompanyShop">
        update company_shop
        <set>
            <if test="companyId!= null">  company_id = #{companyId,jdbcType=INTEGER}, </if>
            <if test="companyPid!= null">  company_pid = #{companyPid,jdbcType=INTEGER}, </if>
            <if test="userId!= null">  user_id = #{userId,jdbcType=INTEGER}, </if>
            <if test="shopCode!= null">  shop_code = #{shopCode,jdbcType=VARCHAR}, </if>
            <if test="shopName!= null">  shop_name = #{shopName,jdbcType=VARCHAR}, </if>
            <if test="businessType!= null">  business_type = #{businessType,jdbcType=INTEGER}, </if>
            <if test="categoryIds!= null">  category_ids = #{categoryIds,jdbcType=VARCHAR}, </if>
            <if test="firstCategoryIds!= null">  first_category_ids = #{firstCategoryIds,jdbcType=VARCHAR}, </if>
            <if test="provinceCode!= null">  province_code = #{provinceCode,jdbcType=VARCHAR}, </if>
            <if test="cityCode!= null">  city_code = #{cityCode,jdbcType=VARCHAR}, </if>
            <if test="areaCode!= null">  area_code = #{areaCode,jdbcType=VARCHAR}, </if>
            <if test="streetCode!= null">  street_code = #{streetCode,jdbcType=VARCHAR}, </if>
            <if test="longAreaCode!= null">  long_area_code = #{longAreaCode,jdbcType=VARCHAR}, </if>
            <if test="shopAddress!= null">  shop_address = #{shopAddress,jdbcType=VARCHAR}, </if>
            <if test="contactPhone!= null">  contact_phone = #{contactPhone,jdbcType=VARCHAR}, </if>
            <if test="contactName!= null">  contact_name = #{contactName,jdbcType=VARCHAR}, </if>
            <if test="logoPicId!= null">  logo_pic_id = #{logoPicId,jdbcType=INTEGER}, </if>
            <if test="coverResIds!= null">  cover_res_ids = #{coverResIds,jdbcType=VARCHAR}, </if>
            <if test="coverResType!= null">  cover_res_type = #{coverResType,jdbcType=INTEGER}, </if>
            <if test="introducedFileId!= null">  introduced_file_id = #{introducedFileId,jdbcType=INTEGER}, </if>
            <if test="releasePlatformValues!= null">  release_platform_values = #{releasePlatformValues,jdbcType=INTEGER}, </if>
            <if test="displayStatus!= null">  display_status = #{displayStatus,jdbcType=INTEGER}, </if>
            <if test="visitCount!= null">  visit_count = #{visitCount,jdbcType=INTEGER}, </if>
            <if test="praiseRate!= null">  praise_rate = #{praiseRate,jdbcType=DOUBLE}, </if>
            <if test="sysCode!= null">  sys_code = #{sysCode,jdbcType=VARCHAR}, </if>
            <if test="creator!= null">  creator = #{creator,jdbcType=VARCHAR}, </if>
            <if test="gmtCreate!= null">  gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}, </if>
            <if test="modifier!= null">  modifier = #{modifier,jdbcType=VARCHAR}, </if>
            <if test="gmtModified!= null">  gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}, </if>
            <if test="isDeleted!= null">  is_deleted = #{isDeleted,jdbcType=INTEGER}, </if>
            <if test="remark!= null">  remark = #{remark,jdbcType=VARCHAR}, </if>
            <if test="longitude!= null">  longitude = #{longitude,jdbcType=DOUBLE}, </if>
            <if test="latitude!= null">  latitude = #{latitude,jdbcType=DOUBLE}, </if>
            <if test="workingYears!= null">working_years = #{workingYears}, </if>
            <if test="decorationPriceStart!= null">decoration_price_start = #{decorationPriceStart}, </if>
            <if test="decorationPriceEnd!= null">decoration_price_end = #{decorationPriceEnd}, </if>
            <if test="decorationType!= null">decoration_type = #{decorationType}, </if>
            design_fee_starting = #{designFeeStarting,jdbcType=DOUBLE},
            design_fee_ending = #{designFeeEnding,jdbcType=DOUBLE},
            <if test="isBlacklist !=null ">is_blacklist = #{isBlacklist,jdbcType=INTEGER}</if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <!--逻辑删除店铺-->
    <update id="deleteShop" parameterType="com.sandu.api.shop.model.CompanyShop" >
        UPDATE
            company_shop
        SET
            is_deleted= 1,
            modifier = #{modifier,jdbcType=VARCHAR},
            gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}
        WHERE
            id=#{id,javaType=INTEGER}
    </update>

    <update id="deleteShopById">
        UPDATE
            company_shop
        SET
            is_deleted= 1,
            modifier = #{loginName,jdbcType=VARCHAR},
            gmt_modified = now()
        WHERE id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <!--通过Id查询店铺信息-->
    <select id="getShopById" parameterType="java.lang.Integer" resultType="com.sandu.api.shop.model.CompanyShop">
        SELECT
          <include refid="All_Column_List"/>
        FROM
          company_shop
        WHERE
          id=#{shopId,jdbcType=INTEGER}
          AND is_deleted = 0
    </select>

    <!--查询条件下的店铺数量-->
    <select id="findCount" parameterType="com.sandu.api.shop.model.po.ShopPO" resultType="java.lang.Integer">
        SELECT
          count(id)
        FROM company_shop WHERE 1=1
        <if test="companyId != null">
            <choose>
                <when test="companyType != null and companyType == 'true'">
                    and company_pid = #{companyId,jdbcType=INTEGER}
                    and company_id != #{companyId,jdbcType=INTEGER}
                </when>
                <otherwise>
                    and company_id = #{companyId,jdbcType=INTEGER}
                </otherwise>
            </choose>
        </if>
        <if test="shopCode != null and shopCode != ''">
            AND shop_code LIKE CONCAT(CONCAT('%',#{shopCode,jdbcType=VARCHAR}),'%')
        </if>
        <if test="shopName != null and shopName != ''">
            AND shop_name LIKE CONCAT(CONCAT('%',#{shopName,jdbcType=VARCHAR}),'%')
        </if>
        <if test="contactName != null and contactName != ''">
            AND contact_name LIKE CONCAT(CONCAT('%',#{contactName,jdbcType=VARCHAR}),'%')
        </if>
        <if test="contactPhone != null and contactPhone != ''">
            AND contact_phone LIKE CONCAT(CONCAT('%',#{contactPhone,jdbcType=VARCHAR}),'%')
        </if>
        <if test="provinceCode != null and provinceCode != ''">
            AND province_code = #{provinceCode,jdbcType=VARCHAR}
        </if>
        <if test="cityCode != null and cityCode != ''">
            AND city_code = #{cityCode,jdbcType=VARCHAR}
        </if>
        <if test="areaCode != null and areaCode != ''">
            AND area_code = #{areaCode,jdbcType=VARCHAR}
        </if>
        <if test="streetCode != null and streetCode != ''">
            AND street_code = #{streetCode,jdbcType=VARCHAR}
        </if>
        <if test="userId != null and userId != ''">
            AND ((user_id = #{userId}
            AND shop_type = 2) or shop_type = 1)
        </if>
        <if test="isBlacklist != null ">
            AND is_blacklist = #{isBlacklist}
        </if>
        AND is_deleted = 0
    </select>

    <!--查询条件下的店铺列表-->
    <select id="findList" parameterType="com.sandu.api.shop.model.po.ShopPO" resultType="com.sandu.api.shop.model.CompanyShop">
        SELECT
          <include refid="All_Column_List"/>
          ,shop_type
        FROM company_shop WHERE 1=1
        <if test="companyId != null">
            <choose>
                <when test="companyType != null and companyType == 'true'">
                    and company_pid = #{companyId,jdbcType=INTEGER}
                    and company_id != #{companyId,jdbcType=INTEGER}
                </when>
                <otherwise>
                    and company_id = #{companyId,jdbcType=INTEGER}
                </otherwise>
            </choose>
        </if>
        <if test="shopCode != null and shopCode != ''">
            AND shop_code LIKE CONCAT(CONCAT('%',#{shopCode,jdbcType=VARCHAR}),'%')
        </if>
        <if test="shopName != null and shopName != ''">
            AND shop_name LIKE CONCAT(CONCAT('%',#{shopName,jdbcType=VARCHAR}),'%')
        </if>
        <if test="contactName != null and contactName != ''">
            AND contact_name LIKE CONCAT(CONCAT('%',#{contactName,jdbcType=VARCHAR}),'%')
        </if>
        <if test="contactPhone != null and contactPhone != ''">
            AND contact_phone LIKE CONCAT(CONCAT('%',#{contactPhone,jdbcType=VARCHAR}),'%')
        </if>
        <if test="provinceCode != null and provinceCode != ''">
            AND province_code = #{provinceCode,jdbcType=VARCHAR}
        </if>
        <if test="cityCode != null and cityCode != ''">
            AND city_code = #{cityCode,jdbcType=VARCHAR}
        </if>
        <if test="areaCode != null and areaCode != ''">
            AND area_code = #{areaCode,jdbcType=VARCHAR}
        </if>
        <if test="streetCode != null and streetCode != ''">
            AND street_code = #{streetCode,jdbcType=VARCHAR}
        </if>
        <if test="userId != null and userId != ''">
            AND ((user_id = #{userId}
            AND shop_type = 2) or shop_type = 1)
        </if>
        <if test="isBlacklist != null ">
            AND is_blacklist = #{isBlacklist}
        </if>
        AND is_deleted = 0
        ORDER BY shop_type,id DESC
        limit #{start},#{limit}
    </select>

    <!--通过用户id和店铺类型查询店铺信息-->
    <!--品牌馆去掉用户过滤条件-->
    <select id="findBrandPavilion" resultType="com.sandu.api.shop.model.CompanyShop">
        SELECT
          <include refid="All_Column_List"/>
        FROM
          company_shop
        WHERE
        company_id = #{companyId}
        and business_type = #{businessType}
        AND is_deleted = 0
        limit 1;
    </select>

    <select id="checkShopName" resultType="java.lang.Integer" >
        SELECT
          count(id)
        FROM company_shop WHERE 1=1
        <if test="shopName != null and shopName != ''">
            and shop_name = #{shopName,jdbcType=VARCHAR}
        </if>
        <if test="shopId != null and shopId > 0">
            and id <![CDATA[ <> #{shopId} ]]>
        </if>
        and is_deleted = 0
    </select>

    <update id="updateShopCategoryByCompanyId" parameterType="com.sandu.api.shop.model.CompanyShop">
        update company_shop
         SET
            category_ids = #{categoryIds},
            first_category_ids = #{firstCategoryIds},
            gmt_modified=#{gmtModified}
        WHERE
          company_id = #{companyId}
          AND is_deleted = 0
    </update>

    <select id="getShopListByUserId" parameterType="java.lang.Long" resultType="com.sandu.api.shop.model.CompanyShop">
        SELECT
        <include refid="All_Column_List"/>
        FROM company_shop WHERE 1=1
        AND is_deleted = 0
        AND user_id = #{userId}
    </select>

    <update id="deleteShopByUserId" >
        UPDATE company_shop
        SET
            is_deleted = 1,
            modifier = #{loginUserName},
            gmt_modified = NOW()
        WHERE user_id = #{userId}
    </update>
    <select id="checkCompanyShop" resultType="java.lang.Integer">
        select
          count(1)
        from
          company_shop
        where
          company_id = #{companyId}
          and shop_type = #{shopType}
          and is_deleted = 0
    </select>

    <update id="setRelease" parameterType="com.sandu.api.shop.model.CompanyShop">
        UPDATE company_shop
        SET
        release_platform_values = #{releasePlatformValues},
        modifier = #{modifier},
        gmt_modified = #{gmtModified}
        WHERE id = #{id}
    </update>
    <select id="getShopDesignList" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select
            id
        from
            company_shop_design_plan
        where
            shop_id = #{shopId}
            <if test="isDeleted != null">
               and is_deleted = #{isDeleted}
            </if>
    </select>

    <select id="selectShopByUserIds" resultType="com.sandu.api.shop.model.CompanyShop">
        SELECT
           *
        FROM
           company_shop
        WHERE
           is_deleted = 0 AND
           user_id in
           <foreach collection="userIds" open="(" item="userId" close=")" separator=",">
               #{userId}
           </foreach>
    </select>

    <select id="listShopByCompanyId" resultType="com.sandu.api.shop.model.CompanyShop">
      select id, shop_name, company_id from company_shop where is_deleted = 0 and company_id = #{companyId}
    </select>

    <update id="delCompanyShopByUserIds">
        update
           company_shop
           set
           is_deleted = 1,
           modifier = #{loginName}
           WHERE
           is_deleted = 0 AND
           user_id  in
           <foreach collection="userIds" open="(" separator="," close=")" item="userId">
               #{userId}
           </foreach>
    </update>
</mapper>