<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.goods.dao.BaseGoodsSPUMapper" >
  <resultMap id="BaseResultMap" type="com.sandu.api.goods.model.BaseGoodsSPU" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="spu_code" property="spuCode" jdbcType="VARCHAR" />
    <result column="company_id" property="companyId" jdbcType="INTEGER" />
    <result column="product_name" property="productName" jdbcType="VARCHAR" />
    <result column="product_model_number" property="productModelNumber" jdbcType="VARCHAR" />
    <result column="small_type_mark" property="smallTypeMark" jdbcType="VARCHAR" />
    <result column="product_desc" property="productDesc" jdbcType="VARCHAR" />
    <result column="spu_name" property="spuName" jdbcType="VARCHAR" />
    <result column="purhase_limitation" property="purhaseLimitation" jdbcType="INTEGER" />
    <result column="transport_id" property="transportId" jdbcType="INTEGER" />
    <result column="fix_transport_expense" property="fixTransportExpense" jdbcType="DECIMAL" />
    <result column="integral" property="integral" jdbcType="INTEGER" />
    <result column="is_presell" property="isPresell" jdbcType="INTEGER" />
    <result column="presell_deadline" property="presellDeadline" jdbcType="TIMESTAMP" />
    <result column="balance_payment_starttime" property="balancePaymentStarttime" jdbcType="TIMESTAMP" />
    <result column="balance_payment_endtime" property="balancePaymentEndtime" jdbcType="TIMESTAMP" />
    <result column="deposit" property="deposit" jdbcType="DECIMAL" />
    <result column="delivery_time" property="deliveryTime" jdbcType="INTEGER" />
    <result column="pic_id" property="picId" jdbcType="INTEGER" />
    <result column="pic_ids" property="picIds" jdbcType="VARCHAR" />
    <result column="total_inventory" property="totalInventory" jdbcType="INTEGER" />
    <result column="get_time" property="getTime" jdbcType="TIMESTAMP" />
    <result column="is_putaway" property="isPutaway" jdbcType="INTEGER" />
    <result column="creator" property="creator" jdbcType="VARCHAR" />
    <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP" />
    <result column="modifier" property="modifier" jdbcType="VARCHAR" />
    <result column="gmt_modified" property="gmtModified" jdbcType="TIMESTAMP" />
    <result column="is_deleted" property="isDeleted" jdbcType="INTEGER" />
    <result column="spu_introduce" property="spuIntroduce" jdbcType="LONGVARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, spu_code, company_id, product_name, product_model_number, small_type_mark, product_desc,
    spu_name, purhase_limitation, transport_id, fix_transport_expense, integral, is_presell, 
    presell_deadline, balance_payment_starttime, balance_payment_endtime, deposit, delivery_time, 
    pic_id, pic_ids, total_inventory, get_time, is_putaway, creator, gmt_create, modifier, gmt_modified,
    is_deleted, spu_introduce
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from base_goods_spu
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="getByIds" resultMap="BaseResultMap" parameterType="java.util.List" >
    select
      <include refid="Base_Column_List" />
    from
      base_goods_spu
    where id IN
      <foreach collection="list" item="id" index="index" open="(" separator="," close=")">
        #{id,jdbcType=INTEGER}
      </foreach>
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from base_goods_spu
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.sandu.api.goods.model.BaseGoodsSPU" >
    insert into base_goods_spu (id, spu_code, company_id, product_name,
      product_model_number, small_type_mark,
      product_desc, spu_name, purhase_limitation, 
      transport_id, fix_transport_expense, integral, 
      is_presell, presell_deadline, balance_payment_starttime, 
      balance_payment_endtime, deposit, delivery_time, 
      pic_id, total_inventory, get_time, 
      is_putaway, creator, gmt_create, 
      modifier, gmt_modified, is_deleted, 
      spu_introduce)
    values (#{id,jdbcType=INTEGER},  #{companyId,jdbcType=INTEGER}, #{spuCode,jdbcType=VARCHAR}, #{productName,jdbcType=VARCHAR},
      #{productModelNumber,jdbcType=VARCHAR}, #{smallTypeMark,jdbcType=VARCHAR},
      #{productDesc,jdbcType=VARCHAR}, #{spuName,jdbcType=VARCHAR}, #{purhaseLimitation,jdbcType=INTEGER}, 
      #{transportId,jdbcType=INTEGER}, #{fixTransportExpense,jdbcType=DECIMAL}, #{integral,jdbcType=INTEGER}, 
      #{isPresell,jdbcType=INTEGER}, #{presellDeadline,jdbcType=TIMESTAMP}, #{balancePaymentStarttime,jdbcType=TIMESTAMP}, 
      #{balancePaymentEndtime,jdbcType=TIMESTAMP}, #{deposit,jdbcType=DECIMAL}, #{deliveryTime,jdbcType=INTEGER}, 
      #{picId,jdbcType=INTEGER}, #{totalInventory,jdbcType=INTEGER}, #{getTime,jdbcType=TIMESTAMP}, 
      #{isPutaway,jdbcType=INTEGER}, #{creator,jdbcType=VARCHAR}, #{gmtCreate,jdbcType=TIMESTAMP}, 
      #{modifier,jdbcType=VARCHAR}, #{gmtModified,jdbcType=TIMESTAMP}, #{isDeleted,jdbcType=INTEGER}, 
      #{spuIntroduce,jdbcType=LONGVARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.sandu.api.goods.model.BaseGoodsSPU" >
    insert into base_goods_spu
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="companyId != null">
        company_id
      </if>
      <if test="spuCode != null" >
        spu_code,
      </if>
      <if test="productName != null" >
        product_name,
      </if>
      <if test="productModelNumber != null" >
        product_model_number,
      </if>
      <if test="smallTypeMark != null" >
        small_type_mark,
      </if>
      <if test="productDesc != null" >
        product_desc,
      </if>
      <if test="spuName != null" >
        spu_name,
      </if>
      <if test="purhaseLimitation != null" >
        purhase_limitation,
      </if>
      <if test="transportId != null" >
        transport_id,
      </if>
      <if test="fixTransportExpense != null" >
        fix_transport_expense,
      </if>
      <if test="integral != null" >
        integral,
      </if>
      <if test="isPresell != null" >
        is_presell,
      </if>
      <if test="presellDeadline != null" >
        presell_deadline,
      </if>
      <if test="balancePaymentStarttime != null" >
        balance_payment_starttime,
      </if>
      <if test="balancePaymentEndtime != null" >
        balance_payment_endtime,
      </if>
      <if test="deposit != null" >
        deposit,
      </if>
      <if test="deliveryTime != null" >
        delivery_time,
      </if>
      <if test="picId != null" >
        pic_id,
      </if>
      <if test="totalInventory != null" >
        total_inventory,
      </if>
      <if test="getTime != null" >
        get_time,
      </if>
      <if test="isPutaway != null" >
        is_putaway,
      </if>
      <if test="creator != null" >
        creator,
      </if>
      <if test="gmtCreate != null" >
        gmt_create,
      </if>
      <if test="modifier != null" >
        modifier,
      </if>
      <if test="gmtModified != null" >
        gmt_modified,
      </if>
      <if test="isDeleted != null" >
        is_deleted,
      </if>
      <if test="spuIntroduce != null" >
        spu_introduce,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="companyId != null" >
        #{companyId,jdbcType=INTEGER},
      </if>
      <if test="spuCode != null" >
        #{spuCode,jdbcType=VARCHAR},
      </if>
      <if test="productName != null" >
        #{productName,jdbcType=VARCHAR},
      </if>
      <if test="productModelNumber != null" >
        #{productModelNumber,jdbcType=VARCHAR},
      </if>
      <if test="smallTypeMark != null" >
        #{smallTypeMark,jdbcType=VARCHAR},
      </if>
      <if test="productDesc != null" >
        #{productDesc,jdbcType=VARCHAR},
      </if>
      <if test="spuName != null" >
        #{spuName,jdbcType=VARCHAR},
      </if>
      <if test="purhaseLimitation != null" >
        #{purhaseLimitation,jdbcType=INTEGER},
      </if>
      <if test="transportId != null" >
        #{transportId,jdbcType=INTEGER},
      </if>
      <if test="fixTransportExpense != null" >
        #{fixTransportExpense,jdbcType=DECIMAL},
      </if>
      <if test="integral != null" >
        #{integral,jdbcType=INTEGER},
      </if>
      <if test="isPresell != null" >
        #{isPresell,jdbcType=INTEGER},
      </if>
      <if test="presellDeadline != null" >
        #{presellDeadline,jdbcType=TIMESTAMP},
      </if>
      <if test="balancePaymentStarttime != null" >
        #{balancePaymentStarttime,jdbcType=TIMESTAMP},
      </if>
      <if test="balancePaymentEndtime != null" >
        #{balancePaymentEndtime,jdbcType=TIMESTAMP},
      </if>
      <if test="deposit != null" >
        #{deposit,jdbcType=DECIMAL},
      </if>
      <if test="deliveryTime != null" >
        #{deliveryTime,jdbcType=INTEGER},
      </if>
      <if test="picId != null" >
        #{picId,jdbcType=INTEGER},
      </if>
      <if test="totalInventory != null" >
        #{totalInventory,jdbcType=INTEGER},
      </if>
      <if test="getTime != null" >
        #{getTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isPutaway != null" >
        #{isPutaway,jdbcType=INTEGER},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null" >
        #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        #{isDeleted,jdbcType=INTEGER},
      </if>
      <if test="spuIntroduce != null" >
        #{spuIntroduce,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.sandu.api.goods.model.BaseGoodsSPU" >
    update base_goods_spu
    <set >
      <if test="companyId != null">
        company_id = #{companyId,jdbcType=INTEGER},
      </if>
      <if test="spuCode != null" >
        spu_code = #{spuCode,jdbcType=VARCHAR},
      </if>
      <if test="productName != null" >
        product_name = #{productName,jdbcType=VARCHAR},
      </if>
      <if test="productModelNumber != null" >
        product_model_number = #{productModelNumber,jdbcType=VARCHAR},
      </if>
      <if test="smallTypeMark != null" >
        small_type_mark = #{smallTypeMark,jdbcType=VARCHAR},
      </if>
      <if test="productDesc != null" >
        product_desc = #{productDesc,jdbcType=VARCHAR},
      </if>
      <if test="spuName != null" >
        spu_name = #{spuName,jdbcType=VARCHAR},
      </if>
      <if test="purhaseLimitation != null" >
        purhase_limitation = #{purhaseLimitation,jdbcType=INTEGER},
      </if>
      <if test="transportId != null" >
        transport_id = #{transportId,jdbcType=INTEGER},
      </if>
      <if test="fixTransportExpense != null" >
        fix_transport_expense = #{fixTransportExpense,jdbcType=DECIMAL},
      </if>
      <if test="integral != null" >
        integral = #{integral,jdbcType=INTEGER},
      </if>
      <if test="isPresell != null" >
        is_presell = #{isPresell,jdbcType=INTEGER},
      </if>
      <if test="presellDeadline != null" >
        presell_deadline = #{presellDeadline,jdbcType=TIMESTAMP},
      </if>
      <if test="balancePaymentStarttime != null" >
        balance_payment_starttime = #{balancePaymentStarttime,jdbcType=TIMESTAMP},
      </if>
      <if test="balancePaymentEndtime != null" >
        balance_payment_endtime = #{balancePaymentEndtime,jdbcType=TIMESTAMP},
      </if>
      <if test="deposit != null" >
        deposit = #{deposit,jdbcType=DECIMAL},
      </if>
      <if test="deliveryTime != null" >
        delivery_time = #{deliveryTime,jdbcType=INTEGER},
      </if>
      <if test="picId != null" >
        pic_id = #{picId,jdbcType=INTEGER},
      </if>
      <if test="totalInventory != null" >
        total_inventory = #{totalInventory,jdbcType=INTEGER},
      </if>
      <if test="getTime != null" >
        get_time = #{getTime,jdbcType=TIMESTAMP},
      </if>
      <if test="isPutaway != null" >
        is_putaway = #{isPutaway,jdbcType=INTEGER},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="true" >
        gmt_modified = CURRENT_TIMESTAMP ,
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=INTEGER},
      </if>
      <if test="spuIntroduce != null" >
        spu_introduce = #{spuIntroduce,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sandu.api.goods.model.BaseGoodsSPU" >
    update base_goods_spu
    set company_id = #{companyId,jdbcType=INTEGER},
      spu_code = #{spuCode,jdbcType=VARCHAR},
      product_name = #{productName,jdbcType=VARCHAR},
      product_model_number = #{productModelNumber,jdbcType=VARCHAR},
      small_type_mark = #{smallTypeMark,jdbcType=VARCHAR},
      product_desc = #{productDesc,jdbcType=VARCHAR},
      spu_name = #{spuName,jdbcType=VARCHAR},
      purhase_limitation = #{purhaseLimitation,jdbcType=INTEGER},
      transport_id = #{transportId,jdbcType=INTEGER},
      fix_transport_expense = #{fixTransportExpense,jdbcType=DECIMAL},
      integral = #{integral,jdbcType=INTEGER},
      is_presell = #{isPresell,jdbcType=INTEGER},
      presell_deadline = #{presellDeadline,jdbcType=TIMESTAMP},
      balance_payment_starttime = #{balancePaymentStarttime,jdbcType=TIMESTAMP},
      balance_payment_endtime = #{balancePaymentEndtime,jdbcType=TIMESTAMP},
      deposit = #{deposit,jdbcType=DECIMAL},
      delivery_time = #{deliveryTime,jdbcType=INTEGER},
      pic_id = #{picId,jdbcType=INTEGER},
      total_inventory = #{totalInventory,jdbcType=INTEGER},
      get_time = #{getTime,jdbcType=TIMESTAMP},
      is_putaway = #{isPutaway,jdbcType=INTEGER},
      creator = #{creator,jdbcType=VARCHAR},
      gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      modifier = #{modifier,jdbcType=VARCHAR},
      gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      is_deleted = #{isDeleted,jdbcType=INTEGER},
      spu_introduce = #{spuIntroduce,jdbcType=LONGVARCHAR}
    where id = #{id,jdbcType=INTEGER}
  </update>

  <resultMap id="getGoodsListResultMap" type="com.sandu.api.goods.output.GoodsVO" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="spu_code" property="spuCode" jdbcType="VARCHAR" />
    <result column="spu_name" property="spuName" jdbcType="VARCHAR" />
    <result column="is_presell" property="isPresell" jdbcType="INTEGER" />
    <result column="pic_path" property="pic" jdbcType="VARCHAR" />
    <result column="total_inventory" property="totalInventory" jdbcType="INTEGER" />
    <result column="is_putaway" property="isPutaway" jdbcType="INTEGER" />
    <result column="maxPrice" property="maxPrice" jdbcType="DECIMAL" />
    <result column="minPrice" property="minPrice" jdbcType="DECIMAL" />
    <result column="is_special_offer" property="isSpecialOffer" jdbcType="INTEGER" />
    <result column="small_type" property="smallType" jdbcType="VARCHAR" />
    <result column="big_type" property="bigType" jdbcType="VARCHAR" />
    <result column="windows_u3dmodel_id" property="modelId" jdbcType="INTEGER"/>
    <result column="material_pic_ids" property="materialIds" jdbcType="VARCHAR"/>
  </resultMap>

  <select id="getGoodsList" resultMap="getGoodsListResultMap" parameterType="com.sandu.api.goods.model.po.GoodsListQueryPO" >
    select
        t1.id
        ,t1.spu_code
        ,t1.spu_name
        ,t4.pic_path
        ,max(t5.price) maxPrice
        ,min(t5.price) minPrice
        ,sum(t5.inventory) total_inventory
        ,t9.is_presell
        ,t9.is_special_offer
        ,t1.is_putaway
        ,t6.name small_type
        ,t7.name big_type
        ,t2.windows_u3dmodel_id
        ,t2.material_pic_ids
    from
        base_goods_spu t1
        inner join base_product t2 on t2.goods_spu_id = t1.id AND t2.goods_spu_id != '' AND t2.is_deleted = 0 AND t2.putaway_state = 3 <if test="companyId != null">AND t2.company_id = #{companyId} </if>
        inner join platform2c_product_rel rel on rel.product_id = t2.id AND rel.putaway_state = 1 and rel.allot_state = 1 and rel.is_deleted = 0
        inner join base_platform platform on platform.id = rel.platform_id AND platform.platform_code = 'miniProgram'
        left join res_pic t4 on t4.id = t1.pic_id
        left join spu_sale_info t9 on t9.spu_id = t1.id
        left join base_goods_sku t5 on t5.product_id = t2.id
        left join sys_dictionary t6 on t6.valuekey = t1.small_type_mark
        left join sys_dictionary t7 on t7.valuekey = t6.type
    where
        t1.is_deleted = 0
        <if test="companyId != null">AND t1.company_id = #{companyId} </if>
        <if test="typeCode != null"> AND t7.valuekey = #{typeCode}</if>
        <if test="childTypeCode != null"> AND t6.valuekey = #{childTypeCode}</if>
        <if test="isPutaway != null"> AND t1.is_putaway = #{isPutaway}</if>
        <if test="isPresell != null">
            <if test="isPresell eq 1"> AND t9.is_presell = 1</if>
            <if test="isPresell eq 0"> AND t9.is_presell <![CDATA[ <> ]]> 1</if>
        </if>
        <if test="spuName != null"> AND t1.spu_name LIKE #{spuName}</if>
        <if test="spuCode != null"> AND t1.spu_code LIKE #{spuCode}</if>
        <if test="productModelNumber != null"> AND t2.product_model_number LIKE #{productModelNumber}</if>
        <if test="hasModelOrMaterial != null">
            <if test="hasModelOrMaterial eq 1"> AND (t2.windows_u3dmodel_id &gt; 0 OR (t2.material_pic_ids is not null and t2.material_pic_ids != '-1' and t2.material_pic_ids != ''))</if>
            <if test="hasModelOrMaterial eq 0">
                AND (t2.windows_u3dmodel_id &lt;= 0 or t2.windows_u3dmodel_id is null)
                AND (t2.material_pic_ids = '-1' or t2.material_pic_ids is null or t2.material_pic_ids = '')
            </if>
        </if>
    GROUP BY
        t1.id
    ORDER BY t1.id desc
    <if test="limit != null and start != null"> limit #{start},#{limit} </if>
  </select>
  
  <select id="getGoodsListOld" resultMap="getGoodsListResultMap" parameterType="com.sandu.api.goods.model.po.GoodsListQueryPO" >
    select
        t1.id
        ,t1.spu_code
        ,t1.spu_name
        ,t4.pic_path
        ,max(t5.price) maxPrice
        ,min(t5.price) minPrice
        ,sum(t5.inventory) total_inventory
        ,t9.is_presell
        ,t9.is_special_offer
        ,t1.is_putaway
        ,t6.name small_type
        ,t7.name big_type
    from
        base_goods_spu t1
         INNER JOIN  base_product t2 FORCE INDEX (idx_spuId) ON t1.id = t2.goods_spu_id  AND t2.is_deleted = 0 <if test="companyId != null"> AND t2.company_id = #{companyId} </if> AND t2.putaway_state = 3 
 	     INNER JOIN platform2c_product_rel rel FORCE INDEX (uniqueProductIdAndPlatformId) 
        	on rel.product_id = t2.id AND rel.putaway_state = 1 and rel.allot_state = 1 and rel.is_deleted = 0  AND rel.platform_id = 14 
        left join res_pic t4 on t4.id = t1.pic_id
        left join spu_sale_info t9 on t9.spu_id = t1.id
        left join base_goods_sku t5 on t5.product_id = t2.id
        left join sys_dictionary t6 on t6.valuekey = t1.small_type_mark
        left join sys_dictionary t7 on t7.valuekey = t6.type
    where
        t1.is_deleted = 0
        <if test="companyId != null">AND t1.company_id = #{companyId} </if>
        <if test="typeCode != null"> AND t7.valuekey = #{typeCode}</if>
        <if test="childTypeCode != null"> AND t6.valuekey = #{childTypeCode}</if>
        <if test="isPutaway != null"> AND t1.is_putaway = #{isPutaway}</if>
        <if test="isPresell != null">
            <if test="isPresell eq 1"> AND t9.is_presell = 1</if>
            <if test="isPresell eq 0"> AND t9.is_presell <![CDATA[ <> ]]> 1</if>
        </if>
        <if test="spuName != null"> AND t1.spu_name LIKE #{spuName}</if>
        <if test="spuCode != null"> AND t1.spu_code LIKE #{spuCode}</if>
        <if test="productModelNumber != null"> AND t2.product_model_number LIKE #{productModelNumber}</if>
    GROUP BY
        t1.id
    ORDER BY t1.id desc
    <if test="limit != null and start != null"> limit #{start},#{limit} </if>
  </select>

  <update id="goodsPutawayUp" parameterType="java.util.List" >
    update
      base_goods_spu
    set
      is_putaway = 1
      ,gmt_modified = CURRENT_TIMESTAMP
    where
      id IN
        <foreach collection="list" index="index" item="id" open="(" separator="," close=")">
          #{id}
        </foreach>
      AND is_putaway = 0
  </update>

  <update id="goodsPutawayDown" parameterType="java.util.List" >
    update
      base_goods_spu
    set
      is_putaway = 0
      ,gmt_modified = CURRENT_TIMESTAMP
    where
      id IN
        <foreach collection="list" index="index" item="id" open="(" separator="," close=")">
          #{id}
        </foreach>
      AND is_putaway = 1
  </update>

  <resultMap id="getGoodsTypeResultMap" type="com.sandu.api.goods.output.GoodsTypeVO">
    <result column="valuekey" property="typeCode" jdbcType="VARCHAR" />
    <result column="name" property="typeName" jdbcType="VARCHAR" />
    <collection property="childType" ofType="com.sandu.api.goods.output.GoodsTypeVO">
      <result column="child_valuekey" property="typeCode" jdbcType="VARCHAR" />
      <result column="child_name" property="typeName" jdbcType="VARCHAR" />
    </collection>
  </resultMap>

  <select id="getGoodsType" resultMap="getGoodsTypeResultMap" parameterType="java.lang.Integer">
    SELECT
      t4.valuekey valuekey
      ,t4.name name
      ,t3.valuekey child_valuekey
      ,t3.name child_name
    FROM
      ( select distinct
          t1.small_type_mark
        from
          base_goods_spu t1
          ,base_product t2
          ,base_platform platform
          ,platform2c_product_rel rel
        where
          t1.is_deleted = 0
          AND t2.is_deleted = 0
          <if test="_parameter != null">AND t1.company_id = #{_parameter} </if>
          <if test="_parameter != null">AND t2.company_id = #{_parameter} </if>
          AND t2.goods_spu_id = t1.id
          AND platform.platform_code = 'miniProgram'
          AND rel.platform_id = platform.id AND rel.product_id = t2.id
          AND rel.putaway_state = 1
      )t
      ,sys_dictionary t3
      ,sys_dictionary t4
    WHERE
      t3.valuekey = t.small_type_mark
      AND t4.valuekey = t3.type
  </select>


  <resultMap id="getGoodsDetailResultMap" type="com.sandu.api.goods.output.GoodsDetailVO" >
    <id column="id" property="spuId" jdbcType="INTEGER" />
    <result column="company_id" property="companyId" jdbcType="INTEGER" />
    <result column="product_desc" property="describe" jdbcType="VARCHAR" />
    <result column="spu_name" property="name" jdbcType="VARCHAR" />
    <result column="purhase_limitation" property="limitation" jdbcType="INTEGER" />
    <result column="fix_transport_expense" property="fixTransCost" jdbcType="DECIMAL" />
    <result column="is_presell" property="presell" jdbcType="INTEGER" />
    <result column="presell_deadline" property="presellDDL" jdbcType="TIMESTAMP" />
    <result column="balance_payment_starttime" property="payTailStarttime" jdbcType="TIMESTAMP" />
    <result column="balance_payment_endtime" property="payTailEndtime" jdbcType="TIMESTAMP" />
    <result column="deposit" property="earnest" jdbcType="DECIMAL" />
    <result column="delivery_presell" property="shipmentsPresell" jdbcType="INTEGER" />
    <result column="delivery_day" property="shipmentsDay" jdbcType="INTEGER" />
    <result column="delivery_date" property="shipmentsDate" jdbcType="TIMESTAMP" />
    <result column="total_inventory" property="totalRepertory" jdbcType="INTEGER" />
    <result column="pic_id" property="mainPicId" jdbcType="INTEGER" />
    <result column="pic_ids" property="picIds" jdbcType="VARCHAR" />
    <result column="is_special_offer" property="isSpeSell" jdbcType="INTEGER" />
  </resultMap>

  <select id="getGoodsDetail" resultMap="getGoodsDetailResultMap" parameterType="java.lang.Integer" >
    select
      t1.id
      ,t1.company_id
      ,t1.product_desc
      ,t1.spu_name
      ,t2.purhase_limitation
      ,t2.fix_transport_expense
      ,t2.is_presell
      ,t2.presell_deadline
      ,t2.balance_payment_starttime
      ,t2.balance_payment_endtime
      ,t2.deposit
      ,t2.delivery_presell
      ,t2.delivery_day
      ,t2.delivery_date
      ,t2.is_special_offer
      ,sum(t3.inventory) total_inventory
      ,t1.pic_id
      ,t1.pic_ids
    from
      base_goods_spu t1
      left join spu_sale_info t2 on t2.spu_id = t1.id
      left join base_goods_sku t3 on t3.spu_id = t1.id
    where
      t1.id = #{id,jdbcType=INTEGER}
  </select>

  <select id="getTotalCount" resultType="Integer" parameterType="com.sandu.api.goods.model.po.GoodsListQueryPO" >
    select
      count(1)
    from
      (
        select
            1
        from
            base_goods_spu t1
            inner join base_product t2 on t2.goods_spu_id = t1.id AND t2.goods_spu_id != '' AND t2.is_deleted = 0 AND t2.putaway_state = 3 <if test="companyId != null">AND t2.company_id = #{companyId} </if>
            inner join platform2c_product_rel rel on rel.product_id = t2.id AND rel.putaway_state = 1 and rel.allot_state = 1 and rel.is_deleted = 0
            inner join base_platform platform on platform.id = rel.platform_id AND platform.platform_code = 'miniProgram'
            <if test="isPresell != null">
              left join spu_sale_info t9 on t9.spu_id = t1.id
            </if>
        where
            t1.is_deleted = 0
            <if test="companyId != null">AND t1.company_id = #{companyId} </if>
            <if test="childTypeCode != null"> AND t1.small_type_mark = #{childTypeCode}</if>
            <if test="isPutaway != null"> AND t1.is_putaway = #{isPutaway}</if>
            <if test="isPresell != null">
              <if test="isPresell eq 1"> AND t9.is_presell = 1</if>
              <if test="isPresell eq 0"> AND t9.is_presell <![CDATA[ <> ]]> 1</if>
            </if>
            <if test="spuName != null"> AND t1.spu_name LIKE #{spuName}</if>
            <if test="spuCode != null"> AND t1.spu_code LIKE #{spuCode}</if>
            <if test="productModelNumber != null"> AND t2.product_model_number LIKE #{productModelNumber}</if>
            <if test="hasModelOrMaterial != null">
              <if test="hasModelOrMaterial eq 1"> AND (t2.windows_u3dmodel_id &gt; 0 OR (t2.material_pic_ids is not null and t2.material_pic_ids != '-1' and t2.material_pic_ids != ''))</if>
              <if test="hasModelOrMaterial eq 0">
                AND (t2.windows_u3dmodel_id &lt;= 0 or t2.windows_u3dmodel_id is null)
                AND (t2.material_pic_ids = '-1' or t2.material_pic_ids is null or t2.material_pic_ids = '')
              </if>
            </if>
        GROUP BY
            t1.id
        ORDER BY t1.id desc
        )tabb
  </select>
  
  <select id="getTotalCountOld" resultType="Integer" parameterType="com.sandu.api.goods.model.po.GoodsListQueryPO" >
    select
      count(1)
    from
      (
        select
            1
        from
            base_goods_spu t1
            INNER JOIN  base_product t2 FORCE INDEX (idx_spuId) ON t1.id = t2.goods_spu_id  AND t2.is_deleted = 0 <if test="companyId != null"> AND t2.company_id = #{companyId} </if> AND t2.putaway_state = 3
	 	    INNER JOIN platform2c_product_rel rel FORCE INDEX (uniqueProductIdAndPlatformId) 
	        	on rel.product_id = t2.id AND rel.putaway_state = 1 and rel.allot_state = 1 and rel.is_deleted = 0  AND rel.platform_id = 14 
            <if test="isPresell != null">
              left join spu_sale_info t9 on t9.spu_id = t1.id
            </if>
        where
            t1.is_deleted = 0
            <if test="companyId != null">AND t1.company_id = #{companyId} </if>
            <if test="childTypeCode != null"> AND t1.small_type_mark = #{childTypeCode}</if>
            <if test="isPutaway != null"> AND t1.is_putaway = #{isPutaway}</if>
            <if test="isPresell != null">
              <if test="isPresell eq 1"> AND t9.is_presell = 1</if>
              <if test="isPresell eq 0"> AND t9.is_presell <![CDATA[ <> ]]> 1</if>
            </if>
            <if test="spuName != null"> AND t1.spu_name LIKE #{spuName}</if>
            <if test="spuCode != null"> AND t1.spu_code LIKE #{spuCode}</if>
            <if test="productModelNumber != null"> AND t2.product_model_number LIKE #{productModelNumber}</if>
        GROUP BY
            t1.id
        ORDER BY t1.id desc
        )tabb
  </select>
  
  
  
  <update id="updateSpu" parameterType="com.sandu.api.goods.input.GoodsSPUAdd" >
    update base_goods_spu
    <set >
      <if test="describe != null" >
        product_desc = #{describe,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        spu_name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="true">
        pic_id = #{mainPicId},
      </if>
      <if test="true">
        pic_ids = #{picIds},
      </if>
      <if test="totalRepertory != null" >
        total_inventory = #{totalRepertory,jdbcType=INTEGER},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null" >
        gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{spuId,jdbcType=INTEGER}
  </update>
  <update id="updateSpuSaleInfo" parameterType="com.sandu.api.goods.input.GoodsSPUAdd" >
    update spu_sale_info
    <set >
      <if test="limitation != null" >
        purhase_limitation = #{limitation,jdbcType=INTEGER},
      </if>
      <if test="fixTransCost != null" >
        fix_transport_expense = #{fixTransCost,jdbcType=DECIMAL},
      </if>
      <if test="isSpeSell != null">
        is_special_offer = #{isSpeSell},
      </if>
      <if test="isSpeSell != null and isSpeSell == 0">
        special_main_page_state = 0,
      </if>
      <if test="presell != null" >
        is_presell = #{presell,jdbcType=INTEGER},
      </if>
      <if test="presell != null and presell == 0">
        presell_main_page_state = 0,
      </if>
      <if test="presellDDL != null" >
        presell_deadline = #{presellDDL,jdbcType=TIMESTAMP},
      </if>
      <if test="payTailStarttime != null" >
        balance_payment_starttime = #{payTailStarttime,jdbcType=TIMESTAMP},
      </if>
      <if test="payTailEndtime != null" >
        balance_payment_endtime = #{payTailEndtime,jdbcType=TIMESTAMP},
      </if>
      <if test="earnest != null" >
        deposit = #{earnest,jdbcType=DECIMAL},
      </if>
      <if test="shipmentsPresell != null" >
        delivery_presell = #{shipmentsPresell,jdbcType=INTEGER},
      </if>
      <if test="true" >
        delivery_day = #{shipmentsDay,jdbcType=INTEGER},
      </if>
      <if test="true" >
        delivery_date = #{shipmentsDate,jdbcType=INTEGER},
      </if>
      <if test="creator != null" >
        creator = #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null" >
        gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null" >
        modifier = #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null" >
        gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null" >
        is_deleted = #{isDeleted,jdbcType=INTEGER},
      </if>
    </set>
    where spu_id = #{spuId,jdbcType=INTEGER}
  </update>
  <insert id="insertSpuSaleInfo" parameterType="com.sandu.api.goods.input.GoodsSPUAdd" >
    insert into spu_sale_info
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="spuId != null">
        spu_id,
      </if>
      <if test="limitation != null">
        purhase_limitation,
      </if>
      <if test="fixTransCost != null">
        fix_transport_expense,
      </if>
      <if test="isSpeSell != null">
        is_special_offer,
      </if>
      <if test="presell != null">
        is_presell,
      </if>
      <if test="presellDDL != null">
        presell_deadline,
      </if>
      <if test="payTailStarttime != null">
        balance_payment_starttime,
      </if>
      <if test="payTailEndtime != null">
        balance_payment_endtime,
      </if>
      <if test="earnest != null">
        deposit,
      </if>
      <if test="shipmentsPresell != null">
        delivery_presell,
      </if>
      <if test="shipmentsDay != null">
        delivery_day,
      </if>
      <if test="shipmentsDate != null">
        delivery_date,
      </if>
      <if test="creator != null">
        creator,
      </if>
      <if test="gmtCreate != null">
        gmt_create,
      </if>
      <if test="modifier != null">
        modifier,
      </if>
      <if test="gmtModified != null">
        gmt_modified,
      </if>
      <if test="isDeleted != null">
        is_deleted,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="spuId != null">
        #{spuId,jdbcType=INTEGER},
      </if>
      <if test="limitation != null">
        #{limitation,jdbcType=INTEGER},
      </if>
      <if test="fixTransCost != null">
        #{fixTransCost,jdbcType=DECIMAL},
      </if>
      <if test="isSpeSell != null">
        #{isSpeSell,jdbcType=INTEGER},
      </if>
      <if test="presell != null">
        #{presell,jdbcType=INTEGER},
      </if>
      <if test="presellDDL != null">
        #{presellDDL,jdbcType=TIMESTAMP},
      </if>
      <if test="payTailStarttime != null">
        #{payTailStarttime,jdbcType=TIMESTAMP},
      </if>
      <if test="payTailEndtime != null">
        #{payTailEndtime,jdbcType=TIMESTAMP},
      </if>
      <if test="earnest != null">
        #{earnest,jdbcType=DECIMAL},
      </if>
      <if test="shipmentsPresell != null">
        #{shipmentsPresell,jdbcType=INTEGER},
      </if>
      <if test="shipmentsDay != null">
        #{shipmentsDay,jdbcType=INTEGER},
      </if>
      <if test="shipmentsDate != null">
        #{shipmentsDate,jdbcType=TIMESTAMP},
      </if>
      <if test="creator != null">
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="gmtCreate != null">
        #{gmtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="modifier != null">
        #{modifier,jdbcType=VARCHAR},
      </if>
      <if test="gmtModified != null">
        #{gmtModified,jdbcType=TIMESTAMP},
      </if>
      <if test="isDeleted != null">
        #{isDeleted,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
</mapper>

