<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.company.dao.CompanyDao">
    <!--<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>-->
    <!-- **插入定义** -->
    <insert id="saveCompany" parameterType="com.sandu.api.company.model.Company" useGeneratedKeys="true"
            keyProperty="id">
        insert into base_company
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="sysCode != null">
                sys_code,
            </if>
            <if test="companyCode != null">
                company_code,
            </if>
            <if test="companyName != null">
                company_name,
            </if>
            <if test="companyUrl != null">
                company_url,
            </if>
            <if test="companyDesc != null">
                company_desc,
            </if>
            <if test="companyAddress != null">
                company_address,
            </if>
            <if test="creator != null">
                creator,
            </if>
            <if test="gmtCreate != null">
                gmt_create,
            </if>
            <if test="modifier != null">
                modifier,
            </if>
            <if test="gmtModified != null">
                gmt_modified,
            </if>
            <if test="isDeleted != null">
                is_deleted,
            </if>
            <if test="att1 != null">
                att1,
            </if>
            <if test="att2 != null">
                att2,
            </if>
            <if test="att3 != null">
                att3,
            </if>
            <if test="att4 != null">
                att4,
            </if>
            <if test="att5 != null">
                att5,
            </if>
            <if test="att6 != null">
                att6,
            </if>
            <if test="dateAtt1 != null">
                date_att1,
            </if>
            <if test="dateAtt2 != null">
                date_att2,
            </if>
            <if test="companyLogo != null">
                company_logo,
            </if>
            <if test="numAtt2 != null">
                num_att2,
            </if>
            <if test="numAtt3 != null">
                num_att3,
            </if>
            <if test="numAtt4 != null">
                num_att4,
            </if>
            <if test="companyIdentify != null">
                company_identify,
            </if>
            <if test="industry != null">
                industry,
            </if>
            <if test="smallType != null">
                small_type,
            </if>
            <if test="numAtt1 != null">
                num_att1,
            </if>
            <if test="businessType != null">
                business_type,
            </if>
            <if test="companyDomainName != null">
                company_domain_name,
            </if>
            <if test="companyCustomerQq != null">
                company_customer_qq,
            </if>
            <if test="categoryIds != null">
                category_ids,
            </if>
            <if test="remark != null">
                remark,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=BIGINT},
            </if>
            <if test="sysCode != null">
                #{sysCode,jdbcType=VARCHAR},
            </if>
            <if test="companyCode != null">
                #{companyCode,jdbcType=VARCHAR},
            </if>
            <if test="companyName != null">
                #{companyName,jdbcType=VARCHAR},
            </if>
            <if test="companyUrl != null">
                #{companyUrl,jdbcType=VARCHAR},
            </if>
            <if test="companyDesc != null">
                #{companyDesc,jdbcType=VARCHAR},
            </if>
            <if test="companyAddress != null">
                #{companyAddress,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                #{isDeleted,jdbcType=INTEGER},
            </if>
            <if test="att1 != null">
                #{att1,jdbcType=VARCHAR},
            </if>
            <if test="att2 != null">
                #{att2,jdbcType=VARCHAR},
            </if>
            <if test="att3 != null">
                #{att3,jdbcType=VARCHAR},
            </if>
            <if test="att4 != null">
                #{att4,jdbcType=VARCHAR},
            </if>
            <if test="att5 != null">
                #{att5,jdbcType=VARCHAR},
            </if>
            <if test="att6 != null">
                #{att6,jdbcType=VARCHAR},
            </if>
            <if test="dateAtt1 != null">
                #{dateAtt1,jdbcType=TIMESTAMP},
            </if>
            <if test="dateAtt2 != null">
                #{dateAtt2,jdbcType=TIMESTAMP},
            </if>
            <if test="companyLogo != null">
                #{companyLogo,jdbcType=INTEGER},
            </if>
            <if test="numAtt2 != null">
                #{numAtt2,jdbcType=INTEGER},
            </if>
            <if test="numAtt3 != null">
                #{numAtt3,jdbcType=DECIMAL},
            </if>
            <if test="numAtt4 != null">
                #{numAtt4,jdbcType=DECIMAL},
            </if>
            <if test="companyIdentify != null">
                #{companyIdentify,jdbcType=VARCHAR},
            </if>
            <if test="industry != null">
                #{industry,jdbcType=INTEGER},
            </if>
            <if test="smallType != null">
                #{smallType,jdbcType=VARCHAR},
            </if>
            <if test="numAtt1 != null">
                #{numAtt1,jdbcType=INTEGER},
            </if>
            <if test="businessType != null">
                #{businessType,jdbcType=INTEGER},
            </if>
            <if test="companyDomainName != null">
                #{companyDomainName,jdbcType=VARCHAR},
            </if>
            <if test="companyCustomerQq != null">
                #{companyCustomerQq,jdbcType=VARCHAR},
            </if>
            <if test="categoryIds != null">
                #{categoryIds,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=LONGVARCHAR},
            </if>
        </trim>
    </insert>

    <!-- **更新定义** -->
    <update id="updateCompany" parameterType="com.sandu.api.company.model.Company">
        update base_company
        <set>
            <if test="sysCode != null">
                sys_code = #{sysCode,jdbcType=VARCHAR},
            </if>
            <if test="companyCode != null">
                company_code = #{companyCode,jdbcType=VARCHAR},
            </if>
            <if test="companyName != null">
                company_name = #{companyName,jdbcType=VARCHAR},
            </if>
            <if test="companyUrl != null">
                company_url = #{companyUrl,jdbcType=VARCHAR},
            </if>
            <if test="companyDesc != null">
                company_desc = #{companyDesc,jdbcType=VARCHAR},
            </if>
            <if test="companyAddress != null">
                company_address = #{companyAddress,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                modifier = #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=INTEGER},
            </if>
            <if test="att1 != null">
                att1 = #{att1,jdbcType=VARCHAR},
            </if>
            <if test="att2 != null">
                att2 = #{att2,jdbcType=VARCHAR},
            </if>
            <if test="att3 != null">
                att3 = #{att3,jdbcType=VARCHAR},
            </if>
            <if test="att4 != null">
                att4 = #{att4,jdbcType=VARCHAR},
            </if>
            <if test="att5 != null">
                att5 = #{att5,jdbcType=VARCHAR},
            </if>
            <if test="att6 != null">
                att6 = #{att6,jdbcType=VARCHAR},
            </if>
            <if test="dateAtt1 != null">
                date_att1 = #{dateAtt1,jdbcType=TIMESTAMP},
            </if>
            <if test="dateAtt2 != null">
                date_att2 = #{dateAtt2,jdbcType=TIMESTAMP},
            </if>
            <if test="companyLogo != null">
                company_logo = #{companyLogo,jdbcType=INTEGER},
            </if>
            <if test="numAtt2 != null">
                num_att2 = #{numAtt2,jdbcType=INTEGER},
            </if>
            <if test="numAtt3 != null">
                num_att3 = #{numAtt3,jdbcType=DECIMAL},
            </if>
            <if test="numAtt4 != null">
                num_att4 = #{numAtt4,jdbcType=DECIMAL},
            </if>
            <if test="companyIdentify != null">
                company_identify = #{companyIdentify,jdbcType=VARCHAR},
            </if>
            <if test="industry != null">
                industry = #{industry,jdbcType=INTEGER},
            </if>
            <if test="smallType != null">
                small_type = #{smallType,jdbcType=VARCHAR},
            </if>
            <if test="numAtt1 != null">
                num_att1 = #{numAtt1,jdbcType=INTEGER},
            </if>
            <if test="businessType != null">
                business_type = #{businessType,jdbcType=INTEGER},
            </if>
            <if test="companyDomainName != null">
                company_domain_name = #{companyDomainName,jdbcType=VARCHAR},
            </if>
            <if test="companyCustomerQq != null">
                company_customer_qq = #{companyCustomerQq,jdbcType=VARCHAR},
            </if>
            <if test="categoryIds != null">
                category_ids = #{categoryIds,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=LONGVARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>

    <!-- **删除定义** -->
    <delete id="deleteCompanyById">
        DELETE FROM base_company
        WHERE id = #{id,jdbcType=INTEGER}
    </delete>

    <!-- **常量定义** -->
    <sql id="All_Column_List">
        id, sys_code, company_code, company_name, company_url, company_desc, company_address,
        creator, gmt_create, modifier, gmt_modified, is_deleted, att1, att2, att3, att4,
        att5, att6, date_att1, date_att2, company_logo, num_att2, num_att3, num_att4, company_identify,
        industry, small_type, num_att1, business_type, company_domain_name, company_customer_qq,
        category_ids,is_manage
    </sql>
    <!-- 批量查询字段 -->
    <sql id="Filter_Search_Field">
        id, company_code, company_name, industry, company_url, company_address, company_desc, company_identify
    </sql>

    <!-- **结果定义** -->
    <resultMap id="AllResultMap" type="com.sandu.api.company.model.Company">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="sys_code" property="sysCode" jdbcType="VARCHAR"/>
        <result column="company_code" property="companyCode" jdbcType="VARCHAR"/>
        <result column="company_name" property="companyName" jdbcType="VARCHAR"/>
        <result column="company_url" property="companyUrl" jdbcType="VARCHAR"/>
        <result column="company_desc" property="companyDesc" jdbcType="VARCHAR"/>
        <result column="company_address" property="companyAddress" jdbcType="VARCHAR"/>
        <result column="creator" property="creator" jdbcType="VARCHAR"/>
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP"/>
        <result column="modifier" property="modifier" jdbcType="VARCHAR"/>
        <result column="gmt_modified" property="gmtModified" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="att1" property="att1" jdbcType="VARCHAR"/>
        <result column="att2" property="att2" jdbcType="VARCHAR"/>
        <result column="att3" property="att3" jdbcType="VARCHAR"/>
        <result column="att4" property="att4" jdbcType="VARCHAR"/>
        <result column="att5" property="att5" jdbcType="VARCHAR"/>
        <result column="att6" property="att6" jdbcType="VARCHAR"/>
        <result column="date_att1" property="dateAtt1" jdbcType="TIMESTAMP"/>
        <result column="date_att2" property="dateAtt2" jdbcType="TIMESTAMP"/>
        <result column="company_logo" property="companyLogo" jdbcType="INTEGER"/>
        <result column="num_att2" property="numAtt2" jdbcType="INTEGER"/>
        <result column="num_att3" property="numAtt3" jdbcType="DOUBLE"/>
        <result column="num_att4" property="numAtt4" jdbcType="DOUBLE"/>
        <result column="company_identify" property="companyIdentify" jdbcType="VARCHAR"/>
        <result column="industry" property="industry" jdbcType="INTEGER"/>
        <result column="small_type" property="smallType" jdbcType="VARCHAR"/>
        <result column="num_att1" property="numAtt1" jdbcType="INTEGER"/>
        <result column="business_type" property="businessType" jdbcType="INTEGER"/>
        <result column="company_domain_name" property="companyDomainName" jdbcType="VARCHAR"/>
        <result column="company_customer_qq" property="companyCustomerQq" jdbcType="VARCHAR"/>
        <result column="category_ids" property="categoryIds" jdbcType="VARCHAR"/>
        <result column="is_manage" property="isManage" jdbcType="INTEGER"/>
    </resultMap>

    <!-- **查询定义** -->
    <!-- 按主键查询 -->
    <select id="getCompanyById" resultMap="AllResultMap">
        select
        <include refid="All_Column_List"/>
        from base_company
        where id = #{id,jdbcType=INTEGER}
    </select>

    <!-- 无条件查询 -->
    <select id="findAllCompany" resultMap="AllResultMap">
        select
        <include refid="Filter_Search_Field"/>
        from base_company
        where 1 = 1
        <if test="bizType !=null and bizType !=0">
            and business_type != 2 and business_type != 3
        </if>
    </select>

    <!-- 过滤查询 -->
    <select id="queryCompanyByCompanyInfo" resultMap="AllResultMap">
        select
        <include refid="Filter_Search_Field"/>
        from base_company
        WHERE 1=1
        <if test="industry !=  null ">
            AND industry =#{industry}
        </if>
        <if test="industry == null">
            <if test="companyName !=  null and companyName !=  ''   ">
                OR company_name LIKE CONCAT(CONCAT('%',#{companyName_,jdbcType=VARCHAR}),'%')
            </if>
            <if test="companyCode !=  null and companyCode !=  ''   ">
                OR companyCode LIKE CONCAT(CONCAT('%',#{companyCode,jdbcType=VARCHAR}),'%')
            </if>
        </if>
        <if test="order != null and  order !=''  ">
            order by ${order}
            <if test="orderWay != null and  orderWay !='' ">
                ${orderWay}
            </if>
        </if>
        <if test="orders != null and  orders !=''  ">order by #{orders}</if>
        <if test="order == null and  orders == null ">order by id desc</if>
    </select>
    <!-- 查询所有企业名和ID -->
    <select id="findAllCompanyNameAndId" resultMap="AllResultMap">
        SELECT
            DISTINCT
            (id),
            companyName
        FROM base_company
        WHERE is_deleted = 0;
    </select>

    <select id="getCompanyByBrandIds" resultType="com.sandu.api.company.model.bo.CompanyBrandBo">
        SELECT
        bb.id as brandId,
        bc.company_name as companyName
        FROM
        base_company bc
        LEFT JOIN base_brand bb ON bc.id = bb.company_id
        where bb.id in
        <foreach collection="list" open="(" separator="," close=")" item="brandId">
            #{brandId}
        </foreach>
    </select>

    <select id="getCompanyInfoById" resultType="com.sandu.api.company.model.bo.CompanyBO">
        SELECT
            bc.id,
            bc.company_code,
            bc.company_name,
            bc.company_domain_name,
            bc.company_customer_qq,
            bc.category_ids,
            bc.company_logo,
            GROUP_CONCAT(bb.brand_name) AS brands
        FROM
            base_company bc
            LEFT JOIN base_brand bb ON bc.id = bb.company_id
        WHERE
            bc.id = #{id}
    </select>

    <resultMap id="getCompanyIntroduceResultMap" type="com.sandu.api.company.model.bo.CompanyIntroduceBO">
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="pic_path" property="companyPicPath" jdbcType="VARCHAR"/>
        <result column="introduce_title" property="introduceTitle" jdbcType="VARCHAR"/>
        <result column="company_introduce" property="companyIntroduce" jdbcType="VARCHAR"/>
        <result column="pic_id" property="picId" jdbcType="INTEGER"/>
    </resultMap>

    <select id="getCompanyIntroduce" resultMap="getCompanyIntroduceResultMap" parameterType="java.lang.Integer">
        select
            t1.id
            ,t2.id pic_id
            ,t2.pic_path
            ,t1.company_introduce
            ,t1.introduce_title
        from
            base_company t1
            left join res_pic t2 on t2.id = t1.company_pic_id
        where
            t1.id = #{companyId}
    </select>

    <select id="listByIds" resultType="com.sandu.api.company.model.Company">
        select id,company_name
        from base_company
        where id in
        <foreach collection="companyIds" item="it" separator="," open="(" close=")">
            #{it}
        </foreach>
    </select>

    <select id="queryDistributor" resultType="com.sandu.api.company.model.Company">
       select
        <include refid="All_Column_List"/>
      from base_company
       where (area_code != '' or province_code != '' or city_code != '' or street_code != '')
       and business_type = 2
       and is_deleted = 0
       and pid in (select id from base_company where is_manage = 0 and is_deleted = 0)
    </select>
    <select id="queryDistributorByCompanyId" resultType="com.sandu.api.company.model.Company">
        select * from base_company
        where business_type = 2
        and is_deleted = 0
        and pid = #{companyId}
    </select>
    <select id="getCompanyNameById" resultType="com.sandu.api.company.model.Company">
        select company_name from base_company
        where id = #{companyId}
    </select>

    <update id="updateCompanyIntroduceById" parameterType="com.sandu.api.company.input.CompanyIntroduceUpdate">
        update base_company
        <set>
            <if test="companyPicId != null">
                company_pic_id = #{companyPicId},
            </if>
            <if test="introduceTitle != null">
                introduce_title = #{introduceTitle},
            </if>
            <if test="companyIntroduce != null">
                company_introduce = #{companyIntroduce},
            </if>
        </set>
        where id = #{companyId}
    </update>

    <select id="queryDealerByPid" resultMap="AllResultMap" parameterType="java.lang.Integer">
       select * from base_company
       where business_type = 2
       and is_deleted = 0
       and pid = #{pid,jdbcType = INTEGER}
    </select>
    <select id="getCompanyByIds" resultType="com.sandu.api.company.model.Company">
        select * from base_company
        where
        is_deleted = 0
        and
        id in
        <foreach collection="companyIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>


    <insert id="saveNewRichContext" parameterType="com.sandu.api.company.model.RichContext"  useGeneratedKeys="true" keyProperty="id">
        insert into common_rich_context_store
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="businessId!= null">business_id, </if>
            <if test="businessType!= null">business_type, </if>
            <if test="context!= null">rich_context, </if>
            <if test="creator!= null">creator, </if>
            <if test="gmtCreate!= null">gmt_create, </if>
            <if test="modifier!= null">modifier, </if>
            <if test="gmtModified!= null">gmt_modified, </if>
            <if test="isDeleted!= null">is_deleted, </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="businessId!= null">  #{businessId,jdbcType=INTEGER}, </if>
            <if test="businessType!= null">  #{businessType,jdbcType=INTEGER}, </if>
            <if test="context!= null">  #{context,jdbcType=INTEGER}, </if>
            <if test="creator!= null">  #{creator,jdbcType=VARCHAR}, </if>
            <if test="gmtCreate!= null">  #{gmtCreate,jdbcType=TIMESTAMP}, </if>
            <if test="modifier!= null">  #{modifier,jdbcType=VARCHAR}, </if>
            <if test="gmtModified!= null">  #{gmtModified,jdbcType=TIMESTAMP}, </if>
            <if test="isDeleted!= null">  #{isDeleted,jdbcType=INTEGER}, </if>
        </trim>
    </insert>

    <update id="updateRichContext" parameterType="com.sandu.api.company.model.RichContext">
        update common_rich_context_store
        <set>
            <if test="context!= null">  rich_context = #{context,jdbcType=VARCHAR}, </if>
            <if test="creator!= null">  creator = #{creator,jdbcType=VARCHAR}, </if>
            <if test="gmtCreate!= null">  gmt_create = #{gmtCreate,jdbcType=TIMESTAMP}, </if>
            <if test="modifier!= null">  modifier = #{modifier,jdbcType=VARCHAR}, </if>
            <if test="gmtModified!= null">  gmt_modified = #{gmtModified,jdbcType=TIMESTAMP}, </if>
            <if test="isDeleted!= null">  is_deleted = #{isDeleted,jdbcType=INTEGER}, </if>
        </set>
        where
        is_deleted = 0
        and
        business_id = #{businessId}
        and
        business_type = #{businessType}
    </update>


    <select id="getRichContext" parameterType="com.sandu.api.company.model.RichContext" resultType="com.sandu.api.company.model.RichContext">
        select id AS id,
               business_id AS businessId,
               business_type AS businessType,
               rich_context  AS context
        from common_rich_context_store
        where
        is_deleted = 0
        and
        business_id = #{businessId}
        and
        business_type = #{businessType}
    </select>

    <select id="getCompanyMiniProgramConfigByCompanyId" resultType="com.sandu.api.company.model.CompanyMiniProgramConfig" parameterType="java.lang.Integer">
        select
            id AS id,
            app_id AS appId,
            company_id AS companyId
        from base_company_mini_program_config
        where is_deleted = 0
        and company_id = #{companyId,jdbcType = INTEGER}
    </select>

</mapper>
