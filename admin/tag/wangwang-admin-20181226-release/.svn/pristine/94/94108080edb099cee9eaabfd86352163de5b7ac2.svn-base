<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.basewaterjet.dao.BasewaterjetMapper">
    <resultMap id="BaseResultMap" type="com.sandu.api.basewaterjet.model.Basewaterjet">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="id" jdbcType="INTEGER" property="id"/>
        <result column="template_code" jdbcType="VARCHAR" property="templateCode"/>
        <result column="template_name" jdbcType="VARCHAR" property="templateName"/>
        <result column="brand_id" jdbcType="INTEGER" property="brandId"/>
        <result column="template_length" jdbcType="INTEGER" property="templateLength"/>
        <result column="template_width" jdbcType="INTEGER" property="templateWidth"/>
        <result column="template_file_id" jdbcType="INTEGER" property="templateFileId"/>
        <result column="template_pic_id" jdbcType="INTEGER" property="templatePicId"/>
        <result column="template_shape_value" jdbcType="INTEGER" property="templateShapeValue"/>
        <result column="cad_source_file_id" jdbcType="INTEGER" property="cadSourceFileId"/>
        <result column="template_describe" jdbcType="VARCHAR" property="templateDescribe"/>
        <result column="template_status" jdbcType="INTEGER" property="templateStatus"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="sys_code" jdbcType="VARCHAR" property="sysCode"/>
        <result column="creator" jdbcType="VARCHAR" property="creator"/>
        <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate"/>
        <result column="modifier" jdbcType="VARCHAR" property="modifier"/>
        <result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified"/>
        <result column="is_deleted" jdbcType="INTEGER" property="isDeleted"/>
        <result column="att1" jdbcType="VARCHAR" property="att1"/>
        <result column="att2" jdbcType="VARCHAR" property="att2"/>
        <result column="numa1" jdbcType="INTEGER" property="numa1"/>
        <result column="numa2" jdbcType="INTEGER" property="numa2"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="brand_name" jdbcType="VARCHAR" property="brandName"/>
        <result column="pic_path" jdbcType="VARCHAR" property="picPath"/>
        <result column="shapeName" jdbcType="VARCHAR" property="shapeName"/>
        <result column="file_name" jdbcType="VARCHAR" property="fileName"/>
        <result column="file_path" jdbcType="VARCHAR" property="filePath"/>
        <result column="cadFilePath" jdbcType="VARCHAR" property="cadFilePath"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,template_code,template_name,brand_id,template_length,template_width,template_file_id,template_pic_id,template_shape_value,cad_source_file_id,template_describe,template_status,user_id,sys_code,creator,gmt_create,modifier,gmt_modified,is_deleted,att1,att2,numa1,numa2,remark
    </sql>

    <insert id="insert" keyProperty="id" useGeneratedKeys="true" parameterType="com.sandu.api.basewaterjet.model.Basewaterjet">
        insert into base_waterjet_template
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="templateCode != null">
                template_code,
            </if>
            <if test="templateName != null">
                template_name,
            </if>
            <if test="brandId != null">
                brand_id,
            </if>
            <if test="templateLength != null">
                template_length,
            </if>
            <if test="templateWidth != null">
                template_width,
            </if>
            <if test="templateFileId != null">
                template_file_id,
            </if>
            <if test="templatePicId != null">
                template_pic_id,
            </if>
            <if test="templateShapeValue != null">
                template_shape_value,
            </if>
            <if test="cadSourceFileId != null">
                cad_source_file_id,
            </if>
            <if test="templateDescribe != null">
                template_describe,
            </if>
            <if test="templateStatus != null">
                template_status,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="sysCode != null">
                sys_code,
            </if>
            <if test="creator != null">
                creator,
            </if>
            <if test="gmtCreate != null">
                gmt_create,
            </if>
            <if test="modifier != null">
                modifier,
            </if>
            <if test="gmtModified != null">
                gmt_modified,
            </if>
            <if test="isDeleted != null">
                is_deleted,
            </if>
            <if test="att1 != null">
                att1,
            </if>
            <if test="att2 != null">
                att2,
            </if>
            <if test="numa1 != null">
                numa1,
            </if>
            <if test="numa2 != null">
                numa2,
            </if>
            <if test="remark != null">
                remark,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="templateCode != null">
                #{templateCode,jdbcType=VARCHAR},
            </if>
            <if test="templateName != null">
                #{templateName,jdbcType=VARCHAR},
            </if>
            <if test="brandId != null">
                #{brandId,jdbcType=INTEGER},
            </if>
            <if test="templateLength != null">
                #{templateLength,jdbcType=INTEGER},
            </if>
            <if test="templateWidth != null">
                #{templateWidth,jdbcType=INTEGER},
            </if>
            <if test="templateFileId != null">
                #{templateFileId,jdbcType=INTEGER},
            </if>
            <if test="templatePicId != null">
                #{templatePicId,jdbcType=INTEGER},
            </if>
            <if test="templateShapeValue != null">
                #{templateShapeValue,jdbcType=INTEGER},
            </if>
            <if test="cadSourceFileId != null">
                #{cadSourceFileId,jdbcType=INTEGER},
            </if>
            <if test="templateDescribe != null">
                #{templateDescribe,jdbcType=VARCHAR},
            </if>
            <if test="templateStatus != null">
                #{templateStatus,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=INTEGER},
            </if>
            <if test="sysCode != null">
                #{sysCode,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                #{isDeleted,jdbcType=INTEGER},
            </if>
            <if test="att1 != null">
                #{att1,jdbcType=VARCHAR},
            </if>
            <if test="att2 != null">
                #{att2,jdbcType=VARCHAR},
            </if>
            <if test="numa1 != null">
                #{numa1,jdbcType=INTEGER},
            </if>
            <if test="numa2 != null">
                #{numa2,jdbcType=INTEGER},
            </if>
            <if test="remark != null">
                #{remark,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>

    <update id="updateByPrimaryKey" parameterType="com.sandu.api.basewaterjet.model.Basewaterjet">
        update base_waterjet_template
        <set>
            <if test="id != null">
                id = #{id,jdbcType=INTEGER},
            </if>
            <if test="templateCode != null">
                template_code = #{templateCode,jdbcType=VARCHAR},
            </if>
            <if test="templateName != null">
                template_name = #{templateName,jdbcType=VARCHAR},
            </if>
            <if test="type == 'add'">
                <if test="brandId != null">
                    brand_id = #{brandId,jdbcType=INTEGER},
                </if>
                <if test="templateLength != null">
                    template_length = #{templateLength,jdbcType=INTEGER},
                </if>
                <if test="templateWidth != null">
                    template_width = #{templateWidth,jdbcType=INTEGER},
                </if>
                <if test="templateShapeValue != null">
                    template_shape_value = #{templateShapeValue,jdbcType=INTEGER},
                </if>
            </if>
            <if test="type == 'edit'">
                brand_id = #{brandId,jdbcType=INTEGER},
                template_length = #{templateLength,jdbcType=INTEGER},
                template_width = #{templateWidth,jdbcType=INTEGER},
                template_shape_value = #{templateShapeValue,jdbcType=INTEGER},
            </if>
            <if test="templateFileId != null">
                template_file_id = #{templateFileId,jdbcType=INTEGER},
            </if>
            <if test="templatePicId != null">
                template_pic_id = #{templatePicId,jdbcType=INTEGER},
            </if>
            <if test="cadSourceFileId != null">
                cad_source_file_id = #{cadSourceFileId,jdbcType=INTEGER},
            </if>
            <if test="templateDescribe != null">
                template_describe = #{templateDescribe,jdbcType=VARCHAR},
            </if>
            <if test="templateStatus != null">
                template_status = #{templateStatus,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                user_id = #{userId,jdbcType=INTEGER},
            </if>
            <if test="sysCode != null">
                sys_code = #{sysCode,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                modifier = #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=INTEGER},
            </if>
            <if test="att1 != null">
                att1 = #{att1,jdbcType=VARCHAR},
            </if>
            <if test="att2 != null">
                att2 = #{att2,jdbcType=VARCHAR},
            </if>
            <if test="numa1 != null">
                numa1 = #{numa1,jdbcType=INTEGER},
            </if>
            <if test="numa2 != null">
                numa2 = #{numa2,jdbcType=INTEGER},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="deleteByPrimaryKey">
        UPDATE
            base_waterjet_template
        SET
            is_deleted = 1,
            modifier = #{userName},
            gmt_modified = NOW()
        WHERE
            id IN
            <foreach separator="," open="(" close=")" collection="basewaterjetIds" item="basewaterjetId">
                #{basewaterjetId}
            </foreach>
    </update>

    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from base_waterjet_template
        where id = #{basewaterjetId,jdbcType=INTEGER}
    </select>

    <select id="selectInfoByPrimaryKey" resultMap="BaseResultMap">
        SELECT
            bwt.id,
            bwt.template_code,
            bwt.template_name,
            bwt.brand_id,
            bwt.template_length,
            bwt.template_width,
            bwt.template_file_id,
            bwt.template_pic_id,
            bwt.template_shape_value,
            bwt.cad_source_file_id,
            bwt.template_describe,
            bwt.template_status,
            bwt.is_deleted,
            bwt.remark,
            bb.brand_name,
            rp.pic_path,
            sd.name AS shapeName,
            concat(rf.file_name,rf.file_suffix) AS file_name,
            rf.file_path AS cadFilePath,
            rfd.file_path
        FROM
            base_waterjet_template bwt
            LEFT JOIN base_brand bb ON bwt.brand_id = bb.id AND bb.is_deleted = 0
            LEFT JOIN res_pic rp ON bwt.template_pic_id = rp.id AND rp.is_deleted = 0
            LEFT JOIN sys_dictionary sd ON bwt.template_shape_value = sd.value AND sd.type = 'templateShape'
            LEFT JOIN res_file rf on bwt.cad_source_file_id = rf.id
            LEFT JOIN res_file rfd on bwt.template_describe = rfd.id
        WHERE
            bwt.id = ${basewaterjetId}
    </select>

    <select id="findAll" resultMap="BaseResultMap" parameterType="com.sandu.api.basewaterjet.input.BasewaterjetQuery">
        SELECT
            bwt.id,
            bwt.template_code,
            bwt.template_name,
            bwt.brand_id,
            bwt.template_length,
            bwt.template_width,
            bwt.template_file_id,
            bwt.template_pic_id,
            bwt.template_shape_value,
            bwt.cad_source_file_id,
            bwt.template_describe,
            bwt.template_status,
            bwt.is_deleted,
            bwt.remark,
            bb.brand_name,
            rp.pic_path,
            sd.name AS shapeName,
            rf.file_name
        FROM
            base_waterjet_template bwt
            LEFT JOIN base_brand bb ON bwt.brand_id = bb.id AND bb.is_deleted = 0
            LEFT JOIN res_pic rp ON bwt.template_pic_id = rp.id AND rp.is_deleted = 0
            LEFT JOIN sys_dictionary sd ON bwt.template_shape_value = sd.value AND sd.type = 'templateShape'
            LEFT JOIN res_file rf on bwt.cad_source_file_id = rf.id
        WHERE
            bwt.is_deleted = 0
            AND (bwt.user_id is NULL OR bwt.user_id = '')
            <if test="templateCode != null">
                AND bwt.template_code LIKE CONCAT(#{templateCode,jdbcType=VARCHAR},'%')
            </if>
            <if test="templateName != null">
                AND bwt.template_name LIKE CONCAT(#{templateName,jdbcType=VARCHAR},'%')
            </if>
            <if test="brandIdList != null and brandIdList.size() > 0">
                AND bwt.brand_id IN
                <foreach collection="brandIdList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="templateStatus != null">
                AND bwt.template_status = #{templateStatus,jdbcType=INTEGER}
            </if>
            <if test="templateShapeValue != null">
                AND bwt.template_shape_value = #{templateShapeValue,jdbcType=INTEGER}
            </if>
        ORDER BY
            bwt.gmt_modified DESC
        <if test="page != null and limit != null">
            limit ${page},${limit}
        </if>
    </select>
    <select id="findAllCount" resultType="java.lang.Integer" parameterType="com.sandu.api.basewaterjet.input.BasewaterjetQuery">
        SELECT
            count(1)
        FROM
            base_waterjet_template bwt
            LEFT JOIN base_brand bb ON bwt.brand_id = bb.id AND bb.is_deleted = 0
            LEFT JOIN res_pic rp ON bwt.template_pic_id = rp.id AND rp.is_deleted = 0
            LEFT JOIN sys_dictionary sd ON bwt.template_shape_value = sd.value AND sd.type = 'templateShape'
            LEFT JOIN res_file rf on bwt.cad_source_file_id = rf.id
        WHERE
            bwt.is_deleted = 0
            AND (bwt.user_id is NULL OR bwt.user_id = '')
            <if test="templateCode != null">
                AND bwt.template_code LIKE CONCAT(#{templateCode,jdbcType=VARCHAR},'%')
            </if>
            <if test="templateName != null">
                AND bwt.template_name LIKE CONCAT(#{templateName,jdbcType=VARCHAR},'%')
            </if>
            <if test="brandIdList != null and brandIdList.size() > 0">
                AND bwt.brand_id IN
                <foreach collection="brandIdList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="templateStatus != null">
                AND bwt.template_status = #{templateStatus,jdbcType=INTEGER}
            </if>
            <if test="templateShapeValue != null">
                AND bwt.template_shape_value = #{templateShapeValue,jdbcType=INTEGER}
            </if>
    </select>

    <select id="selectBrandNameList" resultType="com.sandu.api.basewaterjet.output.BrandNameVO">
        <choose>
            <when test="userType == 3">
                <![CDATA[
                SELECT
                    bb.id,
                    bb.brand_name AS brandName
                FROM
                    base_brand bb
                    INNER JOIN
                        (
                            SELECT
                                substring_index( substring_index( bc.brand_id, ',', ht.help_topic_id + 1 ), ',', - 1 ) AS id
                            FROM
                                base_company bc
                                JOIN mysql.help_topic ht ON ht.help_topic_id < ( LENGTH( bc.brand_id ) - LENGTH( REPLACE ( bc.brand_id, ',', '' ) ) + 1 )
                                JOIN sys_user su on bc.id = su.business_administration_id
                            WHERE su.id = #{userId}
                        ) bh ON bb.id = bh.id
                WHERE
                    bb.is_deleted = 0
                ]]>
            </when>
            <otherwise>
                SELECT
                    bb.id,
                    bb.brand_name AS brandName
                FROM
                    base_brand bb
                    LEFT JOIN base_company bc ON bb.company_id = bc.id AND bc.is_deleted = 0
                    LEFT JOIN sys_user su ON su.business_administration_id = bc.id
                WHERE
                    bb.is_deleted = 0
                    AND su.id = #{userId}
            </otherwise>
        </choose>
    </select>

    <update id="upperandlowerstatus">
        UPDATE
            base_waterjet_template
        SET
            template_status = #{templateStatus},
            modifier = #{userName},
            gmt_modified = NOW()
        WHERE
            id IN
            <foreach separator="," open="(" close=")" collection="basewaterjetIds" item="basewaterjetId">
                #{basewaterjetId}
            </foreach>
    </update>

    <select id="selectMaxId" resultType="java.lang.String">
        SELECT MAX(id) FROM base_waterjet_template;
    </select>
</mapper>