<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sandu.service.product.dao.ProductPropDao">
    <!--<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>-->
    <!-- **插入定义** -->
    <insert id="saveProductProp" parameterType="com.sandu.api.product.model.ProductProp" useGeneratedKeys="true"
            keyProperty="id">
        insert into product_props
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="code!= null">code,</if>
            <if test="longCode!= null">long_code,</if>
            <if test="name!= null">name,</if>
            <if test="propValue!= null">prop_value,</if>
            <if test="picPath!= null">pic_path,</if>
            <if test="pid!= null">pid,</if>
            <if test="type!= null">type,</if>
            <if test="isLeaf!= null">is_leaf,</if>
            <if test="level!= null">level,</if>
            <if test="ordering!= null">ordering,</if>
            <if test="sysCode!= null">sys_code,</if>
            <if test="creator!= null">creator,</if>
            <if test="gmtCreate!= null">gmt_create,</if>
            <if test="modifier!= null">modifier,</if>
            <if test="gmtModified!= null">gmt_modified,</if>
            <if test="isDeleted!= null">is_deleted,</if>
            <if test="filterOrder!= null">filter_order,</if>
            <if test="sequenceNumber!= null">sequence_number,</if>
            <if test="longNumbers!= null">long_numbers,</if>
            <if test="att1!= null">att1,</if>
            <if test="att2!= null">att2,</if>
            <if test="numa1!= null">numa1,</if>
            <if test="numa2!= null">numa2,</if>
            <if test="remark!= null">remark</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="code!= null">#{code,jdbcType=VARCHAR},</if>
            <if test="longCode!= null">#{longCode,jdbcType=VARCHAR},</if>
            <if test="name!= null">#{name,jdbcType=VARCHAR},</if>
            <if test="propValue!= null">#{propValue,jdbcType=VARCHAR},</if>
            <if test="picPath!= null">#{picPath,jdbcType=INTEGER},</if>
            <if test="pid!= null">#{pid,jdbcType=INTEGER},</if>
            <if test="type!= null">#{type,jdbcType=INTEGER},</if>
            <if test="isLeaf!= null">#{isLeaf,jdbcType=INTEGER},</if>
            <if test="level!= null">#{level,jdbcType=INTEGER},</if>
            <if test="ordering!= null">#{ordering,jdbcType=INTEGER},</if>
            <if test="sysCode!= null">#{sysCode,jdbcType=VARCHAR},</if>
            <if test="creator!= null">#{creator,jdbcType=VARCHAR},</if>
            <if test="gmtCreate!= null">#{gmtCreate,jdbcType=TIMESTAMP},</if>
            <if test="modifier!= null">#{modifier,jdbcType=VARCHAR},</if>
            <if test="gmtModified!= null">#{gmtModified,jdbcType=TIMESTAMP},</if>
            <if test="isDeleted!= null">#{isDeleted,jdbcType=INTEGER},</if>
            <if test="filterOrder!= null">#{filterOrder,jdbcType=VARCHAR},</if>
            <if test="sequenceNumber!= null">#{sequenceNumber,jdbcType=INTEGER},</if>
            <if test="longNumbers!= null">#{longNumbers,jdbcType=VARCHAR},</if>
            <if test="att1!= null">#{att1,jdbcType=VARCHAR},</if>
            <if test="att2!= null">#{att2,jdbcType=VARCHAR},</if>
            <if test="numa1!= null">#{numa1,jdbcType=INTEGER},</if>
            <if test="numa2!= null">#{numa2,jdbcType=INTEGER},</if>
            <if test="remark!= null">#{remark,jdbcType=VARCHAR}</if>
        </trim>
    </insert>

    <!-- **更新定义** -->
    <update id="updateProductProp" parameterType="com.sandu.api.product.model.ProductProp">
        update product_props
        <set>
            <if test="code != null">
                code = #{code,jdbcType=VARCHAR},
            </if>
            <if test="longCode != null">
                long_code = #{longCode,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                name = #{name,jdbcType=VARCHAR},
            </if>
            <if test="propValue != null">
                prop_value = #{propValue,jdbcType=VARCHAR},
            </if>
            <if test="picPath != null">
                pic_path = #{picPath,jdbcType=INTEGER},
            </if>
            <if test="pid != null">
                pid = #{pid,jdbcType=INTEGER},
            </if>
            <if test="type != null">
                type = #{type,jdbcType=INTEGER},
            </if>
            <if test="level != null">
                level = #{level,jdbcType=INTEGER},
            </if>
            <if test="isLeaf != null">
                is_leaf = #{isLeaf,jdbcType=INTEGER},
            </if>
            <if test="ordering != null">
                ordering = #{ordering,jdbcType=INTEGER},
            </if>
            <if test="sysCode != null">
                sys_code = #{sysCode,jdbcType=VARCHAR},
            </if>
            <if test="creator != null">
                creator = #{creator,jdbcType=VARCHAR},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate,jdbcType=TIMESTAMP},
            </if>
            <if test="modifier != null">
                modifier = #{modifier,jdbcType=VARCHAR},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified,jdbcType=TIMESTAMP},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=INTEGER},
            </if>
            <if test="att1 != null">
                att1 = #{att1,jdbcType=VARCHAR},
            </if>
            <if test="att2 != null">
                att2 = #{att2,jdbcType=VARCHAR},
            </if>
            <if test="numa1 != null">
                numa1 = #{numa1,jdbcType=INTEGER},
            </if>
            <if test="numa2 != null">
                numa2 = #{numa2,jdbcType=INTEGER},
            </if>
            <if test="remark != null">
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="filterOrder != null">
                filter_order = #{filterOrder,jdbcType=VARCHAR},
            </if>
            <if test="sequenceNumber != null">
                sequence_number = #{sequenceNumber,jdbcType=INTEGER},
            </if>
            <if test="longNumbers != null">
                long_numbers = #{longNumbers,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>


    <!-- **删除定义** -->
    <delete id="deleteProductPropById">
		delete from product_props
		where id = #{id,jdbcType=INTEGER}
	</delete>

    <!-- **常量定义** -->
    <sql id="All_Column_List">
		id,code,long_code,name,prop_value,pic_path,pid,type,is_leaf,level,ordering,sys_code,creator,gmt_create,modifier,gmt_modified,is_deleted,filter_order,sequence_number,long_numbers,att1,att2,numa1,numa2,remark
	</sql>

    <!-- **结果定义** -->
    <resultMap id="AllResultMap" type="com.sandu.api.product.model.ProductProp">
        <id column="id" jdbcType="BIGINT" property="id"/>
        <result column="code" jdbcType="VARCHAR" property="code"/>
        <result column="long_code" jdbcType="VARCHAR" property="longCode"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="prop_value" jdbcType="VARCHAR" property="propValue"/>
        <result column="pic_path" jdbcType="INTEGER" property="picPath"/>
        <result column="pid" jdbcType="INTEGER" property="pid"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="level" jdbcType="INTEGER" property="level"/>
        <result column="is_leaf" jdbcType="INTEGER" property="isLeaf"/>
        <result column="ordering" jdbcType="INTEGER" property="ordering"/>
        <result column="sys_code" jdbcType="VARCHAR" property="sysCode"/>
        <result column="creator" jdbcType="VARCHAR" property="creator"/>
        <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate"/>
        <result column="modifier" jdbcType="VARCHAR" property="modifier"/>
        <result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified"/>
        <result column="is_deleted" jdbcType="INTEGER" property="isDeleted"/>
        <result column="att1" jdbcType="VARCHAR" property="att1"/>
        <result column="att2" jdbcType="VARCHAR" property="att2"/>
        <result column="numa1" jdbcType="INTEGER" property="numa1"/>
        <result column="numa2" jdbcType="INTEGER" property="numa2"/>
        <result column="remark" jdbcType="VARCHAR" property="remark"/>
        <result column="filter_order" jdbcType="VARCHAR" property="filterOrder"/>
        <result column="sequence_number" jdbcType="INTEGER" property="sequenceNumber"/>
        <result column="long_numbers" jdbcType="VARCHAR" property="longNumbers"/>
    </resultMap>

    <!-- **查询定义** -->
    <!-- 按主键查询 -->
    <select id="getProductPropInfoById" resultMap="AllResultMap">
        select
        <include refid="All_Column_List"/>
        from product_props
        where id = #{id,jdbcType=INTEGER}
    </select>
    <!-- 根据pid查询子节点 -->
    <select id="getProductPropByPid" resultMap="AllResultMap">
		select pp.id,pp.pid,pp.name,pp.is_leaf from product_props pp
		where pp.pid = #{pid,jdbcType=INTEGER}
	</select>

    <!-- 根据产品查询属性 -->
    <select id="getProductPropByProductId" resultMap="AllResultMap">
		SELECT
			pp.id , pp.long_code, pp.name,pp.level, pp.is_leaf
		FROM
			product_props pp
		left JOIN product_attribute pa ON pa.attribute_id = pp.id
		WHERE
			pa.product_id = #{productId}
	</select>
    <!---->
    <!-- 其他Map等查询方式 -->
    <select id="getProductPropByLongCode" resultMap="AllResultMap">
        select
        pp.id , pp.code,pp.pid, pp.long_code, pp.name,pp.level, pp.is_leaf
        FROM
        product_props pp
        where is_deleted = 0
        <if test="longCode!= null and longCode != '' ">
            and long_code like CONCAT(CONCAT('%.',#{longCode,jdbcType=VARCHAR}),'.%')
        </if>
    </select>
    <select id="getParentAndItselfByIds" resultType="com.sandu.api.product.model.ProductProp">
        SELECT
        pc.id,
        pc.code,
        pc.name,
        pc.pid,
        pc.level
        FROM product_props pc, product_props pp
        WHERE pc.pid = pp.id  and pc.id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        UNION
        SELECT
        pp.id,
        pp.code,
        pp.name,
        pp.pid,
        pp.level
        FROM product_props pc, product_props pp
        WHERE pc.pid = pp.id and pc.id IN
        <foreach collection="list" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>
    <select id="getAllParentByCodes" resultType="com.sandu.api.product.model.ProductProp">
        select id,pid,name,long_code,code from product_props where
        find_in_set(code, ( select group_concat(replace(long_code,'.',',')) from product_props
        where is_deleted = 0 and code in
        <foreach collection="list" item="code" open="(" close=")" separator=",">
            #{code}
        </foreach>
        )) group by id;
    </select>
</mapper>
